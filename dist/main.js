!function(e){var t={};function r(s){if(t[s])return t[s].exports;var i=t[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(s,i,function(t){return e[t]}.bind(null,i));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";r.r(t);var s=function(e){return Array.isArray(e)},i=function(e){return"function"==typeof e},n=function(e){return i(e)||e&&"[object function]"==={}.toString.call(e)},a=function(e){return!Array.isArray(e)&&"object"==typeof e&&e},o=function(e){return Array.isArray(e)||"object"==typeof e&&e||i(e)},h=function(e){return e instanceof Number||"number"==typeof e},c=function(e){return h(e)||!0!==e&&!1!==e&&null!==e&&""!==e&&!isNaN(1*e)},l=function(e,...t){return t.forEach(t=>{e.indexOf(t)<0&&e.push(t)}),e},u=function(e,t){var r=[];return function(e,t){t=(t=t||Object.prototype)&&!s(t)?[t]:t;var r=[];for(e=e;e&&(!t||t.indexOf(e)<0)&&"default"!==e.name;)r.push(e),e=e?Object.getPrototypeOf(e):null;return r}(e,t).forEach(e=>{l(r,...Object.getOwnPropertyNames(e))}),r};function p(e,t,r=!1,i=!1,h=!1){var l=0,f=e.shift();if((c(f)||!0===f||!1===f)&&(l=f,f=e.shift()),!e.length)throw new Error("_merge() requires two or more array/objects.");return e.forEach((e,m)=>{(o(e)||n(e))&&(r?u(e):Object.getOwnPropertyNames(e)).forEach(n=>{if(t(n,f,e,m)){var o=f[n],u=e[n];if((s(o)&&s(u)||a(o)&&a(u))&&(!0===l||l>0))f[n]=s(o)&&s(u)?[]:{},p([c(l)?l-1:l,f[n],o,u],t,r,i,h);else if(s(f)&&s(e))i?f[n]=u:f.push(u);else try{h?Object.defineProperty(f,n,Object.getOwnPropertyDescriptor(e,n)):f[n]=e[n]}catch(e){}}})}),f}var f=function(...e){return p(e,(e,t,r)=>!0,!1,!1,!1)},m=function(e){return null===e||""===e},g=function(e){return arguments.length&&(void 0===e||void 0===e)},d=function(e){return m(e)||g(e)||!1===e||0===e||o(e)&&!Object.keys(e).length},E=function(e,t,r=!1){for(var s=e.indexOf(t);s>-1&&(r||!1===r);)e.splice(s,1),r>0&&r--,s=e.indexOf(t);return e},y=function(e,t){if(!e)return!1;if(e instanceof t)return!0;var r=e=>{for(;e&&e!==Function.prototype;){if(e===t||e.prototypes&&e.prototypes.reduce((e,s)=>e||s===t||r(s),!1))return!0;e=Object.getPrototypeOf(e)}return!1};return r(e.constructor)},v=function(e){return a(e)&&Object.getPrototypeOf(e)===Object.prototype},S=function(e){return!0===e||!1===e},T=function(e,t){var r=void 0;return o(e)&&Object.keys(e).forEach((s,i)=>{!1!==r&&(r=t(c(s)?parseFloat(s):s,e[s],i))}),r};const w=function(e,t,r=!0,i=1){if(s(e)&&s(t)&&e.length!==t.length)return!r;if(a(e)&&a(t)){var c=Object.keys(e),l=Object.keys(t);if(!c.length&&!l.length)return v(e)&&v(t)?r:e===t===r;if(!w(c,l))return!r}if(i>0&&(s(e)&&s(t)||a(e)&&a(t))){var u=function(e,t,r=!0,i=!0,n=!1,h=!1){if(s(e)&&s(t)){var c=[],l=!0;return e.forEach(e=>{if(l){var u=!1;T(t,(t,n)=>{(!u||i&&o(e))&&(u=r(e,n),(s(u)&&!u.length||a(u)&&!Object.keys(u).length)&&(u=!1),o(u)&&i&&(e=u))}),o(u)?c.push(i?u:e):S(u)?n&&!u||!n&&u?c.push(e):h&&(l=!1):c.push(u)}}),c}if(a(e)&&a(t)){c={},l=!0;return Object.keys(e).forEach(u=>{if(l){var p=r(e[u],t[u]);(s(p)&&!p.length||a(p)&&!Object.keys(p).length)&&(p=!1),o(p)?c[u]=i?p:e[u]:S(p)?n&&!p||!n&&p?c[u]=e[u]:h&&(l=!1):c[u]=p}}),c}}(e,t,(e,t)=>w(e,t,r,i-1),!1,!1,!0);return s(u)?u.length===e.length&&u.length===t.length:a(u)&&a(e)?Object.keys(u).length===Object.keys(e).length&&Object.keys(u).length===Object.keys(t).length:u}return n(r)?r(e,t):h(e)&&h(t)&&isNaN(e)&&isNaN(t)?r:e===t===r};var O=w,A=class{even(e){return!(!a(e)||e.jsenType!==this.jsenType)&&O(e,this)}inherit(e){return this}withComments(e){return this.meta||(this.meta={}),this.meta.comments=e,this}withVars(e){return this.meta||(this.meta={}),this.meta.vars=e,this}};const C=class extends A{};Object.defineProperty(C.prototype,"jsenType",{get:()=>"Reference"});var x=C;const R=class extends A{};Object.defineProperty(R.prototype,"jsenType",{get:()=>"CallExpression"});var _=R,I=class extends A{};const L=class extends A{};Object.defineProperty(L.prototype,"jsenType",{get:()=>"IfConstruct"});var b=L,N=class extends Error{constructor(...e){super(...e),this.name="Syntax Error"}};const U={};class j{static parse(e,t,r={}){if(e.length){var s;if(U[e]&&!t&&!1!==r.allowCache)if(s=this.parseOne(e,U[e],r))return s;for(var i=Object.values(t||this.grammars),n=0;n<i.length;n++){var a=this.parseOne(e,i[n],r);if(a)return t||!1===r.allowCache||(U[e]=i[n]),a}if(!1===r.assert)return;throw new N(e)}}static parseOne(e,t,r={}){var i=[],n=[],a=[],o=[],h=t.parse(e,(e,t,s={})=>{var h=this.parse(e,t,s?f({},r,s):r);return(y(h,x)||y(h,_))&&(!1!==s.lodge?i.push(h):a.push(h)),h&&(!1!==s.lodge?(h.meta.vars.forEach(e=>i.push(e)),h.meta.deepVars.forEach(e=>n.push(e))):(h.meta.varsUnlodged.forEach(e=>a.push(e)),h.meta.deepVarsUnlodged.forEach(e=>o.push(e)))),h},r);return h&&(h.meta||(h.meta={}),h.meta.vars=i,h.meta.deepVars=n,h.meta.varsUnlodged=a,h.meta.deepVarsUnlodged=o,y(h,_)?h.reference.context&&h.meta.vars.push(h.reference.context):y(h,I)?(h.meta.vars.splice(0),h.meta.deepVars.splice(0),h.meta.varsUnlodged.splice(0),h.meta.deepVarsUnlodged.splice(0)):y(h,b)&&(h.onTrue&&(h.onTrue.meta.vars.concat(h.onTrue.meta.deepVars).forEach(e=>{E(h.meta.vars,e),h.meta.deepVars.push(e)}),h.onTrue.meta.varsUnlodged.concat(h.onTrue.meta.deepVarsUnlodged).forEach(e=>{E(h.meta.varsUnlodged,e),h.meta.deepVarsUnlodged.push(e)})),h.onFalse&&(h.onFalse.meta.vars.concat(h.onFalse.meta.deepVars).forEach(e=>{E(h.meta.vars,e),h.meta.deepVars.push(e)}),h.onFalse.meta.varsUnlodged.concat(h.onFalse.meta.deepVarsUnlodged).forEach(e=>{E(h.meta.varsUnlodged,e),h.meta.deepVarsUnlodged.push(e)}))),s(r.explain)&&r.explain.push(e+" >>-------------\x3e> "+h.jsenType)),h}}var P=function(e){return e instanceof String||"string"==typeof e&&null!==e},k=function(e,t,r=!1){if(""==t)return e;var s=r?e.lastIndexOf(t):e.indexOf(t);return-1===s?"":e.substr(s+t.length)},D=function(e,t,r=!1){if(""==t)return e;var s=r?e.lastIndexOf(t):e.indexOf(t);return-1===s?e:e.substr(0,s)},W=function(e){return e.filter((e,t,r)=>r.indexOf(e)===t)},F=class extends Error{constructor(...e){super(...e),this.name="Reference Error"}};class B{constructor(e,t={}){if(this.stack=e,this.params=t,!("main"in this.stack))throw new Error('A "main" context must be provided!');this.stack.super&&(this.stack.super=B.create(this.stack.super,{errorLevel:t.errorLevel})),this.stack.local=this.stack.local||{},this.stack.$local=this.stack.$local||{}}observe(e,t){this.stack.super&&this.stack.super.observe(e,r=>{if(r.props.filter(t=>!H(this.stack.local,t,e)&&!H(this.stack.main,t,e)).length)return r.scope="super",t(r)}),e.observe(this.stack,r=>{var s=(r=r.filter(e=>"main"===e.name)).map(e=>k(e.path,".")).filter(e=>e),i=s.map(e=>D(e,"."));if(!s.length&&r.length&&r[0].value&&(s=i=W((o(r[0].value)?Object.keys(r[0].value):[]).concat(r[0].oldValue&&o(r[0].oldValue)?Object.keys(r[0].oldValue):[]))),i.filter(t=>!H(this.stack.local,t,e)).length)return t({props:i,references:s,scope:"local"})},{subtree:!0,tags:[this,"jsen-context"]})}unobserve(e,t){this.stack.super&&this.stack.super.unobserve(e,t),e.unobserve(this.stack,t,{subtree:!0,tags:[this,"jsen-context"]})}handle(e,t,r,s=0){var i=()=>t(this.stack.main,null,()=>this.stack.super?this.stack.super.handle(e,t,r,s+1):r?r():void 0,s);return"toString"===e&&this.stack.local.toString===Object.prototype.toString?i():t(this.stack.local,this.stack.$local,i,s)}get(e,t={},r=!0){return e instanceof String&&(e+=""),this.handle(e,(s,a,o,h)=>{var c=M(s,e,t);return!g(c)||H(s,e,t)?n(c)&&!function(e){return i(e)&&/^class\s?/.test(Function.prototype.toString.call(e))}(c)&&r?c.bind(s):c:o()})}set(e,t,r={},s=!1){if(2===this.params.type&&"var"===s&&this.stack.super)return this.stack.super.set(e,t,r,s);e instanceof String&&(e+="");const i=(e,t,r,s)=>s.set?s.set(e,t,r):(e[t]=r,!0);return this.handle(!!s||e,(n,a,o)=>{if(a&&"const"===a[e])throw new LogicalError("CONST "+e+" cannot be modified!");return s?(a[e]=s,i(n,e,t,r)):H(n,e,r)?i(n,e,t,r):o()},()=>{throw new F('"'+e+'" is undefined!')})}del(e,t={}){return e instanceof String&&(e+=""),this.handle(e,(r,s,i)=>H(r,e,t)?(s&&delete s[e],t.deleteProperty||t.del?(t.deleteProperty||t.del)(r,e):(delete r[e],!0)):i())}has(e,t,r={}){return e instanceof String&&(e+=""),t instanceof String&&(t+=""),this.handle(e,(s,i,n)=>{if(H(s,e,r)){var a=M(s,e,r);return H(a,t,r)}return n()},()=>{throw new F('"'+e+'" is undefined!')})}exec(e,t,r={}){return e instanceof String&&(e+=""),this.handle(e,(s,i,a)=>{var o=M(s,e,r);if(!g(o)||H(s,e,r)){if(!n(o)){if(r.exec)return r.exec(s,e,t);throw new F('"'+e+'" is not a function! (Called on type: '+typeof s+".)")}return r.apply?r.apply(o,s,t):o.apply(s,t)}return a()},()=>{if(r.execUnknown)return r.execUnknown(this,e,t);throw new F('"'+e+'()" is undefined!')})}static create(e,t={}){return e instanceof B?e:new B({main:e},t)}}const M=(e,t,r)=>{if(!m(e)&&!g(e))return r.get&&o(e)?r.get(e,t):e[t]},H=(e,t,r)=>!m(e)&&!g(e)&&(r.has&&o(e)?r.has(e,t):o(e)?t in e:!g(e[t]));var G=function(e,t,r){return e.startsWith(t)&&e.endsWith(r)},Y=function(e,t){return D(e,t,!0)},K=function(e,t,r){return Y(k(e,t),r)},$=function(e,t=!0){return s(e)?e:!t&&a(e)?[e]:!1!==e&&0!==e&&d(e)?[]:function(e){return!P(e)&&!g(e.length)}(e)?Array.prototype.slice.call(e):a(e)?Object.values(e):[e]};const q=function(e,t=1,r=!0){return!c(t)||t<=0?e:(!s(e)&&a(e)&&r&&(e=Object.values(e)),s(e)?e.reduce((e,i)=>s(i)||a(i)&&r?e.concat(q(s(i)?i:Object.values(i),t-1,r)):e.concat(i),[]):e)};var V=q,Q=function(e,t=1){var r=0;e.forEach(e=>{r++});var s=e.slice(e.length-r,t);return arguments.length>1?s:s[0]},J=function(e,t=1){return arguments.length>1?Q(e.slice().reverse(),t).reverse():Q(e.slice().reverse())},X=function(e,t=[]){return p([{},e],(e,r,i)=>{if(!n(i[e]))return n(t)?t(e):!s(t)||!t.length||t.indexOf(e)>-1},!1,!1,!1)};class z{static lex(e,t,r={}){if(!P(e+=""))throw new Error("Argument1 must be a string!");var s=e=>({delims:e.delims.slice(),options:X(e.options),nesting:e.nesting.slice(),maxDepth:e.maxDepth,comments:e.comments.slice(),tokens:e.tokens.slice(),matches:e.matches.slice(),matchesi:X(e.matchesi)});if(z.$cache[e]&&!1!==r.cache)for(var i=0;i<z.$cache[e].length;i++){var n=z.$cache[e][i];if(O(n.delims,t))return s(n)}var a=new z(e,r).lex(t);return!1!==r.cache&&(z.$cache[e]=z.$cache[e]||[],z.$cache[e].push(a)),s(a)}static split(e,t,r){return z.lex(e,t,r).tokens}static match(e,t,r){return z.lex(e,t,r).matches}constructor(e,t){if(!P(e))throw new Error("Lexer requires the first argument to be a string.");this.$str=e,this.$options=t||{},this.$options.blocks||(this.$options.blocks=z.$blocks),this.$options.quotes||(this.$options.quotes=z.$quotes),this.$options.comments||(this.$options.comments=z.$comments)}lex(e,t){for(var r={delims:$(e),options:f(!0,{},this.$options,t||{}),nesting:[],maxDepth:0,comments:[],tokens:[],matches:[],matchesi:{}},s=0;"number"==typeof s;)s=this._evalCharsAt(r,s);if(r.nesting.length)throw new Error("Error parsing the string: "+this.$str+". Unterminated blocks: "+V(r.nesting).join(", "));return r}_evalCharsAt(e,t){if(!(t>=this.$str.length)){var r=1,s={},i={},n={};if(e.openComment||(i=this._testQuotes(e,t)),e.openQuote||(s=this._testComments(e,t)),e.openComment||s.ending)if(e.nesting.length||n.ending)this._push(e,this.$str[t]);else r=(o=s.starting||s.ending||this.$str[t]).length,this._push(e,o,"comments",s.starting);else if(e.openQuote||i.ending)this._push(e,this.$str[t]);else{if(e.options.limit&&e.matches.length===e.options.limit)return this._push(e,this.$str[t]),t+1;n=this._testNesting(e,t);n=this._testNesting(e,t);var a=this._testChars(e.options.stopChars||[],e,t);if(!e.nesting.length&&!1!==a)return e.options.stopChar=a,void(e.options.stopCharForward=this.$str.substr(t));if(e.delims.length)if(e.nesting.length||n.ending){var o;r=(o=n.starting||n.ending||this.$str[t]).length,this._push(e,o)}else{this._push(e,"");var h=this._testChars(e.delims,e,t);if(!1!==h&&(e.matches.push(h),e.matchesi[t]=h,r=h.length||1,!e.options.preserveDelims)){var c=t+(h.length||1);return c===this.$str.length&&this._push(e,""),c}this._push(e,h||this.$str[t])}else 2===e.nesting.length&&n.starting?(e.matches.push(null),this._push(e,n.starting),r=n.starting.length):!e.nesting.length&&n.ending?(this._push(e,n.ending),r=n.ending.length,e.matches.push(null)):this._push(e,this.$str[t])}return t+r}}_testQuotes(e,t){var r={};return(e.options.quotes||[]).forEach(s=>{this.$str.substr(t,1)===s&&(e.openQuote?s===e.openQuote&&(e.openQuote=!1,r.ending=s):(e.openQuote=s,r.starting=s))}),r}_testComments(e,t){var r={};return(e.options.comments||[]).forEach(s=>{if(e.openComment){if(J(s)===J(e.openComment)){var i=J(s);this.$str.substr(t).startsWith(i)&&(e.openComment=!1,r.ending=i)}}else{var n=Q(s);this.$str.substr(t).startsWith(n)&&(e.openComment=s,r.starting=n)}}),r}_testNesting(e,t){var r={};return(e.options.blocks||[]).forEach(s=>{var i=Q(s);if(this.$str.substr(t).startsWith(i))e.nesting=e.nesting.concat([s]),r.starting=i;else if(e.nesting.length&&J(s)===J(J(e.nesting))){var n=J(s);this.$str.substr(t).startsWith(n)&&(e.nesting=e.nesting.slice(0,-1),r.ending=n)}}),e.maxDepth=Math.max(e.maxDepth,e.nesting.length),r}_testChars(e,t,r){for(var s=0;s<e.length;s++){var i=e[s];if(n(i)){var a=i(this.$str.substr(0,r),this.$str.substr(r));if(!1!==a)return a}if(t.options.useRegex){var o=this.$str.substr(r).match(new RegExp("^"+i,!0!==t.options.useRegex?t.options.useRegex:""));if(o)return o[0]}if(!t.options.ci&&this.$str.substr(r,i.length)===i||t.options.ci&&this.$str.substr(r,i.length).toLowerCase()===i.toLowerCase())return i}return!1}_push(e,t,r="tokens",s=!1){var i=e.matches.length;if(g(e.tokens[i])&&(e.tokens[i]=""),"comments"===r){e.tokens[i].comments||(e.tokens[i]=new String(e.tokens[i]),e.tokens[i].comments=[]);var n=e.tokens[i].comments.length-(!e.tokens[i].comments.length||s?0:1);e.tokens[i].comments[n]=(e.tokens[i].comments[n]||"")+t}else{e.tokens[i].comments;e.tokens[i]=e.tokens[i]+t}}split(e,t,r){return this.lex(t,r).tokens}match(e,t,r){return this.lex(t,r).matches}regParse(e,t){return this.lex(e,f({useRegex:!0},t||{}))}regSplit(e,t){return this.regParse(e,t).tokens}regMatch(e,t){return this.regParse(e,t).matches}}z.$blocks=[["(",")"],["[","]"],["{","}"]],z.$quotes=['"',"'","`"],z.$comments=[["/*","*/"],["//","\n"]],z.$cache={};const Z=class extends A{};Object.defineProperty(Z.prototype,"jsenType",{get:()=>"Abstraction"});var ee=Z;var te=class extends ee{constructor(e){super(),this.expr=e}eval(e=null,t={}){return this.expr.eval(e,t)}toString(){return this.stringify()}stringify(e={}){return"("+this.expr.stringify(e)+")"}static parse(e,t,r={}){if(G(e,"(",")")&&!z.match(e,[" "]).length)return new this(t(K(e,"(",")")))}};const re=class extends A{};Object.defineProperty(re.prototype,"jsenType",{get:()=>"ArrayType"});var se=re;var ie=class extends se{constructor(e){super(),this.exprs=e||[]}inherit(e){if(e instanceof se){var t=e.exprs.filter(e=>this.exprs.reduce((t,r)=>t&&!e.even(r),!0));this.exprs=t.concat(this.exprs)}return this}eval(e=null,t={}){return this.exprs.map(r=>r.eval(e,t))}toString(){return this.stringify()}stringify(e={}){return"["+this.exprs.map(t=>t.stringify(e)).join(", ")+"]"}static parse(e,t,r={}){if(G(e,"[","]")&&!z.match(e.trim(),[" "]).length)return new this(z.split(K(e,"[","]"),[","]).map(e=>e.trim()).filter(e=>e).map(e=>t(e)))}};const ne=class extends A{};Object.defineProperty(ne.prototype,"jsenType",{get:()=>"Arguments"});var ae=ne;var oe=class extends ae{constructor(e=[]){super(),this.list=e}eval(e=null,t={}){return this.list.map(r=>r.eval(e,t))}toString(){return this.stringify()}stringify(e={}){return"("+this.list.map(t=>t.stringify(e)).join(", ")+")"}static parse(e,t,r={}){if(e=e.trim(),G(e,"(",")")&&!z.match(e,[" "]).length)return new this(z.split(K(e,"(",")"),[","]).map(e=>t(e.trim())))}};const he=class extends A{};Object.defineProperty(he.prototype,"jsenType",{get:()=>"AssertionExpression"});var ce=he;const le=class extends ce{constructor(e,t){super(),this.exprs=e,this.logic=t}eval(e=null,t={}){var r=this.constructor;if(this.logic.toLowerCase()===r.negation.toLowerCase())return!Q(this.exprs).eval(e,t);V(r.operators);for(var s=(this.logic||"").trim().toUpperCase(),i=s===(r.operators.or||"").trim().toUpperCase(),n=s===(r.operators.nor||"").trim().toUpperCase(),a=s===(r.operators.and||"").trim().toUpperCase(),o=s===(r.operators.nand||"").trim().toUpperCase(),h=!0,c=0,l=0;l<this.exprs.length;l++){if(h=this.exprs[l].eval(e,t),a&&!h)return!1;if(o&&!h)return!0;if(i&&h)return h;c+=h?1:0}return i?h:a||o?a:n&&0===c}toString(){return this.stringify()}stringify(e={}){var t=this.constructor;return this.logic.toLowerCase()===t.negation.toLowerCase()?this.logic+Q(this.exprs).stringify(e):this.exprs.map(t=>t.stringify(e)).join(" "+this.logic+" ")}static parse(e,t,r={}){if(e.toUpperCase().startsWith(this.negation.toUpperCase()))return new this([t(e.substr(this.negation.length))],this.negation);var s=z.lex(e,V(this.operators));if(s.tokens.length>1){var i=W(s.matches);if(i.length>1)throw new Error('"AND" and "OR" logic cannot be asserted in the same expression: '+e+"!");return new this(s.tokens.map(e=>t(e.trim())),Q(i))}}};le.negation="!",le.operators={and:"&&",or:"||"};var ue=le;const pe=class extends A{};Object.defineProperty(pe.prototype,"jsenType",{get:()=>"AssignmentExpression"});var fe=pe;const me=class extends fe{constructor(e,t,r,s="=",i=!1){super(),this.initKeyword=e,this.reference=t,this.val=r,this.operator=s,this.postIncrDecr=i}eval(e=null,t={}){var r,i,n=this.reference.getEval(e,t);if(["++","--"].includes(this.operator)){if(i=this.reference.eval(e,t),!h(i))throw new Error(this.reference+" must be a number!");r="++"===this.operator?i+1:i-1}else if(["+=","-=","*=","/="].includes(this.operator)){var a=n.get(),o=this.val.eval(e,t);if(!("+="===this.operator||h(a)&&h(o)))throw new Error(this+" - operands must each be a number!");r="*="===this.operator?a*o:"/="===this.operator?a/o:"-="===this.operator?a-o:a+o}else r=this.val.eval(e,t);try{return n.set(r,this.initKeyword),t&&s(t.references)&&_pushUnique(t.references,this.reference.toString()),this.postIncrDecr?i:r}catch(e){throw e instanceof F?new F("["+this+"]: "+e.message):e}}toString(){return this.stringify()}stringify(e={}){return["++","--"].includes(this.operator)?this.postIncrDecr?this.reference.stringify(e)+this.operator:this.operator+this.reference.stringify(e):(this.initKeyword?this.initKeyword+" ":"")+[this.reference.stringify(e),this.operator,this.val.stringify(e)].join(" ")}static parse(e,t,r={}){var s=z.lex(e,this.operators.concat([ge]));if(s.matches.length){var i,n,a,o,h=s.matches[0].trim(),c=["++","--"].includes(h);if(c?(o=e.trim().endsWith("++")||e.trim().endsWith("--"),n=s.tokens[o?"shift":"pop"]().trim()):(n=s.tokens.shift().trim(),a=s.tokens.shift().trim()),["var","let","const"].includes(D(n," "))){if("="!==h)throw new N("Invalid declaration: "+e);i=D(n," "),n=k(n," ").trim()}if(!((n=t(n,null,{lodge:!1}))instanceof x)||!c&&!(a=t(a)))throw new N(e);return n.role="ASSIGNMENT_SPECIFIER",new this(i,n,a,h,o)}}};me.operators=["+=","-=","*=","/=","++","--"];const ge=(e,t)=>!(e.endsWith("=")||!t.startsWith("=")||t.startsWith("=>")||t.startsWith("==")||t.startsWith("==="))&&"=";var de=me,Ee=function(e,t=[],r=!0){var i=0;return c(arguments[0])&&o(arguments[1])&&(i=arguments[0],e=arguments[1],t=arguments[2]||[]),p([i,{},e],(e,r,i)=>n(t)?t(e):!s(t)||!t.length||t.indexOf(e)>-1,!1,!1,r)};const ye=class extends A{};Object.defineProperty(ye.prototype,"jsenType",{get:()=>"Block"});var ve=ye;const Se=class extends A{};Object.defineProperty(Se.prototype,"jsenType",{get:()=>"ReturnDirective"});var Te=Se;const we=class extends A{};Object.defineProperty(we.prototype,"jsenType",{get:()=>"DeleteExpression"});var Oe=we;class Ae extends ve{constructor(e,t){super(),this.stmts=e||[],this.delim=t}eval(e=null,t={}){t=t?Ee(t):{},e=B.create(e);for(var r=e=>W(e.map(e=>D(D(e.toString(),"["),"("))),s=(e,t,r)=>{try{return e.eval(t,r)}catch(e){r.catch&&r.catch(e)}},i=[],n=0;n<this.stmts.length;n++){var a=this.stmts[n],o=r(a.meta.vars),h=r(a.meta.deepVars||[]),c=(t.references||[]).filter(e=>o.filter(t=>(t+".").startsWith(e+".")).length),l=(t.references||[]).filter(e=>h.filter(t=>(t+".").startsWith(e+".")).length);if(!t.references||!t.references.length||(c=c.length)||(l=l.length)){var u=t;if(c&&delete(u=Ee(t)).references,a instanceof Te)return s(a,e,u);i[n]=s(a,e,u),t.references&&(a instanceof fe||a instanceof Oe)&&(t.references=t.references.concat(r([a.reference])))}}return i}toString(){return this.stringify()}stringify(e={}){return this.stmts.map(t=>t.stringify(e)).join(this.delim)}static parse(e,t,r={}){var s=z.lex(e+";",V(this.operators).concat([Ae.testBlockEnd]));if(s.matches.length)return new this(s.tokens.map(e=>t(e.trim())).filter(e=>e),s.matches[0].trim())}static testBlockEnd(e,t){return!(!e.endsWith("}")||t.trim().startsWith("else"))&&""}}Ae.operators=[";","\r\n"];const Ce=class extends A{};Object.defineProperty(Ce.prototype,"jsenType",{get:()=>"BooleanType"});var xe=Ce;var Re=class extends xe{constructor(e){super(),this.state=e}eval(){return"true"===this.state.toLowerCase().trim()}toString(){return this.stringify()}stringify(e={}){return this.state}static parse(e,t,r={}){if("true"===(e=e.toLowerCase().trim())||"false"===e)return new this(e)}};var _e=class extends _{constructor(e,t){super(),this.reference=e,this.args=t}eval(e=null,t={}){try{var r=this.args.eval(e,t);return this.reference.getEval(e,t).exec(r)}catch(e){throw e instanceof F?new F("["+this+"]: "+e.message):e}}toString(){return this.stringify()}stringify(e={}){return this.reference.stringify(e)+this.args.stringify(e)}static parse(e,t,r={}){if(!e.startsWith("(")&&e.endsWith(")")&&!z.match(e,[" "]).length){var s,i=z.split(e,[]),n=i.pop();if(!((s=t(i.join(""),null,{lodge:!1}))instanceof x&&(n=t(n,[oe]))))throw new N(e);return s.role="CALL_SPECIFIER",new this(s,n)}}};const Ie=class extends A{};Object.defineProperty(Ie.prototype,"jsenType",{get:()=>"ComparisonExpression"});var Le=Ie;class be extends Le{constructor(e,t,r){super(),this.operand1=e,this.operand2=t,this.operator=r}eval(e=null,t={}){return this.constructor.compare(this.operand1.eval(e,t),this.operand2.eval(e,t),this.operator)}toString(){return this.stringify()}stringify(e={}){return[this.operand1.stringify(e),this.operator,this.operand2.stringify(e)].join(" ")}static parse(e,t,r={}){var s=V(this.operators).map(e=>" "+e+" "),i=z.lex(e,s);if(i.tokens.length>1){if(i.tokens.length>2)throw new Error('Malformed "Comparison" expression: '+e+"!");return new this(t(Q(i.tokens).trim()),t(J(i.tokens).trim()),i.matches[0].trim())}}static compare(e,t,r="=="){if(-1===V(this.operators).indexOf(r))throw new Error('The operator "'+r+'" is not recognized.');switch(r){case"===":return e===t;case"==":case"=":return e==t;case">":return e>t;case"<":return e<t;case">=":return e>=t;case"<=":return e<=t;case"!=":return e!=t;case"<>":case"!==":return e!==t;case"^=":return P(e)&&e.startsWith(t);case"$=":return P(e)&&e.endsWith(t);case"*=":return!(!s(t)&&!P(t))&&e.indexOf(t)>-1;case"~=":return P(e)&&P(t)&&(" "+e+" ").indexOf(" "+t+" ")>-1;case">=<":if(!s(t)||2!==t.length)throw new Error("A 'Between' comparison requires argument 2 to be an array of exactly 2 values.");return e>=t[0]&&e<=t[1];case"/**/":return t.match(new RegExp(e));default:return!1}}static diff(e,t,r){return!this.compare(e,t,r?"===":"==")}}be.operators={exact:{is:"===",isNull:"===",equalsTo:"==",strictlyNotEqualsTo:"!==",notEqualsTo:"!="},relative:{lesserThan:"<",greaterThan:">",lesserThanOrEqualsTo:"<=",greaterThanOrEqualsTo:">=",between:">=<"},partial:{startsWith:"^=",endsWith:"$=",contains:"*=",any:"~=",in:"~=",matches:"/**/"}};const Ne=class extends A{};Object.defineProperty(Ne.prototype,"jsenType",{get:()=>"TernaryConditional"});var Ue=Ne;class je extends Ue{constructor(e,t,r){super(),this.assertion=e,this.onTrue=t,this.onFalse=r}eval(e=null,t={}){return this.assertion.eval(e,t)?this.onTrue.eval(e,t):this.onFalse.eval(e,t)}toString(){return this.stringify()}stringify(e={}){return[this.assertion.stringify(e),this.constructor.operators[0],this.onTrue.stringify(e),this.constructor.operators[1],this.onFalse.stringify(e)].join(" ")}static parse(e,t,r={}){var s=z.split(e,this.operators);if(s.length>1){if(2===s.length)throw new Error("Malformed ternary expression: "+e+"!");return new this(t(s[0].trim()),t(s[1].trim()),t(s[2].trim()))}}}je.operators=["?",":"];const Pe=class extends Oe{constructor(e,t="delete"){super(),this.reference=e,this.operator=t}eval(e=null,t={}){try{return this.reference.getEval(e,t).del()}catch(e){throw e instanceof F?new F("["+this+"]: "+e.message):e}}toString(){return this.stringify()}stringify(e={}){return this.operator+" "+this.reference.stringify(e)}static parse(e,t,r={}){var s=z.lex(e,Object.values(this.operators));if(1===s.matches.length&&e.startsWith(s.matches[0]+" ")){var i;if(!((i=t(s.tokens.pop().trim(),null,{lodge:!1}))instanceof x))throw new N(e);return i.role="DELETION_SPECIFIER",new this(i,s.matches[0].trim())}}};Pe.operators={red:"reduce",del:"delete"};var ke=Pe;const De=class extends I{};Object.defineProperty(De.prototype,"jsenType",{get:()=>"FunctionType"});var We=De;const Fe=class extends We{constructor(e,t,r={}){super(),this.paramters=e||{},this.statements=t,this.arrowFunctionFormatting=r}inherit(e){if(e instanceof We){for(var t=Object.keys(e.paramters),r=Object.keys(this.paramters),s=0;s<Math.max(r.length,t.length);s++){var i=t[s],n=r[s];if(!n&&i)throw new Error("Parameter #"+s+" ("+i+") in parent function must be implemented.");if(n&&i){var a=e.paramters[i],o=this.paramters[n];if(o&&!a)throw new Error("Parameter #"+s+" ("+n+") must not have a default value as established in parent function.");if(o&&a&&o.jsenType!==a.jsenType)throw new Error("Default value for parameter #"+s+" ("+n+") must be of type "+a.jsenType+" as established in parent function.")}}this.sup=e}return this}eval(e=null,t={}){var r=this;return function(...s){var i={};T(Object.keys(r.paramters),(n,a)=>{var o=r.paramters[a];if(s.length-1<n&&!o)throw new Error('The parameter "'+a+'" is required.');i[a]=s.length>n?s[n]:r.paramters[a]?r.paramters[a].eval(e,t):null}),r.arrowFunctionFormatting||(i.this=this);var n=e instanceof B?e.params.errorLevel:void 0,a=new B({main:i,super:e},{errorLevel:n}),o=r.statements.eval(a,t);return!1===r.arrowFunctionFormatting.body?o[0]:o}}toString(){return this.stringify()}stringify(e={}){var t=[];if(T(this.paramters,(r,s)=>{t.push(r+(s?"="+s.stringify(e):""))}),this.arrowFunctionFormatting){var r=!1===this.arrowFunctionFormatting.head||1===t.length&&-1===t[0].indexOf("="),s=!1===this.arrowFunctionFormatting.body;return(r?t[0]:"("+t.join(", ")+")")+" => "+(s?this.statements.stringify(e):"{"+this.statements.stringify(e)+"}")}return"function ("+t.join(", ")+") {"+this.statements.stringify(e)+"}"}static parse(e,t,r={}){var s;if((e=e.trim()).startsWith("function")&&(s=z.split(e,[]).slice(1).filter(e=>e.trim()))&&2===s.length)var i=!1,n=K(s.shift().trim(),"(",")"),a=K(s.shift().trim(),"{","}");else{if(e.startsWith("function")||!(s=z.split(e,["=>"]))||2!==s.length)return;n=s.shift().trim(),a=s.shift().trim(),i={};G(n,"(",")")?n=K(n,"(",")"):i.head=!1,G(a,"{","}")?a=K(a,"{","}"):i.body=!1}var o={};z.split(n,[","]).forEach(e=>{var r=e.split("=");r[1]?o[r[0].trim()]=t(r[1].trim(),null,{meta:null}):o[e.trim()]=null});var h=t(a,[Ae],{assert:!1})||t(a,null,{meta:null});return new this(o,"Block"===h.jsenType?h:new Ae([h]),i)}};Fe.operators=["=>"];var Be=Fe;var Me=class extends b{constructor(e,t,r,s={}){super(),this.assertion=e,this.onTrue=t,this.onFalse=r,this.params=s}eval(e=null,t={}){var r=e instanceof B?e.params.errorLevel:void 0,s=new B({main:{},super:e},{type:2,errorLevel:r});return this.assertion.eval(e,t)?this.onTrue?this.onTrue.eval(s,t):void 0:this.onFalse?this.onFalse.eval(s,t):void 0}toString(){return this.stringify()}stringify(e={}){var t=this.onTrue&&this.params.onTrueIsBlock?"{"+this.onTrue.stringify(e)+"}":this.onTrue?this.onTrue.stringify(e):"",r=this.onFalse&&this.params.onFalseIsBlock?"{"+this.onFalse.stringify(e)+"}":this.onFalse?this.onFalse.stringify(e):"";return"if ("+this.assertion.stringify(e)+")"+t+(r?" else "+r:"")}static parse(e,t,r={}){var s;if((e=e.trim()).startsWith("if")&&(s=z.split(e,[],{limit:2}).slice(1).filter(e=>e.trim()))&&2===s.length){var i,n,a=t(K(s.shift().trim(),"(",")").trim()),o=z.split(s.shift().trim(),["else"],{limit:1}),h=o.shift().trim(),c=(o.shift()||"").trim();return G(h,"{","}")&&(i=!0,h=K(h,"{","}").trim()),h=t(h,[Ae],{assert:!1,meta:null})||t(h,null,{meta:null}),c&&(G(c,"{","}")&&(n=!0,c=K(c,"{","}").trim()),c=t(c,[Ae],{assert:!1,meta:null})||t(c,null,{meta:null})),new this(a,h,c,{onTrueIsBlock:i,onFalseIsBlock:n})}}},He=function(e,t,r=null){return s(t)?e.filter(e=>r?t.filter(t=>r(e,t)).length:-1!==t.indexOf(e)):[]};const Ge=class extends A{};Object.defineProperty(Ge.prototype,"jsenType",{get:()=>"MathExpression"});var Ye=Ge;const Ke=class extends Ye{constructor(e,t){super(),this.val=e,this.exprs=t}eval(e=null,t={}){return this.exprs.reduce((r,s)=>{var i=s.val.eval(e,t),n=s.operator.trim();if(!(c(r)&&c(i)||"+"===n))throw new Error("Invalid Math expression: "+this.toString()+"!");switch(n){case"+":return r+i;case"-":return r-i;case"*":return r*i;case"/":return r/i}},this.val.eval(e,t))}toString(){return this.stringify()}stringify(e={}){return[this.val.stringify(e)].concat(this.exprs.map(t=>t.operator+" "+t.val.stringify(e))).join(" ")}static parse(e,t,r={}){var s=z.lex(e,V(this.operators));if(s.tokens.filter(e=>e).length>1&&s.matches.length===s.tokens.length-1){var i=W(s.matches);if(He(i,this.operators.sup).length&&He(i,this.operators.sub).length)throw new Error('"Addition/subtraction" and "multiplication/division" operators cannot be used in the same expression: '+e+"!");return new this(t(s.tokens.shift().trim()),s.tokens.map((e,r)=>({operator:s.matches[r],val:t(e.trim())})))}}};Ke.operators={sup:["*","/"],sub:["+","-"]};var $e=Ke;const qe=class extends A{};Object.defineProperty(qe.prototype,"jsenType",{get:()=>"NumberType"});var Ve=qe;var Qe=class extends Ve{constructor(e,t=0){super(),this.int=e,this.dec=t}eval(){return parseFloat(this.int+(this.dec?"."+this.dec:null))}toString(){return this.stringify()}stringify(e={}){return this.int+(this.dec?"."+this.dec:null)}static parse(e,t,r={}){if(c(e)){e=e.split(".");return new this(parseInt(e.shift()),parseInt(e.shift()))}}};const Je=class extends A{};Object.defineProperty(Je.prototype,"jsenType",{get:()=>"ObjectType"});var Xe=Je;const ze=class extends Xe{constructor(e){super(),this.entries=e||{}}inherit(e){return e instanceof Xe&&T(e.entries,(e,t)=>{e in this.entries||(this.entries[e]=t)}),this}eval(e=null,t={}){var r={};return T(this.entries,(s,i)=>{r[s]=i.eval(e,t)}),r}toString(){return this.stringify()}stringify(e={}){var t=[];return T(this.entries,(r,s)=>{t.push(r+ze.operators.sub+s.stringify(e))}),"{"+t.join(ze.operators.sup)+"}"}static parse(e,t,r={}){if(G(e,"{","}")&&!z.match(e.trim(),[" "]).length){var s={},i=z.split(K(e,"{","}"),[ze.operators.sup]).map(e=>e.trim()).filter(e=>e);return T(i,(e,r)=>{var i=z.split(r,[ze.operators.sub],{limit:1});s[Q(i).trim()]=t(J(i).trim())}),new this(s)}}};ze.operators={sup:",",sub:":"};var Ze=ze;const et=class extends A{};Object.defineProperty(et.prototype,"jsenType",{get:()=>"PresenceOperator"});var tt=et;const rt=class extends tt{constructor(e,t,r="in"){super(),this.prop=e,this.reference=t,this.operator=r}eval(e=null,t={}){var r=this.prop.eval(e,t);try{return this.reference.getEval(e,t).has(r)}catch(e){throw e instanceof F?new F("["+this+"]: "+e.message):e}}toString(){return this.stringify()}stringify(e={}){return[this.prop.stringify(e),this.operator,this.reference.stringify(e)].join(" ")}static parse(e,t,r={}){var s=z.lex(e,this.operators);if(2===s.tokens.length){var i,n;if(!((i=t(s.tokens.shift().trim()))&&(n=t(s.tokens.shift().trim()))instanceof x))throw new N(e);return new this(i,n,s.matches[0].trim())}}};rt.operators=[" in "];var st=rt;class it extends x{constructor(e,t,r=!1){super(),this.context=e,this.name=t,this.backticks=r}getEval(e=null,t={}){var r=e,s=this.name;return this.context&&(s instanceof A&&(s=s.eval(e,t)),r=this.context.eval(e,t)),{get:()=>B.create(r).get(s,t.trap),del:()=>B.create(r).del(s,t.trap),has:e=>B.create(r).has(s,e,t.trap),set:(e,i=null)=>B.create(r).set(s,e,t.trap,i),exec:e=>B.create(r).exec(s,e,t.trap)}}eval(e=null,t={}){try{return this.getEval(e,t).get()}catch(e){throw e instanceof F?new F("["+this+"]: "+e.message):e}}toString(){return this.stringify()}stringify(e={}){var t=this.name;if(this.context){var r=this.context.stringify(e);t instanceof A?t="["+t.stringify(e)+"]":this.backticks&&(t="`"+t+"`")}else{r=e.context;this.backticks&&(t="`"+t+"`")}return(r||"")+(r&&!t.startsWith("[")?it.separator:"")+t}static parse(e,t,r={}){if(!z.match(e.trim(),[" "]).length){var s,i,n=z.split(e,[]),a=n.pop(),o=z.split(a.trim(),[this.separator],{preserveDelims:!0});if(o.length>1&&(a=o.pop().substr(1),n=n.concat(o)),G(a,"`","`")&&(a=K(a,"`","`"),i=!0),n.length&&((s=t(n.join(""))).role="CONTEXT"),G(a,"[","]")){if(!s)throw new N(e);a=t(K(a,"[","]"))}return new this(s,a,i)}}}it.separator=".";var nt=class extends Te{constructor(e){super(),this.expr=e}eval(e=null,t={}){return this.expr?this.expr.eval(e,t):void 0}toString(){return this.stringify()}stringify(e={}){return this.expr?"return "+this.expr.stringify(e):"return"}static parse(e,t,r={}){var s=e.toLowerCase();if(s.startsWith("return ")||"return"===s)return new this(t(e.substr(6).trim()))}};const at=class extends A{};Object.defineProperty(at.prototype,"jsenType",{get:()=>"StringType"});var ot=at;var ht=class extends ot{constructor(e,t){super(),this.expr=e,this.quote=t}eval(){return this.expr}toString(){return this.stringify()}stringify(e={}){return this.quote+this.expr+this.quote}static parse(e,t,r={}){if(e=e.trim(),(G(e,'"','"')||G(e,"'","'"))&&!z.match(e,[" "]).length){var s=G(e,'"','"')?'"':"'";return new this(K(e,s,s),s)}}};const ct=class extends A{};Object.defineProperty(ct.prototype,"jsenType",{get:()=>"Void"});var lt=ct;var ut=class extends lt{constructor(e){super(),this.val=e}eval(){return"null"===this.val.toLowerCase().trim()?null:void 0}toString(){return this.stringify()}stringify(e={}){return this.val}static parse(e,t,r={}){if("null"===(e=e.toLowerCase().trim())||"undefined"===e)return new this(e)}};j.grammars={If:Me,Return:nt,Deletion:ke,Assignment:de,Presence:st,Func:Be,Abstraction:te,Condition:je,Assertion:ue,Comparison:be,Math:$e,Arr:ie,Obj:Ze,Num:Qe,Str:ht,Bool:Re,Void:ut,Call:_e,Reference:it};var pt=j;class ft extends pt{static parse(e,t,r={}){return"mutates"in r||(r.mutates=!0),!r.placeholdersTransformed&&e.indexOf("?")>0&&(e=z.split(e,["?"],{blocks:[]}).reduce((e,t,r)=>e?e+"?"+(r-1)+t:t,null),r.placeholdersTransformed=!0,console.log("===============",e)),r.opts||(r.opts={}),"ci"in r.opts||(r.opts.ci=!0),r.allowCache=!1,super.parse(e,t,r)}}class mt extends ue{}mt.negation="NOT ",mt.operators={and:" and ",or:" or ",AND:" AND ",OR:" OR "};class gt extends be{}gt.operators={relative:{lesserThan:"<",greaterThan:">",lesserThanOrEqualsTo:"<=",greaterThanOrEqualsTo:">="},partial:{any:"any",in:"in",like:"like"},exact:{notEqualsTo:"<>",is:"="}};class dt extends it{stringify(e={}){return this.interpreted&&e.interpreted?s(this.interpreted)?this.interpreted.map(t=>t.stringify(e)).join(", "):this.interpreted.stringify(e):super.stringify(e)}getEval(e,t={}){if(this.interpreted)return s(this.interpreted)?this.interpreted.reduce((r,s)=>(r[s.name]=s.getEval(e,t),r),{}):this.interpreted.getEval(e,t);var r=e,i=this.name;if(this.context)r=this.context.eval(e,t);else if("CONTEXT"!==this.role&&"CALL_SPECIFIER"!==this.role){if(!e.$)throw new Error('"'+this+'" is undefined!');r=e.$}return{get:()=>B.create(r).get(i,t.trap),del:()=>B.create(r).del(i,t.trap),has:e=>B.create(r).has(i,e,t.trap),set:(e,s=null)=>B.create(r).set(i,e,t.trap,s),exec:e=>B.create(r).exec(i.toUpperCase(),e,t.trap)}}eval(e,t={}){return this.interpreted?s(this.interpreted)?this.interpreted.map(r=>r.eval(e,t)):this.interpreted.eval(e,t):this.getEval(e,t).get()}static parse(e,...t){return super.parse(e,...t)}}var Et=function(...e){var t={};s(arguments[0])&&(e=arguments[0],t=arguments[1]);var r=J(e),i={},a=class extends r{constructor(...e){super(...e)}};return a.prototypes=e,e.forEach(e=>{p([a,e],(e,t,r)=>!["name","prototype","prototypes","length","caller","callee","arguments","constructor","apply","bind","call","toString"].includes(e),!0),p([a.prototype,e.prototype],(e,t,r)=>!["prototype","prototypes"].includes(e)&&(!n(r[e])||(s(i[e])?i[e].push(r[e]):i[e]=[r[e]],!1)),!0)}),T(i,(e,r)=>{"constructor"!==e&&(a.prototype[e]=function(...s){if(Object.hasOwnProperty(t,e)&&n(t[e]))return t[e].call(this,r,...s);var i=[];return r.forEach(e=>{i.push(e.call(this,...s))}),J(i)})}),a};const yt=function(e,t,r=!1){var i=null,a=e;s(e)||(i=Object.keys(e),a=Object.values(e));var h=void 0,c=a.reduce((e,s)=>{if(void 0===h){if(t(s,e))return s;if(r&&(o(s)||n(s))&&void 0!==(h=yt(s,t,r)))return s}return e},void 0);if(void 0!==c){var l=i?i[a.indexOf(c)]:a.indexOf(c);return void 0!==h?[l].concat($(h)):l}};var vt=yt;const St=class extends A{};Object.defineProperty(St.prototype,"jsenType",{get:()=>"AggregateExpression"});var Tt=St,wt=function(...e){return p(e,(e,t,r)=>{if(s(t)&&s(r)){if(-1===t.indexOf(r[e]))return!0}else if(!(e in t))return!0})};const Ot=class extends A{};Object.defineProperty(Ot.prototype,"jsenType",{get:()=>"WindowConstruct"});var At=Ot;const Ct=class extends A{};Object.defineProperty(Ct.prototype,"jsenType",{get:()=>"OrderByExpression"});var xt=Ct;class Rt extends xt{constructor(e,t=!1){super(),this.columns=e,this.withRollup=t}eval(e,t={}){var r=(e,s)=>{var i={};e.forEach(e=>{var r=s[0].expr.eval(e,t);i[r]=i[r]||[],i[r].push(e)});var n=[];return function(e,t,r=null){for(var s=[],i=e.length,n=0;n<i;n++)s.push({index:n,value:r?r(e[n]):e[n]});return s.sort((function(e,t){return P(e.value)&&"".localeCompare?e.value.localeCompare(t.value):e.value===t.value?0:e.value>t.value?1:-1})),"desc"===(t||"").trim().toLowerCase()&&(s=s.reverse()),s.map(t=>e[t.index])}(Object.keys(i),s[0].order).forEach(e=>{n=n.concat(s.length>1?r(i[e],s.slice(1)):i[e])}),n};return r(e,this.columns)}toString(){return this.stringify()}stringify(e={}){var t=[this.columns.map(t=>t.expr.stringify(e)+(t.order?" "+t.order:"")).join(", ")];return this.withRollup&&t.push("WITH ROLLUP"),t.join(" ")}static parse(e,t,r={}){var s,i=!1,n=z.lex(e,["WITH[ ]+ROLLUP"],{useRegex:"i"});return s=z.split(n.tokens.shift().trim(),[","]).map(e=>{var r=e.match(/ASC|DESC/,"i");return r&&(r=r[0],e=Y(e,r).trim()),{expr:t(e),order:r}}),1===n.matches.length&&(i=!0),new this(s,i)}}class _t extends At{constructor(e){super(),this.dfn=e}eval(e,t={},r={}){var s=this.dfn,i=this.stringify();if(this.dfn.name){if(!t||!t[this.dfn.name])throw new Error('Window name "'+this.dfn.name+'" is undefined!');s=wt({},this.dfn,t[this.dfn.name])}var n=(e,t)=>{if(t.length){var a={};e.forEach(e=>{var s=t[0].eval(e,r);a[s]=a[s]||[],a[s].push(e)}),Object.values(a).map(e=>n(e,t.slice(1)))}else s.orderBy&&(e=s.orderBy.eval(e,r)),e.forEach(t=>{t.WINDOWS||(t.WINDOWS={}),t.WINDOWS[i]=e})};try{n(e,s.partitionBy||[])}catch(e){throw new Error('["'+this.stringify()+'" in window definition]: '+e.message)}}toString(){return this.stringify()}stringify(e={}){if(1===Object.keys(this.dfn).length&&this.dfn.name)return this.dfn.name;var t=[this.dfn.name];return this.dfn.partitionBy&&t.push("PARTITION BY "+this.dfn.partitionBy.map(t=>t.stringify(e)).join(", ")),this.dfn.orderBy&&t.push("ORDER BY "+this.dfn.orderBy.stringify(e)),"("+t.filter(e=>e).join(" ")+")"}static parse(e,t,r={}){var s={};if(G(e,"(",")")){if(e=K(e,"(",")")){var i=z.lex(e,["PARTITION[ ]+BY","ORDER[ ]+BY"],{useRegex:"i"});s.name=i.tokens.shift().trim(),i.matches.forEach(e=>{e.toLowerCase().startsWith("partition")?s.partitionBy=z.split(i.tokens.shift().trim(),[","]).map(e=>t(e)):e.toLowerCase().startsWith("order")&&(s.orderBy=t(i.tokens.shift().trim(),[Rt]))})}}else s.name=e;return new this(s)}}class It extends(Et(_e,Tt)){constructor(e,t){super(),this.reference=e,this.args=t}eval(e,t={}){var r=this.args.list.slice();return r.unshift(this.window?e.WINDOWS[this.window.stringify()]:e.AGGR.rows,this.aggrFlag),this.reference.getEval(e,t).exec(r)}toString(){return this.stringify()}stringify(e={}){var t=super.stringify(e);return this.aggrFlag&&(t=t.replace("(","("+this.aggrFlag+" ")),t+(this.window?" OVER "+this.window.stringify(e):"")}static parse(e,t,r={}){var s,i,n="",a=V(this.funcs).join("\\(|")+"\\(";if(s=e.trim().match(new RegExp("^("+a+")","i"))){var o=D(s[0],"(").toUpperCase();(i=k(e,o+"(").match(new RegExp("^(([ ]+)?"+["ALL","DISTINCT"].join("[ ]+|([ ]+)?")+"[ ]+)","i")))&&(n=i[0],e=e.replace(n,""));var h=vt(this.funcs,e=>e===o,!0)[0],c=z.split(e,["OVER"],{ci:!0});if("explicitOver"===h&&1===c.length)throw new Error(s[0]+"() requires an OVER clause!");var l=super.parse(c.shift().trim(),t,r);return l.funcCategory=h,l.aggrFlag=n.trim(),c.length&&(l.window=t(c.pop().trim(),[_t])),l}}}It.funcs={normal:["AVG","BIT_AND","BIT_OR","BIT_XOR","COUNT","JSON_ARRAYAGG","JSON_OBJECTAGG","MAX","MIN","STDDEV_POP","STDDEV","STD","STDDEV_SAMP","SUM","VAR_POP","VARIANCE","VAR_SAMP","GROUP_CONCAT","GROUP_CONCAT_WS"],explicitOver:["CUME_DIST","DENSE_RANK","FIRST_VALUE","LAG","LAST_VALUE","LEAD","NTH_VALUE","NTLE","PERCENT_RANK","RANK","ROW_NUMBER"],support:["ANY_VALUE","COLUMN","COLUMNS","GROUPING"]};var Lt=function(e){return s(e)?Q(e):e[Object.keys(e)[0]]};const bt=class extends dt{};Object.defineProperty(bt.prototype,"jsenType",{get:()=>"ArrowReferenceExpression"});var Nt=bt;class Ut{constructor(e,t={}){this.database=e,this.schema=t,this.name=e.name}exists(e){return this.list().includes(e)}async create(e,t,r=!1){if(this.exists(e)){if(!r)throw new Error('Table "'+e+'" already exists.');await this.drop(e)}return t.name=e,jt(this.schema,[t],r),await this._create(e,t,r)}async drop(e){if(!this.exists(e))throw new Error('Table "'+e+'" has not been defined.');return delete this.schema[e],await this._drop(e)}}const jt=(e,t,r)=>t.map(t=>{if(Pt(t),e[t.name]&&!r)throw new Error('Store name "'+t.name+'" already exists!');e[t.name]=t}),Pt=e=>{if(!a(e))throw new Error("Table definition must be an object.");if(!e.name)throw new Error("Table must have a name.");if(e.autoIncrement){if(!e.primaryKey)throw new Error("The Auto-Increment directive cannot be used without a Primary Key.");if($(e.primaryKey).length>1)throw new Error("The Auto-Increment directive cannot be used with a composite Primary Key.")}if(!a(e.fields))throw new Error('Table must have a valid "fields" list.');T(e.fields,(t,r)=>{if(!a(r))throw new Error('Invalid field definition: "'+t+'" at "'+e.name+'".');if(r.referencedEntity&&(!a(r.referencedEntity)||!r.referencedEntity.name))throw new Error('Invalid foreign key definition: "'+t+'" at "'+e.name+'".')})};class kt{static async query(e,...t){var r,i;return s(t[0])&&(i=t.shift()),r=t.shift()||{},i&&(r.vars=i),this._query(e,r)}static async exists(e=this.defaultDB){return(await this.list()).filter(t=>t.name===e).length>0}static async create(e=this.defaultDB,t=[],r=!1){var s=await this.list(),i=$(s).filter(t=>t.name===e).map(e=>e.version);if(i.length){if(!r)throw new Error('Database "'+e+'" already exists at versions: '+i.join(",")+"!");await this.drop(e)}return this.schema[e]={},Object.keys(t||{}).length&&(a(t)&&(T(t,(e,t)=>{t.name=e}),t=Object.values(t)),jt(this.schema[e],t)),await this._create(e,t,r)}static async drop(e=this.defaultDB){if(!await this.exists(e))throw new Error('Database "'+e+'" has not been defined.');return delete this.schema[e],await this._drop(e)}static async import(e,t,r=!1){var s=await this.create(e,t.schema,r);return Promise.all(Object.keys(t.data||{}).map(async e=>(await s.open(e,"readwrite")).addAll(t.data[e])))}static async export(e,...t){var r=await this.open(e,...t),s={schema:r.schema,data:{}},i=await r.list();return await Promise.all(i.map(async e=>{var t=await r.open(e);s.data[e]=await t.getAll()})),s}}kt.schema={},kt.defaultDB="default";const Dt=(e=null,t=null)=>e&&(e.prototype instanceof kt||e===kt)?e.schema[t||e.defaultDB]:!t&&e?e:void 0;class Wt extends Nt{process(e,t=null){var r=this.interpreted?this.interpreted.toString():this.toString();return Wt.process(e,r.replace(/`/g,""),t)}static parse(e,t,r={}){if(this.isReference(e)){var s=super.parse(e,t,r);return s&&(s.backticks=!0),s}}static isReference(e){return e.indexOf(this.arrLeft)>-1||e.indexOf(this.arrRight)>-1}static isOutgoing(e){return e.indexOf(this.arrRight)>-1&&-1===D(e,this.arrRight).indexOf(this.arrLeft)}static isIncoming(e){return e.indexOf(this.arrLeft)>-1&&-1===D(e,this.arrLeft).indexOf(this.arrRight)}static reverse(e){return e.replace(new RegExp(this.arrRight,"g"),"|"+this.arrRight+"|").replace(new RegExp(this.arrLeft,"g"),"|"+this.arrLeft+"|").split("|").map(e=>e===this.arrRight?this.arrLeft:e===this.arrLeft?this.arrRight:e).reverse().join("")}static process(e,t,r=null){var s,i=Dt(r,e?e.databaseName:null)||{fields:{}};if(this.isIncoming(t)){var n=D(t,this.arrLeft),a=k(t,this.arrLeft);if(n.indexOf(".")>0&&(e||(e=i[D(n,".")]),n=k(n,".")),this.isIncoming(a)){s=this.process(null,a,r).a.table;var o=a}else{var h=D(a,this.arrRight);if(o=k(a,this.arrRight),!(s=i[h]))throw new Error("["+t+']: The implied table "'+h+'" is not defined.')}if(!e){if(!s.fields[n]||!(c=s.fields[n].referencedEntity))throw new Error("["+t+']: The "'+s.name+'" table does not define the implied foreign key "'+n+'".');e=i[c.name]}return{a:{table:e,actingKey:e.primaryKey},b:{table:s,actingKey:n,select:o}}}var c,l=D(t,this.arrRight);if(o=k(t,this.arrRight),l.indexOf(".")>0?(e||(e=i[D(l,".")]),l=k(l,".")):e=Lt(i),!e.fields[l]||!(c=e.fields[l].referencedEntity))throw new Error("["+e.name+this.arrRight+t+']: The "'+e.name+'" table does not define the implied foreign key "'+l+'".');return{a:{table:e,actingKey:l},b:{table:s=i[c.name],actingKey:s.primaryKey,select:o}}}}Wt.arrRight="~>",Wt.arrLeft="<~";var Ft=function(e,t){return e.reduce((e,r,s)=>e&&t(r,s),!0)};const Bt=class extends I{};Object.defineProperty(Bt.prototype,"jsenType",{get:()=>"DeleteStatement"});var Mt=Bt,Ht=function(e,t=null){var r={};return 2===arguments.length&&(s(e)&&s(t)?e.forEach((e,s)=>r[e]=t[s]):r[e]=t),r};const Gt=class extends A{};Object.defineProperty(Gt.prototype,"jsenType",{get:()=>"Literal"});var Yt=Gt;class Kt extends Yt{constructor(e){super(),this.expr=e}eval(){return this.expr}toString(){return this.stringify()}stringify(e={}){return this.expr}static parse(e,t=null,r={}){return new this(e)}}const $t=class extends I{};Object.defineProperty($t.prototype,"jsenType",{get:()=>"TableExpression"});var qt=$t;class Vt{constructor(e){this.cache=e,this.key=0,this.flags={},this._onfinish=[]}onfinish(e){this._onfinish.push(e)}next(){if(!this.cache.length||this.key===this.cache.length-1)return this.__eof=!0,this._onfinish.forEach(e=>e()),void(this.key=0);this.key++}eof(){return!this.cache.length||this.key===this.cache.length-1}async fetch(){if(this.key<this.cache.length)return this.cache[this.key]}}class Qt{constructor(e,t,r={},s={}){this.store=e,this.name=t,this.schema=d(r)?{name:e.name,primaryKey:"",fields:{},uniqueKeys:{}}:r,this.params=s}async syncCursor(e){return await this.putAll(e.cache)}async match(e){var t,r,s;return this.schema.primaryKey&&(t=Jt(e,this.schema.primaryKey))&&(r=await this.get(t))?{matchingKey:"PRIMARY_KEY",primaryKey:t,row:r}:(this.schema.uniqueKeys&&(await this.getAll()).forEach((t,r)=>{s||T(this.schema.uniqueKeys,(i,n)=>{t&&Jt(e,n)===Jt(t,n)&&(s={matchingKey:i,primaryKey:this.schema.primaryKey?Jt(t,this.schema.primaryKey):r,row:{...t}})})}),s)}async addAll(e,t=[],r=null,s=!1){var i,n=[],o=await Promise.all(e.map(async(e,s)=>{var o={};if(a(e))o=e;else{var h=t.length?t:Object.keys(this.schema.fields);if(h.length&&h.length!==e.length)throw new Error("Column/values count mismatch at line "+s+"!");h.forEach((t,r)=>{o[t]=e[r]})}return this.handleInput(o,!0),this.shouldMatchInput(o)||r?i=new Promise(async e=>{await i;var t=await this.match(o);if(t&&r){var s={...t.row};return r(s,o)&&n.push(s),e(0)}await this.beforeAdd(o,t),e(this.add(o))}):(await this.beforeAdd(o),this.add(o))}));return n.length&&(o=o.concat(await this.putAll(n))),o}async beforeAdd(e,t){var r=(new Date).toLocaleString("en-CA",{hour12:!1});T(this.schema.fields||{},(t,s)=>{"datetime"!==s.type&&"timestamp"!==s.type||"CURRENT_TIMESTAMP"!==s.default||(e[t]=r)})}async putAll(e){var t;return await Promise.all(e.map(async e=>(this.handleInput(e),this.shouldMatchInput(e)?t=new Promise(async r=>{await t,await this.beforePut(e,await this.match(e)),r(this.put(e))}):(await this.beforePut(e),this.put(e)))))}async beforePut(e,t){if(t&&!Ft(Object.keys(e),r=>e[r]===t.row[r])){var r=(new Date).toLocaleString("en-CA",{hour12:!1});T(this.schema.fields||{},(t,s)=>{"datetime"!==s.type&&"timestamp"!==s.type||"CURRENT_TIMESTAMP"!==s.onupdate||(e[t]=r)})}}async deleteAll(e){return await Promise.all(e.map(async e=>this.delete(await this.beforeDelete(e))))}async beforeDelete(e){return e}handleInput(e,t=!1){var r=Object.keys(e),s=Object.keys(this.schema.fields),i=r.filter(e=>-1===s.indexOf(e));if(i.length)throw new Error("Unknown column: "+i[0]);s.forEach(s=>{var i=e[s],n=a(this.schema.fields[s])?this.schema.fields[s]:{};if(r.includes(s)?"json"===n.type?o(_value)||P(i)&&(G(i,"[","]")||G(i,"{","}")):["char","tinytext","smalltext","text","bigtext","varchar"].includes(n.type)?P(i):["bit","tinyint","smallint","int","bigint","decimal","number","float","real"].includes(n.type)||["enum","set"].includes(n.type)?c(i):["date","datetime","timestamp"].includes(n.type)&&P(i):t&&!He($(s),$(this.schema.primaryKey)).length&&(e[s]=!("default"in n)||["date","datetime","timestamp"].includes(n.type)&&"CURRENT_TIMESTAMP"===n.default?null:n.default),!1===n.nullable&&(m(e[s])||g(e[s])))throw new Error("Inserting NULL on non-nullable column: "+s)})}shouldMatchInput(e){return Object.keys(this.schema.fields).filter(e=>{var t=this.schema.fields[e];return["datetime","timestamp"].includes(t.type)&&("CURRENT_TIMESTAMP"===t.default||"CURRENT_TIMESTAMP"===t.onupdate)}).length}}const Jt=(e,t)=>$(t).map(t=>e[t]).filter(e=>e).join("-");class Xt extends Qt{constructor(e,t,r,s={},i={}){super(t,r,s,i),this.stmt=e}getCursor(){return new Vt((this.store||[]).filter(e=>e))}async syncCursor(e){return this.stmt.base.syncCursors()}}var zt=class extends Error{};class Zt extends Vt{}class er extends Qt{constructor(e,t,r={},s={}){super(...arguments),this.ongoingWrite=null}getCursor(){return new Zt((this.store||[]).reduce((e,t)=>e.concat(t?{...t}:void 0),[]).filter(e=>e))}async getAll(){return(this.store||[]).reduce((e,t)=>e.concat(t?{...t}:void 0),[])}async get(e){if(!this.schema.primaryKey)throw new Error("Table must define a Primary Key to fetch an item by Primary Key.");var t=this.store;return e=$(e).join("-"),this.schema.autoIncrement?t[e-1]?{...t[e-1]}:void 0:t[e]?{...t[e]}:void 0}async count(){return this.store.length}shouldMatchInput(e){return this.schema.primaryKey||super.shouldMatchInput(e)}async beforeAdd(e,t){if(t)throw new zt("Inserting duplicate values on unique key constraint: "+t.matchingKey);rr(this.store,e,this.schema.primaryKey,this.schema.autoIncrement),await super.beforeAdd(e,t)}add(e){return this.ongoingWrite=new Promise(async(t,r)=>{try{await this.ongoingWrite}catch(e){}var s=this.store,i=tr(e,this.schema.primaryKey);this.schema.autoIncrement?s[i-1]=e:s[i]=e,t(i)}),this.ongoingWrite}async beforePut(e,t){t?T(t.row,(t,r)=>{t in e||(e[t]=r)}):rr(this.store,e,this.schema.primaryKey,this.schema.autoIncrement);await super.beforePut(e,t)}put(e){return this.ongoingWrite=new Promise(async t=>{try{await this.ongoingWrite}catch(e){}var r=this.store,s=tr(e,this.schema.primaryKey);this.schema.autoIncrement?r[s-1]=e:r[s]=e,t(s)}),this.ongoingWrite}delete(e,t=!0){return this.ongoingWrite=new Promise(async(r,s)=>{try{await this.ongoingWrite}catch(e){}var i,n=this.store;if(this.schema.autoIncrement?n[e-1]&&(delete n[e-1],i=e):n[e]&&(delete n[e],i=e),!i&&t)return s(new Error("The given row (with "+$(this.schema.primaryKey).join(",")+" = "+i+") does not exist in the store."));r(i)}),this.ongoingWrite}async clear(){return this.store.splice(0),!0}}var tr=(e,t)=>$(t).map(t=>e[t]).filter(e=>e).join("-");function rr(e,t,r,s){if(r){var i=tr(t,r);if(!i&&s){var n=$(r);if(n.length>1)throw new Error("The Auto-Increment flag cannot be used with Composite Primary Keys.");i=e.length+1,t[n[0]]=i}return i}}class sr extends Ut{list(){return Object.keys(this.database)}open(e,t="readonly",r={}){var s=this.database[e];return r.mode=t,new er(s,e,this.schema[e],r)}async _create(e,t,r){var s=[];return this.database[e]=s,new er(s,this.schema[e])}async _drop(e){return delete this.database[e],!0}}class ir extends kt{static async _query(e,t={}){return t.DB_FACTORY=this,Mr.parse(e,null,t).eval(this)}static async list(){return Object.keys(this.databases).map(e=>({name:e,version:0}))}static async open(e=this.defaultDB,t=0){return new sr(this.databases[e],this.schema[e])}static async _create(e,t,r=!1){return this.databases[e]={},(t||[]).length&&t.forEach(t=>{this.databases[e][t.name]=[]}),new sr(this.databases[e],this.schema[e])}static async _drop(e){return delete this.databases[e],!0}}ir.databases={};var nr=function(e){return(e=e.slice()).reduce((e,t)=>Math.max(e,t),e.shift())};class ar extends qt{constructor(e,t,r=!1,s=null){super(),this.expr=e,this.alias=t,this.claused=r,this.schema=s,this.associatedReferences=[]}as(e){return this.alias=e,this.claused=!0,this}getDatabaseName(){return(this.expr+"").split(".").slice(0,-1)[0]||""}getName(){return this.isDerivedQuery()?$(this.getDerivedQuery().getTable(),!1)[0].getName():(this.expr+"").split(".").pop()}getAlias(){return this.alias||this.getName()}isDerivedQuery(){return this.expr instanceof ee}getDerivedQuery(){return this.expr.expr}associateReference(e){return this.associatedReferences.push(e)}getAssociateReferences(){return this.associatedReferences}getSchema(){if(!this.schema&&this.isDerivedQuery()){var e=this.getAlias(),t=this.getDerivedQuery(),r=t.getSources(!0),i=e=>t.getFields().reduce((t,r)=>t||(e===r.getName()?r.getAlias():null),null),n={};r.forEach(e=>{n[e.getAlias()]=e.getSchema()});var a=Lt(n),o={name:e,fields:{},uniqueKeys:{},derived:!0};t.getFields().forEach(e=>{if(y(e.expr,x))if("*"===e.getName())e.expr.interpreted.forEach(e=>{o.fields[e.name]=((n[e.context.name]||{}).fields||{})[t]||{type:"any",derived:!0}});else{var t=e.getName(),r=e.getContextName();o.fields[e.getAlias()]=(((r?n[r]:a)||{}).fields||{})[t]||{type:"any",derived:!0}}else o.fields[e.getAlias()]={type:"any",derived:!0}}),o.primaryKey=s(a.primaryKey)?a.primaryKey.map(e=>i(e)):i(a.primaryKey),o.autoIncrement=a.autoIncrement,d(o.primaryKey)&&(delete o.primaryKey,delete o.autoIncrement),T(a.uniqueKeys||{},(e,t)=>{var r=$(t).map(e=>i(e));o.uniqueKeys[e]=s(t)?r:r[0],d(o.uniqueKeys[e])&&delete o.uniqueKeys[e]}),o.engine=a.engine,this.schema=o}return this.schema}eval(e=null,t={}){if(this.interpreted)return this.interpreted.eval(e,t);if(!e)throw new Error("Context must be provided!");if(this.isDerivedQuery()){var r=this.getAlias(),s=this.getDerivedQuery(),i=this.getSchema(e);return s.eval(e,t).then(e=>{var n={...t};return n.alias=r,new Xt(s,e,r,i,n)})}return Promise.resolve().then(()=>{var t=this.getDatabaseName();if(e.prototype instanceof kt)return t?e.open(t):e.open();if(t)throw new Error("["+this.expr+"]: For tables that are fully-qualified with a database name, a database factory must be provided as context.");return e}).then(e=>{if(!(e instanceof Ut))throw new Error("["+this.expr+"]: The provided context could not be resolved to a valid database instance.");return e.open(this.getName(),t.mode,{alias:this.getAlias()})})}toString(){return this.stringify()}stringify(e={}){return this.interpreted&&e.interpreted?this.interpreted.stringify(e):[this.expr.stringify(e),this.claused?"AS":"",this.alias].filter(e=>e).join(" ")}static parse(e,t,r={}){var s=z.lex(e,[" (as )?"],{useRegex:"i"});if(s.tokens.length<3){var i,n=t(s.tokens[0],[te,Kt]),a=(s.tokens[1]||"").trim(),o=(s.matches[0]||"").trim();if(n instanceof Yt){var h,c=n.toString().split("."),l=c.pop(),u=c.pop();if((h=Dt(r.DB_FACTORY,u))&&h[l])i=h[l];else{if(!1!==r.validation&&!1!==r.assertTableValidity)throw new Error("Unknown table: "+l+".");i={name:l,fields:{},derived:!0}}}return new this(n,a,o,i)}}}var or=function(e){return(e=e.slice()).reduce((e,t)=>e+t,e.shift())};class hr{constructor(e){Object.defineProperty(this,".params",{value:e})}CONCAT(...e){return e.join("")}CONCAT_WS(...e){return e.join(e.shift())}COALESCE(...e){return e.reduce((e,t)=>m(e)?t:e,null)}FIND_IN_SET(e,t){return t.indexOf(e)}ISNULL(e){return m(e)}COUNT(e,t,r){return"*"===r.stringify()?e.length:this.COLUMN(e,t,r).length}GROUP_CONCAT(e,t,r){return this.COLUMN(e,t,r).join("")}GROUP_CONCAT_WS(e,t,r,s){return this.COLUMN(e,t,s).join(r.eval(this,this[".params"]))}AVG(e,t,r){return(s=this.COLUMN(e,t,r)).length?or(s)/s.length:0;var s}MAX(e,t,r){return nr(this.COLUMN(e,t,r))}MIN(e,t,r){return(s=(s=this.COLUMN(e,t,r)).slice()).reduce((e,t)=>Math.min(e,t),s.shift());var s}SUM(e,t,r){return or(this.COLUMN(e,t,r))}FIRST(e,t,r){return r.eval(Q(e)||{},this[".params"])}LAST(e,t,r){return r.eval(J(e)||{},this[".params"])}ANY_VALUE(e,t,r){return function(e,t=1){for(var r=[],s=null;r.length<t&&(s=e[Math.floor(Math.random()*e.length)])&&-1===r.indexOf(s);)r.push(s);return arguments.length>1?r:r[0]}(this.COLUMN(e,t,r))}GROUPING(e,t,...r){return this.AGGR&&this.AGGR.isRollup?r.reduce((e,t,r)=>this.AGGR.by.filter(e=>{var r=e.stringify(),s=t.stringify();return-1===s.indexOf(".")&&r.indexOf(".")>-1&&(r=k(r,".")),s===r}).length?r+1:e,0):0}COLUMN(e,t,r){var i=e.map(e=>r.eval(e,this[".params"]));if(s(i[0])){var n=i[0].length;i=i.filter(e=>{if(!s(e)||e.length!==n)throw new Error("Aggregate column list not even!");return e.reduce((e,t)=>m(e)?t:e,null)})}return i=i.filter(e=>!m(e)),"DISTINCT"===t.toUpperCase()&&(i=W(i)),i}COLUMNS(e,t,r){return r.map(r=>this.COLUMN(e,t,r))}JSON_EXTRACT(e,t){return function(e,t,r={},s={}){t=$(t).slice();for(var i=e;!g(i)&&!m(i)&&t.length;){var n=t.shift();if(!(r.get?r.get(i,n):o(i)?n in i:i[n]))return void(s.exists=!1);i=r.get?r.get(i,n):i[n]}return s.exists=!0,i}(JSON.parse(e),t.split(".").slice(1))}JSON_OBJECT(e,t){return Ht(e,t)}JSON_MERGE(e,t){return f(JSON.parse(e),JSON.parse(t))}}class cr{constructor(e,t,r,s){this.main=e,this.joins=t,this.mainCursor=e.then(e=>e.getCursor()),this.joinCursors=t.map(e=>e.then(e=>e.getCursor())),this.where=r,this.params=s,this._onfinish=[],Promise.all(this.joinCursors).then(e=>{var t=e.reduce((e,t)=>(e&&e.onfinish(t.next.bind(t)),t),null);this.mainCursor.then(e=>{t&&t.onfinish(e.next.bind(e)),e.onfinish(()=>{this.eof=!0,this._onfinish.forEach(e=>e())})})})}onfinish(e){this._onfinish.push(e)}async fetch(){if(this.eof)return;var e,t;let r=await this.main,s=await this.mainCursor,i=await s.fetch(),n=r.params.alias||r.name,a=await Promise.all(this.joins),o=await Promise.all(this.joinCursors),h=o.map(async(e,r)=>{if(!t){var o=await e.fetch(),h=a[r].params.alias||a[r].name;if(!a[r].join||"full"===a[r].join.type)return e.flags[s.key]=!0,o;if("using"===a[r].join.conditionClause.trim().toLowerCase()){var c=a[r].join.condition.stringify();if(o[c]===i[c])return e.flags[s.key]=!0,o}else{var l=new hr(this.params);if(l[n]=i,l[h]=o,a[r].join.condition.eval(l,this.params))return e.flags[s.key]=!0,o}if(!e.flags[s.key]){if(e.eof()&&"left"===a[r].join.type.toLowerCase())return{};if(s.eof()&&"right"===a[r].join.type.toLowerCase())return i={},null}t=!0}}),c=await Promise.all(h);if((o[0]||s).next(),c.filter(e=>e).length===h.length){var l=new hr(this.params);l[n]=i,c.forEach((e,t)=>{var r=a[t].params.alias||a[t].name;l[r]=e}),e=l}try{if(!e||this.where&&!this.where.eval(e,this.params))return await this.fetch()}catch(e){throw new Error('["'+this.where.stringify()+'" in WHERE clause]: '+e.message)}return e}async syncCursors(){var e=await Promise.all(this.joins.concat(this.main)),t=await Promise.all(this.joinCursors.concat(this.mainCursor));return Promise.all(t.map((t,r)=>e[r].syncCursor(t)))}}class lr{constructor(e,t,r){var s=ur(e,["uac"]);if(this.user=r||{id:0,parent:0,lineage:"0",privileges:[]},this.schema=t,this.alias="MAIN",this.select=[],this.where=[],s.SCHEMAS.uac&&(this.EXPLICIT_TABLE_ACCESS_QUERY={query:pr(s,this.schema.name,this.user),alias:"EXPLICIT_TABLE_ACCESS",on:["EXPLICIT_TABLE_ACCESS.table_row = 0"]}),"row"===s.CONTROL_LEVEL&&(s.SCHEMAS.uac&&(this.EXPLICIT_ROW_ACCESS_QUERY={query:pr(s,this.schema.name,this.user),alias:"EXPLICIT_ROW_ACCESS",on:["EXPLICIT_ROW_ACCESS.table_row = "+this.alias+"."+this.schema.primaryKey]}),this.schema.attributionKey&&s.SCHEMAS.account)){var i=fr(s,this.user,!1);this.AUTHOR_user_RELATIONSHIP_QUERY={query:i,alias:"AUTHOR_user_RELATIONSHIP",on:["AUTHOR_user_RELATIONSHIP."+i.schema.primaryKey+" = "+this.alias+"."+this.schema.attributionKey]}}this.where.push(this.deriveEntityAccess("view")+" <> 0")}deriveEntityAccess(e,t=!1){var r=[];return this.EXPLICIT_ROW_ACCESS_QUERY&&r.push("JSON_EXTRACT("+this.EXPLICIT_ROW_ACCESS_QUERY.alias+'.uac, "$.'+e+'")'),this.EXPLICIT_TABLE_ACCESS_QUERY&&r.push("JSON_EXTRACT("+this.EXPLICIT_TABLE_ACCESS_QUERY.alias+'.uac, "$.'+e+'")'),r.push(mr(gr(this.schema.uac,e),this.getGuestRightsExpression(),t)),"COALESCE("+r.join(", ")+")"}deriveFieldsAccess(e,t,r=!1){var s={};return e.forEach(e=>{var i=[];this.EXPLICIT_ROW_ACCESS_QUERY&&i.push("JSON_EXTRACT("+this.EXPLICIT_ROW_ACCESS_QUERY.alias+'.fields, "$.'+e+".uac."+t+'")'),this.EXPLICIT_TABLE_ACCESS_QUERY&&i.push("JSON_EXTRACT("+this.EXPLICIT_TABLE_ACCESS_QUERY.alias+'.fields, "$.'+e+".uac."+t+'")'),i.push(mr(gr(this.schema.fields[e].uac,t),this.getGuestRightsExpression(),r)),s[e]="COALESCE("+i.join(", ")+")"}),s}getGuestRightsExpression(){var e=[];return this.AUTHOR_user_RELATIONSHIP_QUERY&&(e.push(this.AUTHOR_user_RELATIONSHIP_QUERY.alias+".relationship"),this.AUTHOR_user_TOKEN_QUERY&&e.push("IF("+this.AUTHOR_user_TOKEN_QUERY.alias+'.id, "user", "")')),this.user.privileges.length&&e.push('"'+this.user.privileges.join(",")+'"'),e.length?'CONCAT_WS(",", '+e.join(", ")+")":'""'}toString(){return"SELECT "+this.select.join(", ")+" FROM "+this.schema.name+" AS "+this.alias+(this.EXPLICIT_TABLE_ACCESS_QUERY?" LEFT JOIN ("+this.EXPLICIT_TABLE_ACCESS_QUERY.query+") AS "+this.EXPLICIT_TABLE_ACCESS_QUERY.alias+" ON "+this.EXPLICIT_TABLE_ACCESS_QUERY.on.join(" AND "):"")+(this.EXPLICIT_ROW_ACCESS_QUERY?" LEFT JOIN ("+this.EXPLICIT_ROW_ACCESS_QUERY.query+") AS "+this.EXPLICIT_ROW_ACCESS_QUERY.alias+" ON "+this.EXPLICIT_ROW_ACCESS_QUERY.on.join(" AND "):"")+(this.AUTHOR_user_RELATIONSHIP_QUERY?" LEFT JOIN ("+this.AUTHOR_user_RELATIONSHIP_QUERY.query+") AS "+this.AUTHOR_user_RELATIONSHIP_QUERY.alias+" ON "+this.AUTHOR_user_RELATIONSHIP_QUERY.on.join(" AND "):"")+" WHERE "+this.where.join(" AND ")}}function ur(e,t=[]){var r=f({DB_FACTORY:e.DB_FACTORY,SCHEMAS:{}},e.UAC||{});return t.forEach(e=>{var t=e;r.TABLE_SPECIFIERS&&(t=r.TABLE_SPECIFIERS[e]);var s=t.split("."),i=s.pop(),n=s.pop();r.SCHEMAS[e]=(Dt(r.DB_FACTORY,n)||{})[i]}),r}function pr(e,t,r){var s='FIND_IN_SET(target, "'+r.lineage.replace("/",",")+'")';return{schema:e.SCHEMAS.uac,select:["*",s+" AS `lineage.target`"],where:["table_name = "+t,"target = "+r.id+" OR "+s],orderBy:"`lineage.target` DESC",limit:1,toString(){return"SELECT "+this.select.join(", ")+" FROM "+this.schema.name+" WHERE "+this.where.join(" AND ")+" ORDER BY "+this.orderBy+" LIMIT "+this.limit}}}function fr(e,t,r=!1){var s={};s.DESCENDANT='FIND_IN_SET(id, "'+t.lineage.replace(t.id+"/","").replace(/\//g,",")+'")',s["DESCENDANT,CHILD"]="id = "+t.parent,s.SIBLING=t.parent+" = parent",s.ANCESTOR="FIND_IN_SET("+t.id+', REPLACE(REPLACE(lineage, CONCAT(id, "/"), ""), "/", ","))',s["ANCESTOR,PARENT"]=t.id+" = parent",s.AUTHOR="id = "+t.id;var i="NULL";return T(s,(e,t)=>{i="IF("+e+', "'+t+'", '+i+")"}),{schema:e.SCHEMAS.account,select:(r?"GROUP_CONCAT(DISTINCT ":"")+i+(r?")":"")+" AS relationship",where:[],toString(){return"SELECT "+this.select+" FROM "+this.schema.name+(this.where.length?" WHERE "+this.where.join(" AND "):"")}}}function mr(e,t,r=!1){var s=S(e[0])?e.shift():null;if(!e.length)return S(s)?parseInt(s):"NULL";var i=[];return e.forEach(e=>{var r=[];e.split("+").forEach(e=>{r.push('FIND_IN_SET("'+e+'", '+t+")")}),i.push("IF("+r.join(" AND ")+', "'+e+'", NULL)')}),i="COALESCE("+i.join(", ")+")",s?"IF(ISNULL("+i+"), 1, 0)":"IF(ISNULL("+i+"), 0, "+(r?i:"1")+")"}function gr(e,t){return a(e)&&(e=e[t]),d(e)?[]:$(e)}class dr{static select(e,t,r,s=[]){(s=$(s)).length&&"*"!==s[0]||(s=Object.keys(t.fields));var i=new lr(e,t,r);return i.select.push(...s),i}static getRelatedAccounts(e,t,r,s=[]){var i=ur(e,["uac","account"]),n={schema:i.SCHEMAS.account,alias:"ACCOUNT",select:[],where:[],orderBy:[],toString(){return"SELECT "+this.select.join(", ")+" FROM "+this.schema.name+" AS "+this.alias+" RIGHT JOIN ("+this.AUTHOR_USER_RELATIONSHIP_QUERY.query+") AS "+this.AUTHOR_USER_RELATIONSHIP_QUERY.alias+" ON "+this.AUTHOR_USER_RELATIONSHIP_QUERY.on.join(" AND ")+" WHERE "+this.where.join(" AND ")+(this.orderBy.length?" ORDER BY "+this.orderBy:"")}};return n.AUTHOR_USER_RELATIONSHIP_QUERY={query:fr(i,t,!1),alias:"AUTHOR_USER_RELATIONSHIP",on:[n.alias+"."+i.SCHEMAS.account.primaryKey+" = AUTHOR_USER_RELATIONSHIP."+i.SCHEMAS.account.primaryKey,"NOT ISNULL(AUTHOR_USER_RELATIONSHIP.relationship)"]},s&&(n.select.push("FIND_IN_SET("+n.alias+"."+i.SCHEMAS.account.primaryKey+', "'+s.join(",")+'") AS priority'),n.orderBy.push("priority DESC")),r&&n.where.push('AUTHOR_USER_RELATIONSHIP.relationship in ("'+r.join('", "')+'")'),n}static getAccessesDoc(e,t,r,s=null,i=null,n=!1,a=!1){if(s&&i)throw new Error("UAC queries must be either over an object and its author (argument #2), or as related to a specific user (argument #3). But not both!");var o=new lr(e,tableName,t);o.AUTHOR_USER_RELATIONSHIP_QUERY&&o.AUTHOR_USER_RELATIONSHIP_QUERY.on.push("NOT ISNULL(AUTHOR_USER_RELATIONSHIP.relationship)"),s?o.where.push(o.schema.primaryKey+" = "+s):o.schema.attributionKey&&i&&(o.where.push(o.schema.attributionKey+" = "+i),o.limit=1),r=r.length&&"*"!==r?$(r):dr.standardAccesses;var h=[],c={},l=n?Object.keys(o.schema.fields):[];if(r.forEach(e=>{h.push('JSON_OBJECT("'+e+'", COALESCE('+lr.deriveEntityAccess(e,a)+"))"),T(lr.deriveFieldsAccess(l,e,a),(t,r)=>{c[t]||(c[t]=[]),c[t].push('JSON_OBJECT("'+e+'", '+r+")")})}),r.length>1?o.select.push("JSON_MERGE("+h.join(", ")+") AS uac"):o.select.push(h.join(", ")+" AS uac"),c.length){var u=[];T(c,(e,t)=>{r.length>1?u.push('JSON_OBJECT("'+e+'", JSON_MERGE('+t.join(", ")+"))"):u.push('JSON_OBJECT("'+e+'", '+t.join(", ")+")")}),o.select.push("JSON_MERGE("+u.join(", ")+") AS fields")}return o}}dr.standardAccesses=["view","create","update","delete","stats","use"];class Er{getBase(e,t={},r=[]){r.length||(r=s(this.exprs.TABLE_REFERENCES)?this.exprs.TABLE_REFERENCES:[this.exprs.TABLE_REFERENCES]);var i=(r=r.concat(this.exprs.JOIN_CLAUSE||[]).map(r=>r.eval(e,t))).shift();return new cr(i,r,this.exprs.WHERE_CLAUSE,t)}getToString(e,t){var r=e.t||0,i=(e=0,t=!0)=>t?"\r\n"+"\t".repeat(Math.max(0,r+e)):"",n={...e};n.t=r+1;var a=[];return T(this.exprs,(e,r,o)=>{if(r||!(o>0)){var h=null;if("JOIN_CLAUSE"===e){var c=this.clauses[e];h=r.map((e,t)=>c[t].toString().toUpperCase()+" "+e.stringify(n)).join(i())}else{c=this.clauses[e].toString().toUpperCase();"TABLE_REFERENCES"===e?h=c+" "+(s(r)?r.map(e=>e.stringify(n)).join(", "):r.stringify(n)):t&&(h=t(e,r,c,n,i))||(h=s(r)?r.map(e=>_isFunction(e.stringify)?e.stringify(n):r).join(", "):c+" "+r.stringify(n))}h||0!==o||(h=c),h&&a.push(i()+h)}}),a.join("")+i(-1)}static getParse(e,t,r,i,n,a,o=null){var h=z.lex(e,Object.values(r),{useRegex:"i"});if(h.matches.length){var c={},l={},u={},p={},f=[];h.matches.forEach((e,s)=>{var n=vt(r,t=>e.match(new RegExp(t,"i")),!0),o=h.tokens[s+1].trim(),u=null;if("JOIN_CLAUSE"===n){((u=i(o,null,{withUac:t})).type=e.match(new RegExp("(INNER|CROSS|LEFT|RIGHT)","i")))&&(u.type=u.type[0].toLowerCase()),c[n]?(c[n].push(u),l[n].push(e)):(c[n]=[u],l[n]=[e])}else{if("TABLE_REFERENCES"===n||"USING_CLAUSE"===n){var p=z.split(o,[","]).map(e=>i(e.trim(),[ar],{withUac:t,assertTableValidity:"TABLE_REFERENCES"===n&&!h.matches.includes("USING")}));u=1===p.length?p[0]:p}else if(!a||!(u=a(n,o)))u=i(o,null,{withUac:t});"WHERE_CLAUSE"!==n||c.JOIN_CLAUSE||(c.JOIN_CLAUSE=[],l.JOIN_CLAUSE=[]),c[n]=u,l[n]=e}});const e=c.USING_CLAUSE||c.TABLE_REFERENCES;return(s(e)?e:[e]).concat((c.JOIN_CLAUSE||[]).map(e=>e.table)).forEach((e,t)=>{var r=e.getAlias(),s=e.getSchema();u[r]=e,p[r]=s,0===t&&(u[""]=u[r],p[""]=p[r])}),T(c,(e,t)=>{$(t,!1).reduce((e,t)=>e.concat(t.meta.vars).concat(t.meta.varsUnlodged),[]).forEach(t=>{if("CONTEXT"!==t.role&&f.push(t),"CONTEXT"!==t.role&&!y(t,_)){var r,s;if(y(t,Nt)){if(Wt.isIncoming(t+""))return void(t.context?u[t.context+""].associateReference(t):(t.interpreted=i(u[""].getAlias()+"."+t,[dt]),u[""].associateReference(t)));r=t.name.split("~>")[0].replace(/`/g,"")}else r=t.name.replace(/`/g,"");if(t.context){if(s=t.context.name.replace(/`/g,""),(!p[s]||"*"!==r&&!(r in p[s].fields))&&!1!==n.validation)throw new Error('"'+t+'" in '+e.replace(/_/g," ")+" is unknown!");"*"===r&&(t.interpreted=Object.keys(p[s].fields).map(e=>i(s+"."+e,[dt])))}else if("*"===r){var a;if(s=u[""].getAlias(),(a=Object.keys(p[""].fields))&&!a.length)throw new Error('The wildcard column specifier (*) cannot used on table "'+s+'"; table defines no columns.');t.interpreted=a.map(e=>i(s+"."+e,[dt]))}else if(!o||!o(r,e)){if(!(s=Object.keys(p).filter(e=>e).reduce((s,i)=>{if(r in p[i].fields){if(s){if(!1!==n.validation)throw new Error('"'+t+'" in '+e.replace(/_/g," ")+" is ambiguous!");return s}return i}},null))){if(!1!==n.validation)throw new Error('"'+t+'" in '+e.replace(/_/g," ")+" is unknown!");s=u[""].getAlias()}t.interpreted=i(s+"."+t,[dt])}u[s||""].associateReference(t)}})}),T(u,(e,r)=>{if(e){var s,a=r.getName();if(n.withUac&&!r.isDerivedQuery()&&(r.interpreted=i("("+dr.select(n,p[e],null,r.getAssociateReferences().map(e=>e.name))+") AS "+(e||a),[ar],{withUac:!1})),(s=r.getAssociateReferences().filter(e=>y(e,Nt))).length){var o={},h=[],c=r.getAssociateReferences().filter(e=>!y(e,Nt)).map(e=>a+"."+e.name);s.forEach(t=>{var r=t.process(p[e],n.DB_FACTORY),s=r.b.table.name+"__by__"+r.b.actingKey;o[s]||(o[s]=r),c.push(s+"."+r.b.select+" AS `"+t.name.replace(/`/g,"")+"`")}),T(o,(e,t)=>{h.push("LEFT JOIN "+t.b.table.name+" AS "+e+" ON "+e+"."+t.b.actingKey+" = "+a+"."+t.a.actingKey)});var l="(SELECT"+(t?" WITH UAC":"")+" "+W(c).join(", ")+" FROM "+a+" "+h.join(" ")+") AS "+r.getAlias();(r.interpreted||r).interpreted=i(l,[ar],{withUac:t})}}}),{exprs:c,clauses:l,tables:u,schemas:p,vars:f}}}}class yr extends(Et(Er,Mt)){constructor(e,t,r){super(),this.exprs=e,this.clauses=t,this.withUac=r}async eval(e,t={}){var r,i=this.exprs.TABLE_REFERENCES;this.exprs.DELETE_LIST.length?r=this.exprs.DELETE_LIST.map(e=>e.endsWith(".*")?D(e,".*"):e):this.exprs.USING_CLAUSE?(r=$(this.exprs.TABLE_REFERENCES,!1).map(e=>e.getAlias()),i=this.exprs.USING_CLAUSE):r=[(s(i)?i[0]:i).getAlias()];var n={...t};n.mode="readwrite",this.base=this.getBase(e,n,$(i,!1));var a,o={},h={},c=await Promise.all(this.base.joins.concat(this.base.main));for(r.forEach(e=>{if(o[e]=c.filter(t=>(t.params.alias||t.name)===e)[0],!o[e])throw new Error('"'+e+'" in table list is not found in main query.')});a=await this.base.fetch();)r.forEach(e=>{h[e]||(h[e]=[]);var t=$(o[e].schema.primaryKey).map(t=>a[e][t]);h[e].filter(e=>Ft(e,(e,r)=>e===t[r])).length||h[e].push(t)});var l=await Promise.all(r.map(e=>{if(h[e].length)return o[e].deleteAll(h[e])}));return{tables:c.map(e=>e.name),keys:l}}toString(){return this.stringify()}stringify(e={}){return this.getToString(e)}static parse(e,t,r={}){if("delete"===e.trim().substr(0,6).toLowerCase()){var s=!1;e.match(/DELETE[ ]+WITH[ ]+UAC/i)&&(s=!0,e=e.replace(/[ ]+WITH[ ]+UAC/i,""));var i=super.getParse(e,s,this.clauses,t,r,(e,t)=>{if("DELETE_LIST"===e)return t.split(",").map(e=>e.trim()).filter(e=>e)});if(i.exprs.DELETE_LIST.length&&i.exprs.USING_CLAUSE)throw new Error('The "using" keyword cannot be used in a query with explicitly-listed tables.');return new this(i.exprs,i.clauses,s)}}}yr.clauses={DELETE_LIST:"DELETE",TABLE_REFERENCES:"FROM",USING_CLAUSE:"USING",WHERE_CLAUSE:"WHERE",JOIN_CLAUSE:"(INNER[ ]+|CROSS[ ]+|(LEFT|RIGHT)([ ]+OUTER)?[ ]+)?JOIN"};const vr=class extends A{};Object.defineProperty(vr.prototype,"jsenType",{get:()=>"FieldExpression"});var Sr=vr;class Tr extends Sr{constructor(e,t,r=!1){super(),this.expr=e,this.alias=t,this.claused=r}as(e){return this.alias=e,this.claused=!0,this}getContextName(){return this.expr.interpreted?s(this.expr.interpreted)?this.expr.interpreted[0].context.name:this.expr.interpreted.context.name:this.expr.context?(this.expr.context.name||"").replace(/`/g,""):""}getName(){return(this.expr.name||"").replace(/`/g,"")}getAlias(){return(this.alias||"").replace(/`/g,"")||this.getName()||this.expr.toString()}getCallExprs(){return this.expr.meta.vars.slice().concat([this.expr]).filter(e=>e instanceof _)}getAggrExprs(){return this.expr.meta.vars.slice().concat([this.expr]).filter(e=>e instanceof Tt)}eval(e,t,r={}){var s,i=this.getAlias();if(y(this.expr,x)){if("*"===this.getName()){var n=this.expr.getEval(e,r);return T(n,(e,t)=>{"readwrite"===r.mode?Object.defineProperty(n,e,{get:()=>t.get(),set:e=>(t.set(e),!0),enumerable:!0}):n[e]=t.get()}),n}var a=this.expr.getEval(e,r);return"readwrite"===r.mode?{get[i](){return a.get()},set[i](e){return a.set(e),!0}}:Ht(i,a.get())}return s=this.expr instanceof ee?this.expr.eval(t,r):this.expr.eval(e,r),"readwrite"===r.mode?{get[i](){return s},set[i](e){throw new Error('"'+i+'" cannot be modified; not a reference!')}}:Ht(i,s)}stringify(e={}){return[this.expr.stringify(e),this.claused?"AS":"",this.alias].filter(e=>e).join(" ")}static parse(e,t,r={}){var s=z.split(e,[" (as )?"],{useRegex:"i",preserveDelims:!0}),i=null,n=s.pop().trim(),a="as "===n.substr(0,3).toLowerCase();if(a)n=n.substr(3).trim(),i=t(s.join("").trim());else if(s.length&&(!n.match(/[^0-9a-zA-Z_]/)||G(n,"`","`")))try{i=t(s.join("").trim())}catch(e){}return i||(n=null,i=t(e)),i.isFieldName=!0,new this(i,n,a)}}const wr=class extends A{};Object.defineProperty(wr.prototype,"jsenType",{get:()=>"GroupByExpression"});var Or=wr;class Ar extends Or{constructor(e,t=null,r=!1){super(),this.columns=e,this.having=t,this.withRollup=r}eval(e,t={}){var r=(e,s,i)=>{if(s.length){var n={};e.forEach(e=>{var r=s[0].eval(e,t);n[r]=n[r]||[],n[r].push(e)}),Object.values(n).map(e=>r(e,s.slice(1),i))}if(!s.length||this.withRollup){var a=new hr(t);return wt(a,e[0]),a.$=Ee(a.$),a.AGGR={rows:e,by:s},a.AGGR.isRollup=s.length&&this.withRollup,a.AGGR.isRollup&&s.forEach(e=>{(e=e.stringify().indexOf(".")>-1?k(e.stringify(),"."):e.stringify())in a.$&&(a.$[e]=null)}),i.push(a),a}},s=[];return r(e,this.columns.slice(),s),s}toString(){return this.stringify()}stringify(e={}){var t=[this.columns.map(t=>t.stringify(e)).join(", ")];return this.withRollup&&t.push("WITH ROLLUP"),this.having&&t.push("HAVING "+this.having.stringify(e)),t.join(" ")}static parse(e,t,r={}){var s=z.lex(e,["WITH[ ]+ROLLUP","HAVING"],{useRegex:"i"}),i=z.split(s.tokens.shift().trim(),[","]).map(e=>t(e.trim())),n=null,a=!1;return s.matches.forEach(e=>{e.toLowerCase().startsWith("with")?(a=!0,s.tokens.shift()):e.toLowerCase().startsWith("having")&&(n=t(s.tokens.shift().trim()))}),new this(i,n,a)}}const Cr=class extends I{};Object.defineProperty(Cr.prototype,"jsenType",{get:()=>"InsertStatement"});var xr=Cr;class Rr extends xr{constructor(e,t,r,s,i,n,a){super(),this.TABLE_REFERENCES=e,this.COLUMNS_LIST=t,this.VALUES_LIST=r,this.WITH_UAC=s,this.IGNORE=i,this.INSERT_TYPE=n,this.UPDATE_CLAUSE=a}async eval(e,t={}){var r={...t};r.mode="readwrite";var s=await this.TABLE_REFERENCES.eval(e,r),i=s.schema,n=this.VALUES_LIST,a=this.INSERT_TYPE.toUpperCase(),o="TABLE"===a;if("SET"===a){var h=n.map(e=>e.reference.name);n=[n.map(e=>e.val.eval({},t))]}else{h=this.COLUMNS_LIST||(i.fields?Object.keys(i.fields):[]);if("SELECT"===a)try{n=(await n.eval(e,t)).map(e=>Object.values(e))}catch(e){throw new Error('["'+n.stringify()+'" in SELECT clause]: '+e.message)}else{if("VALUES"!==a)throw new Error('Invalid insert statement "'+this+'"!');n=n.map(e=>e.map(e=>e.eval({},t)))}}h=h.map(e=>e+"");var c=this.UPDATE_CLAUSE?e=>(this.UPDATE_CLAUSE.forEach(r=>r.eval({$:e},t)),!0):this.IGNORE?()=>!1:null,l=await s.addAll(n,h,c,o);return{table:s.name,keys:l}}toString(){return this.stringify()}stringify(e={}){var t=e.t||0,r=(e=0)=>"\r\n"+"\t".repeat(Math.max(0,t+e)),s={...e};s.t=t+1;var i=[this.TABLE_REFERENCES.stringify(s)];return"SET"===this.INSERT_TYPE.toUpperCase()?i.push(r(1)+"SET "+this.VALUES_LIST.map(e=>e.stringify(s)).join(", ")):(this.COLUMNS_LIST.length&&i.push("("+this.COLUMNS_LIST.join(", ")+")"),"SELECT"===this.INSERT_TYPE.toUpperCase()?i.push(this.VALUES_LIST.stringify(s)):i.push(r()+"VALUES "+r(1)+"("+this.VALUES_LIST.map(e=>e.map(e=>e.stringify(s)).join(", ")).join("),"+r(1)+"(")+")")),this.UPDATE_CLAUSE&&i.push(r()+"ON DUPLICATE KEY UPDATE "+this.UPDATE_CLAUSE.map(e=>e.stringify(s)).join(", ")),"INSERT "+(this.IGNORE?"IGNORE ":"")+"INTO "+i.join(" ")}static parse(e,t,r={}){if(e.trim().match(/^INSERT([ ]+WITH[ ]+UAC)?([ ]+IGNORE)?([ ]+INTO)?/,"i")){var s=!1,i=!1;e.match(/INSERT[ ]+WITH[ ]+UAC/i)&&(s=!0,e=e.replace(/[ ]+WITH[ ]+UAC/i,"")),e.match(/INSERT[ ]+IGNORE/i)&&(i=!0,e=e.replace(/[ ]+IGNORE/i,""));var n=z.lex(e,Object.values(Rr.clauses),{useRegex:"i"});n.tokens.shift();var a=n.tokens.shift().trim(),o=[],h=n.tokens.shift(),c=n.matches[1].toUpperCase();if("SET"===c)a=t(a,[ar]),h=z.split(h.trim(),[","]).map(e=>t(e.trim(),[de]));else{var l=z.split(a,[" "]);a=t(l.shift().trim(),[ar]),l.length&&(o=l[0].trim(),o=z.split(G(o,"(",")")?K(o,"(",")"):o,[","]).map(e=>e.trim())),h="SELECT"===c?t("SELECT "+h.trim()):z.split(h.trim(),[","]).map(e=>z.split(K(e.trim(),"(",")"),[","]).map(e=>t(e.trim())))}var u=n.tokens.shift();u&&(u=z.split(u.trim(),[","]).map(e=>t(e.trim(),[de])));var p=new this(a,o,h,s,i,c,u);return p.parseCallback=t,p}}}Rr.clauses={TABLE_REFERENCES:"INSERT([ ]+IGNORE)?([ ]+INTO)?",VALUES_LIST:"(VALUES|VALUE|SET|SELECT)",UPDATE_CLAUSE:"ON[ ]+DUPLICATE[ ]+KEY[ ]+UPDATE"};const _r=class extends A{};Object.defineProperty(_r.prototype,"jsenType",{get:()=>"JoinConstruct"});var Ir=_r;class Lr extends Ir{constructor(e,t,r){super(),this.table=e,this.condition=t,this.conditionClause=r}eval(e,t={}){return this.table.eval(e,t).then(e=>(e.join={type:this.type,condition:this.condition,conditionClause:this.conditionClause},e))}getName(){return this.table.getName()}getAlias(){return this.table.getAlias()}toString(){return this.stringify()}stringify(e={}){return[this.table.stringify(e),this.conditionClause,this.condition.stringify(e)].join("")}static parse(e,t,r={}){var s=z.lex(e,Lr.clauses);if(2===s.tokens.length){var i=s.matches[0];return new this(t(s.tokens[0],[ar]),"USING"===i.trim().toUpperCase()?t(s.tokens[1],[Kt]):t(s.tokens[1]),i)}}}Lr.clauses=[" on "," using "," ON "," USING "];const br=class extends A{};Object.defineProperty(br.prototype,"jsenType",{get:()=>"Placeholder"});var Nr=br;const Ur=class extends I{};Object.defineProperty(Ur.prototype,"jsenType",{get:()=>"SelectStatement"});var jr=Ur;class Pr extends(Et(Er,jr)){constructor(e,t,r=!1,s=[],i=[]){super(),this.exprs=e,this.clauses=t,this.withUac=r,this.flags=s,this.vars=i}getFields(e=!1){return this.exprs.SELECT_LIST}getTable(){return this.exprs.TABLE_REFERENCES}getSources(e=!1){var t=this.getJoins()||[];return $(this.exprs.TABLE_REFERENCES,!1).concat(e?t.map(e=>e.table):t)}getWhere(){return this.exprs.WHERE_CLAUSE}getJoins(){return this.exprs.JOIN_CLAUSE}getGroupBy(){return this.exprs.GROUP_BY_CLAUSE}getWindows(){return this.exprs.WINDOWS_CLAUSE}getOrderBy(){return this.exprs.ORDER_BY_CLAUSE}getOffset(){return this.exprs.OFFSET_CLAUSE}getLimit(){return this.exprs.LIMIT_CLAUSE}async eval(e,t={}){this.base=this.getBase(e,t);for(var r,s=[];r=await this.base.fetch();)s.push(r);var i=(r,s,i=null)=>(i&&(i={aggr:[],win:[]}),r.forEach(r=>{r.$||(r.$={}),s.forEach(s=>{if(i){var n=s.getAggrExprs();if(n.length)return l(n.filter(e=>e.window).length?i.win:i.aggr,s),void(s.getAlias()in r.$||(r.$[s.getAlias()]=void 0))}var a=s.eval(r,e,t);Object.keys(a).forEach(e=>{Object.defineProperty(r.$,e,Object.getOwnPropertyDescriptor(a,e))})})}),i),n={aggr:[],win:[]};this.vars.forEach(e=>{y(e,Tt)&&l(e.window?n.win:n.aggr,e)});var a=i(s,this.getFields(),!0);if(this.exprs.GROUP_BY_CLAUSE||n.aggr.length){var o=this.exprs.GROUP_BY_CLAUSE||new Ar([]);i(s=o.eval(s,t),a.aggr)}if(this.exprs.WINDOWS_CLAUSE||n.win.length){var h=[];n.win.forEach(e=>{var r=e.window.stringify();-1===h.indexOf(r)&&(e.window.eval(s,this.exprs.WINDOWS_CLAUSE,t),h.push(r))}),i(s,a.win)}if(this.exprs.ORDER_BY_CLAUSE&&(s=this.exprs.ORDER_BY_CLAUSE.eval(s,t)),this.flags.includes("DISTINCT")&&(s=s.filter((e,t)=>t===vt(s,t=>_even(t,e)))),this.exprs.OFFSET_CLAUSE||this.exprs.LIMIT_CLAUSE){var c=this.exprs.LIMIT_CLAUSE?this.exprs.LIMIT_CLAUSE.slice():[],u=this.exprs.OFFSET_CLAUSE||(2===c.length?c.shift():0);s=c.length?s.slice(u,u+c[0]):s.slice(u)}return s.map(e=>e.$)}toString(){return this.stringify()}stringify(e={}){return this.getToString(e,(e,t,r,s)=>"SELECT_LIST"===e?r+" "+(this.flags.length?" "+this.flags.join(" "):"")+t.map(e=>e.stringify(s)).join(", "):"WINDOWS_CLAUSE"===e?r+" "+Object.keys(t).map(e=>e+" AS "+t[e].stringify(s)).join(", "):"GROUP_BY_CLAUSE"===e||"ORDER_BY_CLAUSE"===e?r+" "+t.stringify(s):"LIMIT_CLAUSE"===e?r+" "+t.join(", "):void 0)}static parse(e,t,r={}){if("select"===e.trim().substr(0,6).toLowerCase()){var s=!1;e.match(/SELECT[ ]+WITH[ ]+UAC/i)&&(s=!0,e=e.replace(/[ ]+WITH[ ]+UAC/i,""));var i=[],n=super.getParse(e,s,this.clauses,t,r,(e,r)=>{if("SELECT_LIST"===e)return z.split(r,[","]).map(e=>{e=t(e.trim(),[Tr]);return i.push(e.getAlias()),e});if("WINDOWS_CLAUSE"===e){var s={};return z.split(r,[","]).forEach(e=>{var r=e.split(new RegExp(" as ","i"));s[r[0].trim()]=t(r[1].trim(),[_t])}),s}return"GROUP_BY_CLAUSE"===e?t(r,[Ar]):"ORDER_BY_CLAUSE"===e?t(r,[Rt]):"LIMIT_CLAUSE"===e?r.split(",").map(e=>parseInt(e)):void 0},(e,t)=>("ORDER_BY_CLAUSE"===t||"GROUP_BY_CLAUSE"===t)&&i.includes(e));return new this(n.exprs,n.clauses,s,n.clauses.SELECT_LIST.replace(/SELECT/i,"").split(" ").filter(e=>e),n.vars)}}}Pr.clauses={SELECT_LIST:"SELECT([ ]+(ALL|DISTINCT))?",TABLE_REFERENCES:"FROM",WHERE_CLAUSE:"WHERE",JOIN_CLAUSE:"(INNER[ ]+|CROSS[ ]+|(LEFT|RIGHT)([ ]+OUTER)?[ ]+)?JOIN",GROUP_BY_CLAUSE:"GROUP[ ]+BY",WINDOWS_CLAUSE:"WINDOW",ORDER_BY_CLAUSE:"ORDER[ ]+BY",OFFSET_CLAUSE:"OFFSET",LIMIT_CLAUSE:"LIMIT"};const kr=class extends A{};Object.defineProperty(kr.prototype,"jsenType",{get:()=>"UnionConstruct"});var Dr=kr;const Wr=class extends I{};Object.defineProperty(Wr.prototype,"jsenType",{get:()=>"UpdateStatement"});var Fr=Wr;class Br extends(Et(Er,Fr)){constructor(e,t,r){super(),this.exprs=e,this.clauses=t,this.withUac=r}async eval(e,t={}){var r,s={...t};for(s.mode="readwrite",this.base=this.getBase(e,s);r=await this.base.fetch();)this.exprs.ASSIGNMENT_LIST.forEach(e=>e.eval(r,t));var i=await this.base.syncCursors();return{tables:await Promise.all(this.base.joins.concat(this.base.main)).then(e=>e.map(e=>e.name)),keys:i}}toString(){return this.stringify()}stringify(e={}){return this.getToString(e,(e,t,r,s,i)=>{if("ASSIGNMENT_LIST"===e)return r+" "+t.map(e=>e.stringify(s)).join(", ")})}static parse(e,t,r={}){if("update"===e.trim().substr(0,6).toLowerCase()){var s=!1;e.match(/UPDATE[ ]+WITH[ ]+UAC/i)&&(s=!0,e=e.replace(/[ ]+WITH[ ]+UAC/i,""));var i=super.getParse(e,s,this.clauses,t,r,(e,r)=>{if("ASSIGNMENT_LIST"===e)return z.split(r,[","]).map(e=>t(e.trim(),[de]))});return new this(i.exprs,i.clauses,s)}}}Br.clauses={TABLE_REFERENCES:"UPDATE",ASSIGNMENT_LIST:"SET",WHERE_CLAUSE:"WHERE",JOIN_CLAUSE:"(INNER[ ]+|CROSS[ ]+|(LEFT|RIGHT)([ ]+OUTER)?[ ]+)?JOIN"},ft.grammars={Union:class extends Dr{constructor(e,t,r=null,s=null){super(),this.query=e,this.queries=t,this.orderBy=r,this.limit=s}toString(){return this.stringify()}stringify(e={}){var t=[[this.query.stringify(e)].concat(this.queries.map(t=>(t.onDuplicate?t.onDuplicate.toUpperCase()+" ":"")+t.select.stringify(e))).join(" UNION ")];return this.orderBy&&t.push("ORDER BY "+this.orderBy.stringify(e)),this.limit&&t.push("LIMIT "+this.limit.join(", ")),t.join(" ")}static parse(e,t,r={}){var s,i={useRegex:"i"};if((s=z.lex(e,[" UNION([ ]+(ALL|DISTINCT))? "],i))&&s.matches.length){var n=s.tokens,a=s.matches,o=null,h=null;if(n[0].trim().startsWith("(")){var c=z.lex(n.pop(),["ORDER[ ]+BY","LIMIT"],i);n.push(c.tokens.shift()),c.matches.forEach(e=>{var r=c.tokens.shift().trim();e.toUpperCase().startsWith("ORDER")?o=t(r,[Rt]):e.toUpperCase().startsWith("LIMIT")&&(h=r.split(",").map(e=>parseInt(e)))})}return new this(t(n.shift().trim()),n.map((e,r)=>({select:t(e.trim()),onDuplicate:(a[r].match(new RegExp("ALL|DISTINCT","i"))||[])[0]})),o,h)}}},Select:Pr,Insert:Rr,Update:Br,Delete:yr,Join:Lr,Abstraction:te,Condition:class extends je{constructor(e,t,r){super(),this.assertion=e,this.onTrue=t,this.onFalse=r}toString(){return this.stringify()}stringify(e={}){return"IF ("+[this.assertion.stringify(e),this.onTrue.stringify(e),this.onFalse.stringify(e)].join(", ")+")"}static parse(e,t,r={}){if(e.match(/^if[ ]*?\(/i)){var s=z.split(K(e.trim().substr(2).trim(),"(",")"),[","]);if(3!==s.length)throw new Error("Malformed condition expression: "+e+"!");return new this(...s.map(e=>t(e.trim())))}}},Assertion:mt,Comparison:gt,Math:$e,Num:Qe,Str:ht,Bool:Re,Void:ut,Aggr:It,Call:_e,Placeholder:class extends Nr{constructor(e,t){super(),this.name=c(e)?parseInt(e):e,this.notation=t}eval(e,t={}){if("number"==typeof this.name){if(!t.vars)throw new Error('Annonymous placeholders require a "params.vars" array to be resolved.');return t.vars[this.name]}if(!t.vars)throw new Error('Named placeholders require a "params.vars" object to be resolved.');return t.vars[this.name]}toString(){return this.stringify()}stringify(e={}){return"?"===this.notation?"?":this.notation+this.name}static parse(e,t,r={}){if(e.startsWith("?")||e.startsWith(":"))return new this(e.substr(1),e.substr(0,1))}},ArrowReference:Wt,ArrowReference:Wt,Reference:dt};var Mr=ft;window.WN||(window.WN={}),window.WN.Rql=Mr,window.WebNative||(window.WebNative={}),window.WebNative.Rql=Mr}]);
//# sourceMappingURL=main.js.map