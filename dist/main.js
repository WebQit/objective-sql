!function(e){var t={};function r(s){if(t[s])return t[s].exports;var i=t[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=e,r.c=t,r.d=function(e,t,s){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(s,i,function(t){return e[t]}.bind(null,i));return s},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";r.r(t);var s=function(e){return Array.isArray(e)},i=function(e){return!Array.isArray(e)&&"object"==typeof e&&e},n=function(e){return e instanceof String||"string"==typeof e&&null!==e},a=function(e){return arguments.length&&(void 0===e||void 0===e)},o=function(e){return null===e||""===e},h=function(e){return"function"==typeof e},c=function(e){return Array.isArray(e)||"object"==typeof e&&e||h(e)},l=function(e){return o(e)||a(e)||!1===e||0===e||c(e)&&!Object.keys(e).length},u=function(e,t=!0){return s(e)?e:!t&&i(e)?[e]:!1!==e&&0!==e&&l(e)?[]:function(e){return!n(e)&&!a(e.length)}(e)?Array.prototype.slice.call(e):i(e)?Object.values(e):[e]},p=function(e){return e instanceof Number||"number"==typeof e},f=function(e){return p(e)||!0!==e&&!1!==e&&null!==e&&""!==e&&!isNaN(1*e)},m=function(e,t){var r=void 0;return c(e)&&Object.keys(e).forEach((s,i)=>{!1!==r&&(r=t(f(s)?parseFloat(s):s,e[s],i))}),r};class g{constructor(e,t={}){this.database=e,this.schema=t,this.name=e.name}async has(e){return(await this.list()).includes(e)}async create(e,t,r=null){if(await this.has(e)){if(!r)throw new Error('Table "'+e+'" already exists.');"drop"===r&&await this.drop(e)}return t.name=e,d(this.schema,[t],r),await this._create(e,t,r)}async drop(e){if(!await this.has(e))throw new Error('Table "'+e+'" has not been defined.');return delete this.schema[e],await this._drop(e)}}const d=(e,t,r)=>t.map(t=>{if(E(t),e[t.name]&&!r)throw new Error('Store name "'+t.name+'" already exists!');e[t.name]&&"drop"!==r||(e[t.name]=t)}),E=e=>{if(!i(e))throw new Error("Table definition must be an object.");if(!e.name)throw new Error("Table must have a name.");if(e.autoIncrement){if(!e.primaryKey)throw new Error("The Auto-Increment directive cannot be used without a Primary Key.");if(u(e.primaryKey).length>1)throw new Error("The Auto-Increment directive cannot be used with a composite Primary Key.")}if(!i(e.fields))throw new Error('Table must have a valid "fields" list.');m(e.fields,(t,r)=>{if(!i(r))throw new Error('Invalid field definition: "'+t+'" at "'+e.name+'".');if(r.referencedEntity&&(!i(r.referencedEntity)||!r.referencedEntity.name))throw new Error('Invalid foreign key definition: "'+t+'" at "'+e.name+'".')})};class y{static async query(e,...t){var r,i;return s(t[0])&&(i=t.shift()),r=t.shift()||{},i&&(r.vars=i),this._query(e,r)}static async has(e=this.defaultDB){return(await this.list()).filter(t=>t.name===e).length>0}static async create(e=this.defaultDB,t=[],r=null){var s=await this.list(),n=u(s).filter(t=>t.name===e).map(e=>e.version);if(n.length){if(!r)throw new Error('Database "'+e+'" already exists at versions: '+n.join(",")+"!");"drop"===r&&await this.drop(e)}return this.schema[e]&&"drop"!==r||(this.schema[e]={}),Object.keys(t||{}).length&&(i(t)&&(m(t,(e,t)=>{t.name=e}),t=Object.values(t)),d(this.schema[e],t,r)),await this._create(e,t,r)}static async drop(e=this.defaultDB){if(!await this.has(e))throw new Error('Database "'+e+'" has not been defined.');return delete this.schema[e],await this._drop(e)}static async import(e,t,r=null){var s=await this.create(e,t.schema,r);return Promise.all(Object.keys(t.data||{}).map(async e=>(await s.open(e,"readwrite")).addAll(t.data[e])))}static async export(e,...t){var r=await this.open(e,...t),s={schema:r.schema,data:{}},i=await r.list();return await Promise.all(i.map(async e=>{var t=await r.open(e);s.data[e]=await t.getAll()})),s}}y.schema={},y.defaultDB="db1";const v=(e=null,t=null)=>e&&(e.prototype instanceof y||e===y)?e.schema[t||e.defaultDB]:!t&&e?e:void 0;var S=function(e){return h(e)||e&&"[object function]"==={}.toString.call(e)},w=function(e,...t){return t.forEach(t=>{e.indexOf(t)<0&&e.push(t)}),e},T=function(e,t){t=(t=t||Object.prototype)&&!s(t)?[t]:t;var r=[];for(e=e;e&&(!t||t.indexOf(e)<0)&&"default"!==e.name;)r.push(e),e=e?Object.getPrototypeOf(e):null;return r};function O(e,t,r=!1,n=!1,a=!1){var o=0,h=e.shift();if((f(h)||!0===h||!1===h)&&(o=h,h=e.shift()),!e.length)throw new Error("_merge() requires two or more array/objects.");return e.forEach((e,l)=>{var u,p,m;(c(e)||S(e))&&(r?(u=e,m=[],T(u,p).forEach(e=>{w(m,...Object.getOwnPropertyNames(e))}),m):Object.getOwnPropertyNames(e)).forEach(c=>{if(t(c,h,e,l)){var u=h[c],p=e[c];if((s(u)&&s(p)||i(u)&&i(p))&&(!0===o||o>0))h[c]=s(u)&&s(p)?[]:{},O([f(o)?o-1:o,h[c],u,p],t,r,n,a);else if(s(h)&&s(e))n?h[c]=p:h.push(p);else try{a?Object.defineProperty(h,c,Object.getOwnPropertyDescriptor(e,c)):h[c]=e[c]}catch(e){}}})}),h}var C=function(...e){return O(e,(e,t,r)=>!0,!1,!1,!1)},_=class extends Error{},A=function(e,t,r=null){return s(t)?e.filter(e=>r?t.filter(t=>r(e,t)).length:-1!==t.indexOf(e)):[]},x=function(e,t){return e.reduce((e,r,s)=>e&&t(r,s),!0)},R=function(e,t,r){return e.startsWith(t)&&e.endsWith(r)};class I{constructor(e,t,r={},s={}){this.store=e,this.name=t,this.schema=l(r)?{name:e.name,primaryKey:"",fields:{},uniqueKeys:{}}:r,this.params=s}async syncCursor(e){return await this.putAll(e.cache)}async match(e){var t,r,s;return this.schema.primaryKey&&(t=b(e,this.schema.primaryKey))&&(r=await this.get(t))?{matchingKey:"PRIMARY_KEY",primaryKey:t,row:r}:(this.schema.uniqueKeys&&(await this.getAll()).forEach((t,r)=>{s||m(this.schema.uniqueKeys,(i,n)=>{t&&b(e,n)===b(t,n)&&(s={matchingKey:i,primaryKey:this.schema.primaryKey?b(t,this.schema.primaryKey):r,row:{...t}})})}),s)}async addAll(e,t=[],r=null,s=!1){var n,a=[],o=await Promise.all(e.map(async(e,s)=>{var o={};if(i(e))o=e;else{var h=t.length?t:Object.keys(this.schema.fields);if(h.length&&h.length!==e.length)throw new Error("Column/values count mismatch at line "+s+"!");h.forEach((t,r)=>{o[t]=e[r]})}return this.handleInput(o,!0),this.shouldMatchInput(o)||r?n=new Promise(async e=>{await n;var t=await this.match(o);if(t&&r){var s={...t.row};return r(s,o)&&a.push(s),e(0)}await this.beforeAdd(o,t),e(this.add(o))}):(await this.beforeAdd(o),this.add(o))}));return a.length&&(o=o.concat(await this.putAll(a))),o}async beforeAdd(e,t){var r=(new Date).toISOString();m(this.schema.fields||{},(t,s)=>{"datetime"!==s.type&&"timestamp"!==s.type||"CURRENT_TIMESTAMP"!==s.default||(e[t]=r)})}async putAll(e){var t;return await Promise.all(e.map(async e=>(this.handleInput(e),this.shouldMatchInput(e)?t=new Promise(async r=>{await t,await this.beforePut(e,await this.match(e)),r(this.put(e))}):(await this.beforePut(e),this.put(e)))))}async beforePut(e,t){if(t&&!x(Object.keys(e),r=>e[r]===t.row[r])){var r=(new Date).toISOString();m(this.schema.fields||{},(t,s)=>{"datetime"!==s.type&&"timestamp"!==s.type||"CURRENT_TIMESTAMP"!==s.onupdate||(e[t]=r)})}}async deleteAll(e){return await Promise.all(e.map(async e=>this.delete(await this.beforeDelete(e))))}async beforeDelete(e){return e}handleInput(e,t=!1){var r=Object.keys(e),s=Object.keys(this.schema.fields),h=r.filter(e=>-1===s.indexOf(e));if(h.length)throw new Error("Unknown column: "+h[0]);s.forEach(s=>{var h=e[s],l=i(this.schema.fields[s])?this.schema.fields[s]:{};if(r.includes(s)?"json"===l.type?c(_value)||n(h)&&(R(h,"[","]")||R(h,"{","}")):["char","tinytext","smalltext","text","bigtext","varchar"].includes(l.type)?n(h):["bit","tinyint","smallint","int","bigint","decimal","number","float","real"].includes(l.type)||["enum","set"].includes(l.type)?f(h):["date","datetime","timestamp"].includes(l.type)&&n(h):t&&!A(u(s),u(this.schema.primaryKey)).length&&(e[s]=!("default"in l)||["date","datetime","timestamp"].includes(l.type)&&"CURRENT_TIMESTAMP"===l.default?null:l.default),!1===l.nullable&&(o(e[s])||a(e[s])))throw new Error("Inserting NULL on non-nullable column: "+s)})}shouldMatchInput(e){return Object.keys(this.schema.fields).filter(e=>{var t=this.schema.fields[e];return["datetime","timestamp"].includes(t.type)&&("CURRENT_TIMESTAMP"===t.default||"CURRENT_TIMESTAMP"===t.onupdate)}).length}}const b=(e,t)=>u(t).map(t=>e[t]).filter(e=>e).join("-");class L{constructor(e){this.cache=e,this.key=0,this.flags={},this._onfinish=[]}onfinish(e){this._onfinish.push(e)}next(){if(!this.cache.length||this.key===this.cache.length-1)return this.__eof=!0,this._onfinish.forEach(e=>e()),void(this.key=0);this.key++}eof(){return!this.cache.length||this.key===this.cache.length-1}async fetch(){if(this.key<this.cache.length)return this.cache[this.key]}}class N extends L{}class U extends I{constructor(e,t,r={},s={}){super(...arguments),this.ongoingWrite=null}getCursor(){return new N((this.store||[]).reduce((e,t)=>e.concat(t?{...t}:void 0),[]).filter(e=>e))}async getAll(){return(this.store||[]).reduce((e,t)=>e.concat(t?{...t}:void 0),[])}async get(e){if(!this.schema.primaryKey)throw new Error("Table must define a Primary Key to fetch an item by Primary Key.");var t=this.store;return e=u(e).join("-"),this.schema.autoIncrement?t[e-1]?{...t[e-1]}:void 0:t[e]?{...t[e]}:void 0}async count(){return this.store.length}shouldMatchInput(e){return this.schema.primaryKey||super.shouldMatchInput(e)}async beforeAdd(e,t){if(t)throw new _("Inserting duplicate values on unique key constraint: "+t.matchingKey);P(this.store,e,this.schema.primaryKey,this.schema.autoIncrement),await super.beforeAdd(e,t)}add(e){return this.ongoingWrite=new Promise(async(t,r)=>{try{await this.ongoingWrite}catch(e){}var s=this.store,i=j(e,this.schema.primaryKey);this.schema.autoIncrement?s[i-1]=e:s[i]=e,t(i)}),this.ongoingWrite}async beforePut(e,t){t?m(t.row,(t,r)=>{t in e||(e[t]=r)}):P(this.store,e,this.schema.primaryKey,this.schema.autoIncrement);await super.beforePut(e,t)}put(e){return this.ongoingWrite=new Promise(async t=>{try{await this.ongoingWrite}catch(e){}var r=this.store,s=j(e,this.schema.primaryKey);this.schema.autoIncrement?r[s-1]=e:r[s]=e,t(s)}),this.ongoingWrite}delete(e,t=!0){return this.ongoingWrite=new Promise(async(r,s)=>{try{await this.ongoingWrite}catch(e){}var i,n=this.store;if(this.schema.autoIncrement?n[e-1]&&(delete n[e-1],i=e):n[e]&&(delete n[e],i=e),!i&&t)return s(new Error("The given row (with "+u(this.schema.primaryKey).join(",")+" = "+i+") does not exist in the store."));r(i)}),this.ongoingWrite}async clear(){return this.store.splice(0),!0}}var j=(e,t)=>u(t).map(t=>e[t]).filter(e=>e).join("-");function P(e,t,r,s){if(r){var i=j(t,r);if(!i&&s){var n=u(r);if(n.length>1)throw new Error("The Auto-Increment flag cannot be used with Composite Primary Keys.");i=e.length+1,t[n[0]]=i}return i}}class k extends g{async list(){return Object.keys(this.database)}open(e,t="readonly",r={}){var s=this.database[e];return r.mode=t,new U(s,e,this.schema[e],r)}async _create(e,t,r){var s=[];return this.database[e]=s,(t||[]).length&&Object.values(t).forEach(e=>{e.driver||(e.driver="ODB")}),new U(s,this.schema[e])}async _drop(e){return delete this.database[e],!0}}var D=function(e){return i(e)&&Object.getPrototypeOf(e)===Object.prototype},B=function(e){return!0===e||!1===e};const F=function(e,t,r=!0,n=1){if(s(e)&&s(t)&&e.length!==t.length)return!r;if(i(e)&&i(t)){var a=Object.keys(e),o=Object.keys(t);if(!a.length&&!o.length)return D(e)&&D(t)?r:e===t===r;if(!F(a,o))return!r}if(n>0&&(s(e)&&s(t)||i(e)&&i(t))){var h=function(e,t,r=!0,n=!0,a=!1,o=!1){if(s(e)&&s(t)){var h=[],l=!0;return e.forEach(e=>{if(l){var u=!1;m(t,(t,a)=>{(!u||n&&c(e))&&(u=r(e,a),(s(u)&&!u.length||i(u)&&!Object.keys(u).length)&&(u=!1),c(u)&&n&&(e=u))}),c(u)?h.push(n?u:e):B(u)?a&&!u||!a&&u?h.push(e):o&&(l=!1):h.push(u)}}),h}if(i(e)&&i(t)){h={},l=!0;return Object.keys(e).forEach(u=>{if(l){var p=r(e[u],t[u]);(s(p)&&!p.length||i(p)&&!Object.keys(p).length)&&(p=!1),c(p)?h[u]=n?p:e[u]:B(p)?a&&!p||!a&&p?h[u]=e[u]:o&&(l=!1):h[u]=p}}),h}}(e,t,(e,t)=>F(e,t,r,n-1),!1,!1,!0);return s(h)?h.length===e.length&&h.length===t.length:i(h)&&i(e)?Object.keys(h).length===Object.keys(e).length&&Object.keys(h).length===Object.keys(t).length:h}return S(r)?r(e,t):p(e)&&p(t)&&isNaN(e)&&isNaN(t)?r:e===t===r};var W=F,M=class{even(e){return!(!i(e)||e.jsenType!==this.jsenType)&&W(e,this)}inherit(e){return this}withComments(e){return this.meta||(this.meta={}),this.meta.comments=e,this}withVars(e){return this.meta||(this.meta={}),this.meta.vars=e,this}};const H=class extends M{};Object.defineProperty(H.prototype,"jsenType",{get:()=>"Reference"});var G=H;const K=class extends M{};Object.defineProperty(K.prototype,"jsenType",{get:()=>"CallExpression"});var Y=K,$=class extends M{};const q=class extends M{};Object.defineProperty(q.prototype,"jsenType",{get:()=>"IfConstruct"});var Q=q,J=class extends Error{constructor(...e){super(...e),this.name="Syntax Error"}};const V={};class X{static parse(e,t,r={}){if(e.length){var s;if(V[e]&&!t&&!1!==r.allowCache)if(s=this.parseOne(e,V[e],r))return s;for(var i=Object.values(t||this.grammar),n=0;n<i.length;n++){var a=this.parseOne(e,i[n],r);if(a)return t||!1===r.allowCache||(V[e]=i[n]),a}if(!1===r.assert)return;throw new J(e)}}static parseOne(e,t,r={}){var i={reads:[],writes:[],deletes:[],calls:[],others:[],deep:[]},n=t.parse(e,(e,t,s={})=>{var n=this.parse(e,t,s?C({},r,s):r);if(n instanceof G){for(var a,o=n;o=o.context;)o instanceof Y&&(a=!0);if(n.role=s.role,!a&&"CONTEXT"!==s.role){var h="ASSIGNMENT_SPECIFIER"===s.role?"writes":"DELETION_SPECIFIER"===s.role?"deletes":"CALL_SPECIFIER"===s.role?"calls":"reads";i[h].push(n)}}else n instanceof Y&&i.others.push(n);return n&&(Object.keys(n.meta).forEach(e=>{n.meta[e].forEach(t=>i[e].push(t))}),Object.keys(n.meta.deep).forEach(e=>{i.deep[e]||(i.deep[e]=[]),n.meta.deep[e].forEach(t=>i.deep[e].push(t))})),n},r);return n&&(n.meta=n instanceof $?{reads:[],writes:[],deletes:[],calls:[],others:[],deep:[]}:i,n instanceof Y?!n.reference.context||n.reference.context instanceof Y||n.meta.reads.push(n.reference.context):n instanceof Q&&["onTrue","onFalse"].forEach(e=>{n[e]&&Object.keys({reads:[],writes:[],deletes:[],calls:[],others:[],deep:[]}).forEach(e=>{"deep"!==e&&n.onTrue.meta[e].concat(n.onTrue.meta.deep[e]||[]).forEach(t=>{!function(e,t,r=!1){for(var s=e.indexOf(t);s>-1&&(r||!1===r);)e.splice(s,1),r>0&&r--,s=e.indexOf(t)}(n.meta[e],t),n.meta.deep[e]||(n.meta.deep[e]=[]),n.meta.deep[e].push(t)})})}),s(r.explain)&&r.explain.push(e+" >>-------------\x3e> "+n.jsenType)),n}}var z=function(e,t,r=!1){if(""==t)return e;var s=r?e.lastIndexOf(t):e.indexOf(t);return-1===s?"":e.substr(s+t.length)},Z=function(e,t,r=!1){if(""==t)return e;var s=r?e.lastIndexOf(t):e.indexOf(t);return-1===s?e:e.substr(0,s)},ee=function(e,t){return Z(e,t,!0)},te=function(e,t,r){return ee(z(e,t),r)};const re=function(e,t=1,r=!0){return!f(t)||t<=0?e:(!s(e)&&i(e)&&r&&(e=Object.values(e)),s(e)?e.reduce((e,n)=>s(n)||i(n)&&r?e.concat(re(s(n)?n:Object.values(n),t-1,r)):e.concat(n),[]):e)};var se=re,ie=function(e,t=1){var r=0;e.forEach(e=>{r++});var s=e.slice(e.length-r,t);return arguments.length>1?s:s[0]},ne=function(e,t=1){return arguments.length>1?ie(e.slice().reverse(),t).reverse():ie(e.slice().reverse())},ae=function(e,t=[]){return O([{},e],(e,r,i)=>{if(!S(i[e]))return S(t)?t(e):!s(t)||!t.length||t.indexOf(e)>-1},!1,!1,!1)};class oe{static lex(e,t,r={}){if(!n(e+=""))throw new Error("Argument1 must be a string!");var s=e=>({delims:e.delims.slice(),options:ae(e.options),nesting:e.nesting.slice(),maxDepth:e.maxDepth,comments:e.comments.slice(),tokens:e.tokens.slice(),matches:e.matches.slice(),matchesi:ae(e.matchesi)});if(oe.$cache[e]&&!1!==r.cache)for(var i=0;i<oe.$cache[e].length;i++){var a=oe.$cache[e][i];if(W(a.delims,t))return s(a)}var o=new oe(e,r).lex(t);return!1!==r.cache&&(oe.$cache[e]=oe.$cache[e]||[],oe.$cache[e].push(o)),s(o)}static split(e,t,r){return oe.lex(e,t,r).tokens}static match(e,t,r){return oe.lex(e,t,r).matches}constructor(e,t){if(!n(e))throw new Error("Lexer requires the first argument to be a string.");this.$str=e,this.$options=t||{},this.$options.blocks||(this.$options.blocks=oe.$blocks),this.$options.quotes||(this.$options.quotes=oe.$quotes),this.$options.comments||(this.$options.comments=oe.$comments)}lex(e,t){for(var r={delims:u(e),options:C(!0,{},this.$options,t||{}),nesting:[],maxDepth:0,comments:[],tokens:[],matches:[],matchesi:{}},s=0;"number"==typeof s;)s=this._evalCharsAt(r,s);if(r.nesting.length)throw new Error("Error parsing the string: "+this.$str+". Unterminated blocks: "+se(r.nesting).join(", "));return r}_evalCharsAt(e,t){if(!(t>=this.$str.length)){var r=1,s={},i={},n={};if(e.openComment||(i=this._testQuotes(e,t)),e.openQuote||(s=this._testComments(e,t)),e.openComment||s.ending)if(e.nesting.length||n.ending)this._push(e,this.$str[t]);else r=(o=s.starting||s.ending||this.$str[t]).length,this._push(e,o,"comments",s.starting);else if(e.openQuote||i.ending)this._push(e,this.$str[t]);else{if(e.options.limit&&e.matches.length===e.options.limit)return this._push(e,this.$str[t]),t+1;n=this._testNesting(e,t);n=this._testNesting(e,t);var a=this._testChars(e.options.stopChars||[],e,t);if(!e.nesting.length&&!1!==a)return e.options.stopChar=a,void(e.options.stopCharForward=this.$str.substr(t));if(e.delims.length)if(e.nesting.length||n.ending){var o;r=(o=n.starting||n.ending||this.$str[t]).length,this._push(e,o)}else{this._push(e,"");var h=this._testChars(e.delims,e,t);if(!1!==h&&(e.matches.push(h),e.matchesi[t]=h,r=h.length||1,!e.options.preserveDelims)){var c=t+(h.length||1);return c===this.$str.length&&this._push(e,""),c}this._push(e,h||this.$str[t])}else 2===e.nesting.length&&n.starting?(e.matches.push(null),this._push(e,n.starting),r=n.starting.length):!e.nesting.length&&n.ending?(this._push(e,n.ending),r=n.ending.length,e.matches.push(null)):this._push(e,this.$str[t])}return t+r}}_testQuotes(e,t){var r={};return(e.options.quotes||[]).forEach(s=>{this.$str.substr(t,1)===s&&(e.openQuote?s===e.openQuote&&(e.openQuote=!1,r.ending=s):(e.openQuote=s,r.starting=s))}),r}_testComments(e,t){var r={};return(e.options.comments||[]).forEach(s=>{if(e.openComment){if(ne(s)===ne(e.openComment)){var i=ne(s);this.$str.substr(t).startsWith(i)&&(e.openComment=!1,r.ending=i)}}else{var n=ie(s);this.$str.substr(t).startsWith(n)&&(e.openComment=s,r.starting=n)}}),r}_testNesting(e,t){var r={};return(e.options.blocks||[]).forEach(s=>{var i=ie(s);if(this.$str.substr(t).startsWith(i))e.nesting=e.nesting.concat([s]),r.starting=i;else if(e.nesting.length&&ne(s)===ne(ne(e.nesting))){var n=ne(s);this.$str.substr(t).startsWith(n)&&(e.nesting=e.nesting.slice(0,-1),r.ending=n)}}),e.maxDepth=Math.max(e.maxDepth,e.nesting.length),r}_testChars(e,t,r){for(var s=0;s<e.length;s++){var i=e[s];if(S(i)){var n=i(this.$str.substr(0,r),this.$str.substr(r));if(!1!==n)return n}if(t.options.useRegex){var a=this.$str.substr(r).match(new RegExp("^"+i,!0!==t.options.useRegex?t.options.useRegex:""));if(a)return a[0]}if(!t.options.ci&&this.$str.substr(r,i.length)===i||t.options.ci&&this.$str.substr(r,i.length).toLowerCase()===i.toLowerCase())return i}return!1}_push(e,t,r="tokens",s=!1){var i=e.matches.length;if(a(e.tokens[i])&&(e.tokens[i]=""),"comments"===r){e.tokens[i].comments||(e.tokens[i]=new String(e.tokens[i]),e.tokens[i].comments=[]);var n=e.tokens[i].comments.length-(!e.tokens[i].comments.length||s?0:1);e.tokens[i].comments[n]=(e.tokens[i].comments[n]||"")+t}else{e.tokens[i].comments;e.tokens[i]=e.tokens[i]+t}}split(e,t,r){return this.lex(t,r).tokens}match(e,t,r){return this.lex(t,r).matches}regParse(e,t){return this.lex(e,C({useRegex:!0},t||{}))}regSplit(e,t){return this.regParse(e,t).tokens}regMatch(e,t){return this.regParse(e,t).matches}}oe.$blocks=[["(",")"],["[","]"],["{","}"]],oe.$quotes=['"',"'","`"],oe.$comments=[["/*","*/"],["//","\n"]],oe.$cache={};const he=class extends M{};Object.defineProperty(he.prototype,"jsenType",{get:()=>"Abstraction"});var ce=he;var le=class extends ce{constructor(e){super(),this.expr=e}eval(e=null,t={}){return this.expr.eval(e,t)}toString(){return this.stringify()}stringify(e={}){return"("+this.expr.stringify(e)+")"}static parse(e,t,r={}){if(R(e,"(",")")&&!oe.match(e,[" "]).length)return new this(t(te(e,"(",")")))}};const ue=class extends M{};Object.defineProperty(ue.prototype,"jsenType",{get:()=>"ArrayType"});var pe=ue;var fe=class extends pe{constructor(e){super(),this.exprs=e||[]}inherit(e){if(e instanceof pe){var t=e.exprs.filter(e=>this.exprs.reduce((t,r)=>t&&!e.even(r),!0));this.exprs=t.concat(this.exprs)}return this}eval(e=null,t={}){return this.exprs.map(r=>r.eval(e,t))}toString(){return this.stringify()}stringify(e={}){return"["+this.exprs.map(t=>t.stringify(e)).join(", ")+"]"}static parse(e,t,r={}){if(R(e,"[","]")&&!oe.match(e.trim(),[" "]).length)return new this(oe.split(te(e,"[","]"),[","]).map(e=>e.trim()).filter(e=>e).map(e=>t(e)))}};const me=class extends M{};Object.defineProperty(me.prototype,"jsenType",{get:()=>"Arguments"});var ge=me;var de=class extends ge{constructor(e=[]){super(),this.list=e}eval(e=null,t={}){return this.list.map(r=>r.eval(e,t))}toString(){return this.stringify()}stringify(e={}){return"("+this.list.map(t=>t.stringify(e)).join(", ")+")"}static parse(e,t,r={}){if(e=e.trim(),R(e,"(",")")&&!oe.match(e,[" "]).length)return new this(oe.split(te(e,"(",")"),[","]).map(e=>t(e.trim())))}},Ee=function(e){return e.filter((e,t,r)=>r.indexOf(e)===t)};const ye=class extends M{};Object.defineProperty(ye.prototype,"jsenType",{get:()=>"AssertionExpression"});var ve=ye;const Se=class extends ve{constructor(e,t){super(),this.exprs=e,this.logic=t}eval(e=null,t={}){var r=this.constructor;if(this.logic.toLowerCase()===r.negation.toLowerCase())return!ie(this.exprs).eval(e,t);se(r.operators);for(var s=(this.logic||"").trim().toUpperCase(),i=s===(r.operators.or||"").trim().toUpperCase(),n=s===(r.operators.nor||"").trim().toUpperCase(),a=s===(r.operators.and||"").trim().toUpperCase(),o=s===(r.operators.nand||"").trim().toUpperCase(),h=!0,c=0,l=0;l<this.exprs.length;l++){if(h=this.exprs[l].eval(e,t),a&&!h)return!1;if(o&&!h)return!0;if(i&&h)return h;c+=h?1:0}return i?h:a||o?a:n&&0===c}toString(){return this.stringify()}stringify(e={}){var t=this.constructor;return this.logic.toLowerCase()===t.negation.toLowerCase()?this.logic+ie(this.exprs).stringify(e):this.exprs.map(t=>t.stringify(e)).join(" "+this.logic+" ")}static parse(e,t,r={}){if(e.toUpperCase().startsWith(this.negation.toUpperCase()))return new this([t(e.substr(this.negation.length))],this.negation);var s=oe.lex(e,se(this.operators));if(s.tokens.length>1){var i=Ee(s.matches);if(i.length>1)throw new Error('"AND" and "OR" logic cannot be asserted in the same expression: '+e+"!");return new this(s.tokens.map(e=>t(e.trim())),ie(i))}}};Se.negation="!",Se.operators={and:"&&",or:"||"};var we=Se;const Te=class extends M{};Object.defineProperty(Te.prototype,"jsenType",{get:()=>"AssignmentExpression"});var Oe=Te,Ce=class extends Error{constructor(...e){super(...e),this.name="Reference Error"}};const _e=class extends Oe{constructor(e,t,r,s="=",i=!1){super(),this.initKeyword=e,this.reference=t,this.val=r,this.operator=s,this.postIncrDecr=i}eval(e=null,t={}){var r,i,n=this.reference.getEval(e,t);if(["++","--"].includes(this.operator)){if(i=this.reference.eval(e,t),!p(i))throw new Error(this.reference+" must be a number!");r="++"===this.operator?i+1:i-1}else if(["+=","-=","*=","/="].includes(this.operator)){var a=n.get(),o=this.val.eval(e,t);if(!("+="===this.operator||p(a)&&p(o)))throw new Error(this+" - operands must each be a number!");r="*="===this.operator?a*o:"/="===this.operator?a/o:"-="===this.operator?a-o:a+o}else r=this.val.eval(e,t);try{return n.set(r,this.initKeyword),t&&s(t.references)&&_pushUnique(t.references,this.reference.toString()),this.postIncrDecr?i:r}catch(e){throw e instanceof Ce?new Ce("["+this+"]: "+e.message):e}}toString(){return this.stringify()}stringify(e={}){return["++","--"].includes(this.operator)?this.postIncrDecr?this.reference.stringify(e)+this.operator:this.operator+this.reference.stringify(e):(this.initKeyword?this.initKeyword+" ":"")+[this.reference.stringify(e),this.operator,this.val.stringify(e)].join(" ")}static parse(e,t,r={}){var s=oe.lex(e,this.operators.concat([Ae]));if(s.matches.length){var i,n,a,o,h=s.matches[0].trim(),c=["++","--"].includes(h);if(c?(o=e.trim().endsWith("++")||e.trim().endsWith("--"),n=s.tokens[o?"shift":"pop"]().trim()):(n=s.tokens.shift().trim(),a=s.tokens.shift().trim()),["var","let","const"].includes(Z(n," "))){if("="!==h)throw new J("Invalid declaration: "+e);i=Z(n," "),n=z(n," ").trim()}if(!((n=t(n,null,{role:"ASSIGNMENT_SPECIFIER"}))instanceof G)||!c&&!(a=t(a)))throw new J(e);return new this(i,n,a,h,o)}}};_e.operators=["+=","-=","*=","/=","++","--"];const Ae=(e,t)=>!(e.endsWith("=")||!t.startsWith("=")||t.startsWith("=>")||t.startsWith("==")||t.startsWith("==="))&&"=";var xe=_e;const Re=class extends M{};Object.defineProperty(Re.prototype,"jsenType",{get:()=>"Block"});var Ie=Re;const be=class extends M{};Object.defineProperty(be.prototype,"jsenType",{get:()=>"ReturnDirective"});var Le=be;const Ne=class extends M{};Object.defineProperty(Ne.prototype,"jsenType",{get:()=>"DeleteExpression"});var Ue=Ne;const je=class extends M{};Object.defineProperty(je.prototype,"jsenType",{get:()=>"NumberType"});var Pe=je;const ke=class extends M{};Object.defineProperty(ke.prototype,"jsenType",{get:()=>"StringType"});var De=ke;function Be(e,t){return t.reduce((t,r,s)=>t&&r===e[s],!0)}function Fe(e){return e.map(e=>{var t=e,r=[];do{t instanceof Y&&(r.splice(0),t=t.reference),n(t.name)?r.unshift(t.name):t.name instanceof Pe?r.unshift(t.name.int):t.name instanceof De?r.unshift(t.name.expr):r.splice(0)}while(t=t.context);return r})}class We{constructor(e,t={}){if(this.stack=e,this.params=t,!("main"in this.stack))throw new Error('A "main" context must be provided!');this.stack.super&&(this.stack.super=We.create(this.stack.super,{errorLevel:t.errorLevel})),this.stack.local=this.stack.local||{},this.stack.$local=this.stack.$local||{}}observe(e,t,r={}){this.stack.super&&this.stack.super.observe(e,r=>{if(r.props.filter(t=>!He(this.stack.local,t,e)&&!He(this.stack.main,t,e)).length)return r.scope="super",t(r)},r);var s={...r};s.subtree="auto",s.tags=[this,"jsen-context"],e.observe(this.stack,r=>{var s=(r=r.filter(e=>"main"===e.name)).map(e=>e.path.slice(1)).filter(e=>e.length),i=s.map(e=>e[0]);if(!s.length&&r.length&&r[0].value&&(s=(i=Ee((c(r[0].value)?Object.keys(r[0].value):[]).concat(r[0].oldValue&&c(r[0].oldValue)?Object.keys(r[0].oldValue):[]))).map(e=>[e])),i.filter(t=>!He(this.stack.local,t,e)).length)return t({props:i,references:s,scope:"local"})},s)}unobserve(e,t){this.stack.super&&this.stack.super.unobserve(e,t),e.unobserve(this.stack,t,{subtree:"auto",tags:[this,"jsen-context"]})}handle(e,t,r,s=0){var i=()=>t(this.stack.main,null,()=>this.stack.super?this.stack.super.handle(e,t,r,s+1):r?r():void 0,s);return"toString"===e&&this.stack.local.toString===Object.prototype.toString?i():t(this.stack.local,this.stack.$local,i,s)}get(e,t={},r=!0){return e instanceof String&&(e+=""),this.handle(e,(s,i,n,o)=>{var c=Me(s,e,t);return!a(c)||He(s,e,t)?S(c)&&!function(e){return h(e)&&/^class\s?/.test(Function.prototype.toString.call(e))}(c)&&r?c.bind(s):c:n()})}set(e,t,r={},s=!1){if(2===this.params.type&&"var"===s&&this.stack.super)return this.stack.super.set(e,t,r,s);e instanceof String&&(e+="");const i=(e,t,r,s)=>s.set?s.set(e,t,r):(e[t]=r,!0);return this.handle(!!s||e,(n,a,o,h)=>{if(a&&"const"===a[e])throw new LogicalError("CONST "+e+" cannot be modified!");if(s)return a[e]=s,i(n,e,t,r);if(He(n,e,r))return i(n,e,t,r);try{return o()}catch(s){if(s instanceof Ce&&!a&&0===h&&!1===this.params.strictMode)return i(n,e,t,r);throw s}},()=>{throw new Ce('"'+e+'" does not exist in scope!')})}del(e,t={}){return e instanceof String&&(e+=""),this.handle(e,(r,s,i)=>He(r,e,t)?(s&&delete s[e],t.deleteProperty||t.del?(t.deleteProperty||t.del)(r,e):(delete r[e],!0)):i())}has(e,t,r={}){return e instanceof String&&(e+=""),t instanceof String&&(t+=""),this.handle(e,(s,i,n)=>{if(He(s,e,r)){var a=Me(s,e,r);return He(a,t,r)}return n()},()=>{throw new Ce('"'+e+'" is undefined!')})}exec(e,t,r={}){return e instanceof String&&(e+=""),this.handle(e,(s,i,n)=>{var o=Me(s,e,r);if(!a(o)||He(s,e,r)){if(!S(o)){if(r.exec)return r.exec(s,e,t);throw new Ce('"'+e+'" is not a function! (Called on type: '+typeof s+".)")}return r.apply?r.apply(o,s,t):o.apply(s,t)}return n()},()=>{if(r.execUnknown)return r.execUnknown(this,e,t);throw new Ce('"'+e+'()" is undefined!')})}static create(e,t={}){return e instanceof We?e:new We({main:e},t)}}const Me=(e,t,r)=>{if(!o(e)&&!a(e))return r.get&&c(e)?r.get(e,t):e[t]},He=(e,t,r)=>!o(e)&&!a(e)&&(r.has&&c(e)?r.has(e,t):c(e)?t in e:!a(e[t]));class Ge extends Ie{constructor(e,t){super(),this.stmts=e||[],this.delim=t}eval(e=null,t={}){var r,s=t.returnCallback;(t={...t}).returnCallback=e=>{r=e},e=We.create(e);for(var i=(e,t,r)=>{try{return e.eval(t,r)}catch(e){r.catch&&r.catch(e)}},n=[],a=0;a<this.stmts.length;a++){var o=this.stmts[a],h=Fe(o.meta.reads),c=Fe(o.meta.deep.reads||[]),l=(t.references||[]).filter(e=>h.filter(t=>Be(t,e)).length),u=(t.references||[]).filter(e=>c.filter(t=>Be(t,e)).length);if(!t.references||!t.references.length||(l=l.length)||(u=u.length)){var p=t;if(l&&delete(p={...t}).references,n[a]=i(o,e,p),o instanceof Le||r)return s&&s(!0),n[a];o instanceof Q&&(o instanceof Q&&o.abortive||!1===r)&&(!0,s&&s(!1)),t.references&&(o instanceof Oe||o instanceof Ue)&&(t.references=t.references.concat(Fe([o.reference])))}}return n}toString(){return this.stringify()}stringify(e={}){return this.stmts.map(t=>t.stringify(e)).join(this.delim)}static parse(e,t,r={}){var s=oe.lex(e+";",se(this.operators).concat([Ge.testBlockEnd]));if(s.matches.length)return new this(s.tokens.map(e=>t(e.trim())).filter(e=>e),s.matches[0].trim())}static testBlockEnd(e,t){return!(!e.endsWith("}")||t.trim().startsWith("else"))&&""}}Ge.operators=[";","\r\n"];const Ke=class extends M{};Object.defineProperty(Ke.prototype,"jsenType",{get:()=>"BooleanType"});var Ye=Ke;var $e=class extends Ye{constructor(e){super(),this.state=e}eval(){return"true"===this.state.toLowerCase().trim()}toString(){return this.stringify()}stringify(e={}){return this.state}static parse(e,t,r={}){if("true"===(e=e.toLowerCase().trim())||"false"===e)return new this(e)}};var qe=class extends Y{constructor(e,t){super(),this.reference=e,this.args=t}eval(e=null,t={}){try{var r=this.args.eval(e,t);return this.reference.getEval(e,t).exec(r)}catch(e){throw e instanceof Ce?new Ce("["+this+"]: "+e.message):e}}toString(){return this.stringify()}stringify(e={}){return this.reference.stringify(e)+this.args.stringify(e)}static parse(e,t,r={}){if(!e.startsWith("(")&&e.endsWith(")")&&!oe.match(e,[" "]).length){var s,i=oe.split(e,[]),n=i.pop();if(!((s=t(i.join(""),null,{role:"CALL_SPECIFIER"}))instanceof G&&(n=t(n,[de]))))throw new J(e);return new this(s,n)}}};const Qe=class extends M{};Object.defineProperty(Qe.prototype,"jsenType",{get:()=>"ComparisonExpression"});var Je=Qe;class Ve extends Je{constructor(e,t,r){super(),this.operand1=e,this.operand2=t,this.operator=r}eval(e=null,t={}){return this.constructor.compare(this.operand1.eval(e,t),this.operand2.eval(e,t),this.operator)}toString(){return this.stringify()}stringify(e={}){return[this.operand1.stringify(e),this.operator,this.operand2.stringify(e)].join(" ")}static parse(e,t,r={}){var s=se(this.operators).map(e=>" "+e+" "),i=oe.lex(e,s);if(i.tokens.length>1){if(i.tokens.length>2)throw new Error('Malformed "Comparison" expression: '+e+"!");return new this(t(ie(i.tokens).trim()),t(ne(i.tokens).trim()),i.matches[0].trim())}}static compare(e,t,r="=="){if(-1===se(this.operators).indexOf(r))throw new Error('The operator "'+r+'" is not recognized.');switch(r){case"===":return e===t;case"==":case"=":return e==t;case">":return e>t;case"<":return e<t;case">=":return e>=t;case"<=":return e<=t;case"!=":return e!=t;case"<>":case"!==":return e!==t;case"^=":return n(e)&&e.startsWith(t);case"$=":return n(e)&&e.endsWith(t);case"*=":return!(!s(t)&&!n(t))&&e.indexOf(t)>-1;case"~=":return n(e)&&n(t)&&(" "+e+" ").indexOf(" "+t+" ")>-1;case">=<":if(!s(t)||2!==t.length)throw new Error("A 'Between' comparison requires argument 2 to be an array of exactly 2 values.");return e>=t[0]&&e<=t[1];case"/**/":return t.match(new RegExp(e));default:return!1}}static diff(e,t,r){return!this.compare(e,t,r?"===":"==")}}Ve.operators={exact:{is:"===",isNull:"===",equalsTo:"==",strictlyNotEqualsTo:"!==",notEqualsTo:"!="},relative:{lesserThan:"<",greaterThan:">",lesserThanOrEqualsTo:"<=",greaterThanOrEqualsTo:">=",between:">=<"},partial:{startsWith:"^=",endsWith:"$=",contains:"*=",any:"~=",in:"~=",matches:"/**/"}};const Xe=class extends M{};Object.defineProperty(Xe.prototype,"jsenType",{get:()=>"TernaryConditional"});var ze=Xe;class Ze extends ze{constructor(e,t,r){super(),this.assertion=e,this.onTrue=t,this.onFalse=r}eval(e=null,t={}){return this.assertion.eval(e,t)?this.onTrue.eval(e,t):this.onFalse.eval(e,t)}toString(){return this.stringify()}stringify(e={}){return[this.assertion.stringify(e),this.constructor.operators[0],this.onTrue.stringify(e),this.constructor.operators[1],this.onFalse.stringify(e)].join(" ")}static parse(e,t,r={}){var s=oe.split(e,this.operators);if(s.length>1){if(2===s.length)throw new Error("Malformed ternary expression: "+e+"!");return new this(t(s[0].trim()),t(s[1].trim()),t(s[2].trim()))}}}Ze.operators=["?",":"];const et=class extends Ue{constructor(e,t="delete"){super(),this.reference=e,this.operator=t}eval(e=null,t={}){try{return this.reference.getEval(e,t).del()}catch(e){throw e instanceof Ce?new Ce("["+this+"]: "+e.message):e}}toString(){return this.stringify()}stringify(e={}){return this.operator+" "+this.reference.stringify(e)}static parse(e,t,r={}){var s=oe.lex(e,Object.values(this.operators));if(1===s.matches.length&&e.startsWith(s.matches[0]+" ")){var i;if(!((i=t(s.tokens.pop().trim(),null,{role:"DELETION_SPECIFIER"}))instanceof G))throw new J(e);return new this(i,s.matches[0].trim())}}};et.operators={red:"reduce",del:"delete"};var tt=et;const rt=class extends ${};Object.defineProperty(rt.prototype,"jsenType",{get:()=>"FunctionType"});var st=rt;const it=class extends st{constructor(e,t,r={}){super(),this.paramters=e||{},this.statements=t,this.arrowFunctionFormatting=r}inherit(e){if(e instanceof st){for(var t=Object.keys(e.paramters),r=Object.keys(this.paramters),s=0;s<Math.max(r.length,t.length);s++){var i=t[s],n=r[s];if(!n&&i)throw new Error("Parameter #"+s+" ("+i+") in parent function must be implemented.");if(n&&i){var a=e.paramters[i],o=this.paramters[n];if(o&&!a)throw new Error("Parameter #"+s+" ("+n+") must not have a default value as established in parent function.");if(o&&a&&o.jsenType!==a.jsenType)throw new Error("Default value for parameter #"+s+" ("+n+") must be of type "+a.jsenType+" as established in parent function.")}}this.sup=e}return this}eval(e=null,t={}){var r=this;return delete(t={...t}).returnCallback,function(...s){var i={};m(Object.keys(r.paramters),(n,a)=>{var o=r.paramters[a];if(s.length-1<n&&!o)throw new Error('The parameter "'+a+'" is required.');i[a]=s.length>n?s[n]:r.paramters[a]?r.paramters[a].eval(e,t):null}),r.arrowFunctionFormatting||(i.this=this);var n=e instanceof We?e.params.errorLevel:void 0,a=new We({main:i,super:e},{errorLevel:n}),o=r.statements.eval(a,t);return!1===r.arrowFunctionFormatting.body?o[0]:o}}toString(){return this.stringify()}stringify(e={}){var t=[];if(m(this.paramters,(r,s)=>{t.push(r+(s?"="+s.stringify(e):""))}),this.arrowFunctionFormatting){var r=!1===this.arrowFunctionFormatting.head||1===t.length&&-1===t[0].indexOf("="),s=!1===this.arrowFunctionFormatting.body;return(r?t[0]:"("+t.join(", ")+")")+" => "+(s?this.statements.stringify(e):"{"+this.statements.stringify(e)+"}")}return"function ("+t.join(", ")+") {"+this.statements.stringify(e)+"}"}static parse(e,t,r={}){var s;if((e=e.trim()).startsWith("function")&&(s=oe.split(e,[]).slice(1).filter(e=>e.trim()))&&2===s.length)var i=!1,n=te(s.shift().trim(),"(",")"),a=te(s.shift().trim(),"{","}");else{if(e.startsWith("function")||!(s=oe.split(e,["=>"]))||2!==s.length)return;n=s.shift().trim(),a=s.shift().trim(),i={};R(n,"(",")")?n=te(n,"(",")"):i.head=!1,R(a,"{","}")?a=te(a,"{","}"):i.body=!1}var o={};oe.split(n,[","]).forEach(e=>{var r=e.split("=");r[1]?o[r[0].trim()]=t(r[1].trim(),null,{meta:null}):o[e.trim()]=null});var h=t(a,[Ge],{assert:!1})||t(a,null,{meta:null});return new this(o,"Block"===h.jsenType?h:new Ge([h]),i)}};it.operators=["=>"];var nt=it;var at=class extends Q{constructor(e,t,r,s={}){super(),this.assertion=e,this.onTrue=t,this.onFalse=r,this.params=s}eval(e=null,t={}){var r=e instanceof We?e.params.errorLevel:void 0,s=new We({main:{},super:e},{type:2,errorLevel:r});return this.assertion.eval(e,t)?this.onTrue?this.onTrue.eval(s,t):void 0:this.onFalse?this.onFalse.eval(s,t):void 0}toString(){return this.stringify()}stringify(e={}){var t=this.onTrue&&this.params.onTrueIsBlock?"{"+this.onTrue.stringify(e)+"}":this.onTrue?this.onTrue.stringify(e):"",r=this.onFalse&&this.params.onFalseIsBlock?"{"+this.onFalse.stringify(e)+"}":this.onFalse?this.onFalse.stringify(e):"";return"if ("+this.assertion.stringify(e)+")"+t+(r?" else "+r:"")}static parse(e,t,r={}){var s;if((e=e.trim()).startsWith("if")&&(s=oe.split(e,[],{limit:2}).slice(1).filter(e=>e.trim()))&&2===s.length){var i,n,a,o=t(te(s.shift().trim(),"(",")").trim()),h=oe.split(s.shift().trim(),["else"],{limit:1}),c=h.shift().trim(),l=(h.shift()||"").trim();R(c,"{","}")&&(n=!0,c=te(c,"{","}").trim()),c=t(c,[Ge],{assert:!1,meta:null})||t(c,null,{meta:null}),l?(R(l,"{","}")&&(a=!0,l=te(l,"{","}").trim()),l=t(l,[Ge],{assert:!1,meta:null})||t(l,null,{meta:null})):i=c.stmts.filter(e=>e instanceof Le).length;const e=new this(o,c,l,{onTrueIsBlock:n,onFalseIsBlock:a});return e.abortive=i,e}}};const ot=class extends M{};Object.defineProperty(ot.prototype,"jsenType",{get:()=>"MathExpression"});var ht=ot;const ct=class extends ht{constructor(e,t){super(),this.val=e,this.exprs=t}eval(e=null,t={}){return this.exprs.reduce((r,s)=>{var i=s.val.eval(e,t),n=s.operator.trim();if(!(f(r)&&f(i)||"+"===n))throw new Error("Invalid Math expression: "+this.toString()+"!");switch(n){case"+":return r+i;case"-":return r-i;case"*":return r*i;case"/":return r/i}},this.val.eval(e,t))}toString(){return this.stringify()}stringify(e={}){return[this.val.stringify(e)].concat(this.exprs.map(t=>t.operator+" "+t.val.stringify(e))).join(" ")}static parse(e,t,r={}){var s=oe.lex(e,se(this.operators));if(s.tokens.filter(e=>e).length>1&&s.matches.length===s.tokens.length-1){var i=Ee(s.matches);if(A(i,this.operators.sup).length&&A(i,this.operators.sub).length)throw new Error('"Addition/subtraction" and "multiplication/division" operators cannot be used in the same expression: '+e+"!");return new this(t(s.tokens.shift().trim()),s.tokens.map((e,r)=>({operator:s.matches[r],val:t(e.trim())})))}}};ct.operators={sup:["*","/"],sub:["+","-"]};var lt=ct;var ut=class extends Pe{constructor(e,t=0){super(),this.int=e,this.dec=t}eval(){return parseFloat(this.int+(this.dec?"."+this.dec:null))}toString(){return this.stringify()}stringify(e={}){return this.int+(this.dec?"."+this.dec:null)}static parse(e,t,r={}){if(f(e)){e=e.split(".");return new this(parseInt(e.shift()),parseInt(e.shift()))}}};const pt=class extends M{};Object.defineProperty(pt.prototype,"jsenType",{get:()=>"ObjectType"});var ft=pt;const mt=class extends ft{constructor(e){super(),this.entries=e||{}}inherit(e){return e instanceof ft&&m(e.entries,(e,t)=>{e in this.entries||(this.entries[e]=t)}),this}eval(e=null,t={}){var r={};return m(this.entries,(s,i)=>{r[s]=i.eval(e,t)}),r}toString(){return this.stringify()}stringify(e={}){var t=[];return m(this.entries,(r,s)=>{t.push(r+mt.operators.sub+s.stringify(e))}),"{"+t.join(mt.operators.sup)+"}"}static parse(e,t,r={}){if(R(e,"{","}")&&!oe.match(e.trim(),[" "]).length){var s={},i=oe.split(te(e,"{","}"),[mt.operators.sup]).map(e=>e.trim()).filter(e=>e);return m(i,(e,r)=>{var i=oe.split(r,[mt.operators.sub],{limit:1});s[ie(i).trim()]=t(ne(i).trim())}),new this(s)}}};mt.operators={sup:",",sub:":"};var gt=mt;const dt=class extends M{};Object.defineProperty(dt.prototype,"jsenType",{get:()=>"PresenceOperator"});var Et=dt;const yt=class extends Et{constructor(e,t,r="in"){super(),this.prop=e,this.reference=t,this.operator=r}eval(e=null,t={}){var r=this.prop.eval(e,t);try{return this.reference.getEval(e,t).has(r)}catch(e){throw e instanceof Ce?new Ce("["+this+"]: "+e.message):e}}toString(){return this.stringify()}stringify(e={}){return[this.prop.stringify(e),this.operator,this.reference.stringify(e)].join(" ")}static parse(e,t,r={}){var s=oe.lex(e,this.operators);if(2===s.tokens.length){var i,n;if(!((i=t(s.tokens.shift().trim()))&&(n=t(s.tokens.shift().trim()))instanceof G))throw new J(e);return new this(i,n,s.matches[0].trim())}}};yt.operators=[" in "];var vt=yt;class St extends G{constructor(e,t,r=!1){super(),this.context=e,this.name=t,this.backticks=r}getEval(e=null,t={}){var r=e,s=this.name;return this.context&&(s instanceof M&&(s=s.eval(e,t)),r=this.context.eval(e,t)),{get:()=>We.create(r,t).get(s,t.trap),del:()=>We.create(r,t).del(s,t.trap),has:e=>We.create(r,t).has(s,e,t.trap),set:(e,i=null)=>We.create(r,t).set(s,e,t.trap,i),exec:e=>We.create(r,t).exec(s,e,t.trap)}}eval(e=null,t={}){try{return this.getEval(e,t).get()}catch(e){throw e instanceof Ce?new Ce("["+this+"]: "+e.message):e}}toString(){return this.stringify()}stringify(e={}){var t=this.name;if(this.context){var r=this.context.stringify(e);t instanceof M?t="["+t.stringify(e)+"]":this.backticks&&(t="`"+t+"`")}else{r=e.context;this.backticks&&(t="`"+t+"`")}return(r||"")+(r&&!t.startsWith("[")?St.separator:"")+t}static parse(e,t,r={}){if(!oe.match(e.trim(),[" "]).length){var s,i,n=oe.split(e,[]),a=n.pop(),o=oe.split(a.trim(),[this.separator],{preserveDelims:!0});if(o.length>1&&(a=o.pop().substr(1),n=n.concat(o)),R(a,"`","`")&&(a=te(a,"`","`"),i=!0),n.length&&(s=t(n.join(""),null,{role:"CONTEXT"})),R(a,"[","]")){if(!s)throw new J(e);a=t(te(a,"[","]"))}return new this(s,a,i)}}}St.separator=".";var wt=class extends Le{constructor(e){super(),this.expr=e}eval(e=null,t={}){return this.expr?this.expr.eval(e,t):void 0}toString(){return this.stringify()}stringify(e={}){return this.expr?"return "+this.expr.stringify(e):"return"}static parse(e,t,r={}){var s=e.toLowerCase();if(s.startsWith("return ")||"return"===s)return new this(t(e.substr(6).trim()))}};var Tt=class extends De{constructor(e,t){super(),this.expr=e,this.quote=t}eval(){return this.expr}toString(){return this.stringify()}stringify(e={}){return this.quote+this.expr+this.quote}static parse(e,t,r={}){if(e=e.trim(),(R(e,'"','"')||R(e,"'","'"))&&!oe.match(e,[" "]).length){var s=R(e,'"','"')?'"':"'";return new this(te(e,s,s),s)}}};const Ot=class extends M{};Object.defineProperty(Ot.prototype,"jsenType",{get:()=>"Void"});var Ct=Ot;var _t=class extends Ct{constructor(e){super(),this.val=e}eval(){return"null"===this.val.toLowerCase().trim()?null:void 0}toString(){return this.stringify()}stringify(e={}){return this.val}static parse(e,t,r={}){if("null"===(e=e.toLowerCase().trim())||"undefined"===e)return new this(e)}},At={If:at,Return:wt,Deletion:tt,Assignment:xe,Presence:vt,Func:nt,Abstraction:le,Condition:Ze,Assertion:we,Comparison:Ve,Math:lt,Arr:fe,Obj:gt,Num:ut,Str:Tt,Bool:$e,Void:_t,Call:qe,Reference:St};X.grammar=At;var xt=X;class Rt extends xt{static parse(e,t,r={}){return"mutates"in r||(r.mutates=!0),!r.placeholdersTransformed&&e.indexOf("?")>0&&(e=oe.split(e,["?"],{blocks:[]}).reduce((e,t,r)=>e?e+"?"+(r-1)+t:t,null),r.placeholdersTransformed=!0),r.opts||(r.opts={}),"ci"in r.opts||(r.opts.ci=!0),r.allowCache=!1,super.parse(e,t,r)}}class It extends we{}It.negation="NOT ",It.operators={and:" and ",or:" or ",AND:" AND ",OR:" OR "};class bt extends Ve{}bt.operators={relative:{lesserThan:"<",greaterThan:">",lesserThanOrEqualsTo:"<=",greaterThanOrEqualsTo:">="},partial:{any:"any",in:"in",like:"like"},exact:{notEqualsTo:"<>",is:"="}};class Lt extends St{stringify(e={}){return this.interpreted&&e.interpreted?s(this.interpreted)?this.interpreted.map(t=>t.stringify(e)).join(", "):this.interpreted.stringify(e):super.stringify(e)}getEval(e,t={}){if(this.interpreted)return s(this.interpreted)?this.interpreted.reduce((r,s)=>(r[s.name]=s.getEval(e,t),r),{}):this.interpreted.getEval(e,t);var r=e,i=this.name;if(this.context)r=this.context.eval(e,t);else if("CONTEXT"!==this.role&&"CALL_SPECIFIER"!==this.role){if(!e.$)throw new Error('"'+this+'" is undefined!');r=e.$}return{get:()=>We.create(r,t).get(i,t.trap),del:()=>We.create(r,t).del(i,t.trap),has:e=>We.create(r,t).has(i,e,t.trap),set:(e,s=null)=>We.create(r,t).set(i,e,t.trap,s),exec:e=>We.create(r,t).exec(i.toUpperCase(),e,t.trap)}}eval(e,t={}){return this.interpreted?s(this.interpreted)?this.interpreted.map(r=>r.eval(e,t)):this.interpreted.eval(e,t):this.getEval(e,t).get()}static parse(e,...t){return super.parse(e,...t)}}function Nt(...e){var t={};s(arguments[0])&&(e=arguments[0],t=arguments[1]);ne(e);var r={},i=class{constructor(...t){var r=null;e.reverse().forEach((e,s)=>{var i=Reflect.construct(e,t,this.constructor);r&&Object.setPrototypeOf(i,r),r=i}),Object.setPrototypeOf(this,r)}},n=Symbol.for("webqit/util/mixin");return e.forEach((e,t)=>{T(e).forEach(e=>{if(!e[n]){Object.defineProperty(e,n,{value:[]});try{var t=e[Symbol.hasInstance].bind(e);Object.defineProperty(e,Symbol.hasInstance,{value:function(r){return!!t(r)||e[n].reduce((e,t)=>e||r instanceof t,!1)}})}catch(e){}}e[n].push(i)})}),e.forEach(e=>{O([i,e],(e,t,r)=>!["name","prototype","prototypes","length","caller","callee","arguments","constructor","apply","bind","call","toString"].includes(e),!0),O([i.prototype,e.prototype],(e,t,i)=>!["prototype","prototypes"].includes(e)&&(!S(i[e])||(s(r[e])?r[e].push(i[e]):r[e]=[i[e]],!1)),!0)}),m(r,(e,r)=>{"constructor"!==e&&(i.prototype[e]=function(...s){if(Object.hasOwnProperty(t,e)&&S(t[e]))return t[e].call(this,r,...s);var i=[];return r.forEach(e=>{i.push(e.call(this,...s))}),ne(i)})}),i}const Ut=function(e,t,r=!1){var i=null,n=e;s(e)||(i=Object.keys(e),n=Object.values(e));var a=void 0,o=n.reduce((e,s)=>{if(void 0===a){if(t(s,e))return s;if(r&&(c(s)||S(s))&&void 0!==(a=Ut(s,t,r)))return s}return e},void 0);if(void 0!==o){var h=i?i[n.indexOf(o)]:n.indexOf(o);return void 0!==a?[h].concat(u(a)):h}};var jt=Ut;const Pt=class extends M{};Object.defineProperty(Pt.prototype,"jsenType",{get:()=>"AggregateExpression"});var kt=Pt,Dt=function(...e){return O(e,(e,t,r)=>{if(s(t)&&s(r)){if(-1===t.indexOf(r[e]))return!0}else if(!(e in t))return!0})};const Bt=class extends M{};Object.defineProperty(Bt.prototype,"jsenType",{get:()=>"WindowConstruct"});var Ft=Bt;const Wt=class extends M{};Object.defineProperty(Wt.prototype,"jsenType",{get:()=>"OrderByExpression"});var Mt=Wt;class Ht extends Mt{constructor(e,t=!1){super(),this.columns=e,this.withRollup=t}eval(e,t={}){var r=(e,s)=>{var i={};e.forEach(e=>{var r=s[0].expr.eval(e,t);i[r]=i[r]||[],i[r].push(e)});var a=[];return function(e,t,r=null){for(var s=[],i=e.length,a=0;a<i;a++)s.push({index:a,value:r?r(e[a]):e[a]});return s.sort((function(e,t){return n(e.value)&&"".localeCompare?e.value.localeCompare(t.value):e.value===t.value?0:e.value>t.value?1:-1})),"desc"===(t||"").trim().toLowerCase()&&(s=s.reverse()),s.map(t=>e[t.index])}(Object.keys(i),s[0].order).forEach(e=>{a=a.concat(s.length>1?r(i[e],s.slice(1)):i[e])}),a};return r(e,this.columns)}toString(){return this.stringify()}stringify(e={}){var t=[this.columns.map(t=>t.expr.stringify(e)+(t.order?" "+t.order:"")).join(", ")];return this.withRollup&&t.push("WITH ROLLUP"),t.join(" ")}static parse(e,t,r={}){var s,i=!1,n=oe.lex(e,["WITH[ ]+ROLLUP"],{useRegex:"i"});return s=oe.split(n.tokens.shift().trim(),[","]).map(e=>{var r=e.match(/ASC|DESC/,"i");return r&&(r=r[0],e=ee(e,r).trim()),{expr:t(e),order:r}}),1===n.matches.length&&(i=!0),new this(s,i)}}class Gt extends Ft{constructor(e){super(),this.dfn=e}eval(e,t={},r={}){var s=this.dfn,i=this.stringify();if(this.dfn.name){if(!t||!t[this.dfn.name])throw new Error('Window name "'+this.dfn.name+'" is undefined!');s=Dt({},this.dfn,t[this.dfn.name])}var n=(e,t)=>{if(t.length){var a={};e.forEach(e=>{var s=t[0].eval(e,r);a[s]=a[s]||[],a[s].push(e)}),Object.values(a).map(e=>n(e,t.slice(1)))}else s.orderBy&&(e=s.orderBy.eval(e,r)),e.forEach(t=>{t.WINDOWS||(t.WINDOWS={}),t.WINDOWS[i]=e})};try{n(e,s.partitionBy||[])}catch(e){throw new Error('["'+this.stringify()+'" in window definition]: '+e.message)}}toString(){return this.stringify()}stringify(e={}){if(1===Object.keys(this.dfn).length&&this.dfn.name)return this.dfn.name;var t=[this.dfn.name];return this.dfn.partitionBy&&t.push("PARTITION BY "+this.dfn.partitionBy.map(t=>t.stringify(e)).join(", ")),this.dfn.orderBy&&t.push("ORDER BY "+this.dfn.orderBy.stringify(e)),"("+t.filter(e=>e).join(" ")+")"}static parse(e,t,r={}){var s={};if(R(e,"(",")")){if(e=te(e,"(",")")){var i=oe.lex(e,["PARTITION[ ]+BY","ORDER[ ]+BY"],{useRegex:"i"});s.name=i.tokens.shift().trim(),i.matches.forEach(e=>{e.toLowerCase().startsWith("partition")?s.partitionBy=oe.split(i.tokens.shift().trim(),[","]).map(e=>t(e)):e.toLowerCase().startsWith("order")&&(s.orderBy=t(i.tokens.shift().trim(),[Ht]))})}}else s.name=e;return new this(s)}}class Kt extends(Nt(qe,kt)){eval(e,t={}){var r=this.args.list.slice();return r.unshift(this.window?e.WINDOWS[this.window.stringify()]:e.AGGR.rows,this.aggrFlag),this.reference.getEval(e,t).exec(r)}toString(){return this.stringify()}stringify(e={}){var t=super.stringify(e);return this.aggrFlag&&(t=t.replace("(","("+this.aggrFlag+" ")),t+(this.window?" OVER "+this.window.stringify(e):"")}static parse(e,t,r={}){var s,i,n="",a=se(this.funcs).join("\\(|")+"\\(";if(s=e.trim().match(new RegExp("^("+a+")","i"))){var o=Z(s[0],"(").toUpperCase();(i=z(e,o+"(").match(new RegExp("^(([ ]+)?"+["ALL","DISTINCT"].join("[ ]+|([ ]+)?")+"[ ]+)","i")))&&(n=i[0],e=e.replace(n,""));var h=jt(this.funcs,e=>e===o,!0)[0],c=oe.split(e,["OVER"],{ci:!0});if("explicitOver"===h&&1===c.length)throw new Error(s[0]+"() requires an OVER clause!");var l=super.parse(c.shift().trim(),t,r);return l.funcCategory=h,l.aggrFlag=n.trim(),c.length&&(l.window=t(c.pop().trim(),[Gt])),l}}}Kt.funcs={normal:["AVG","BIT_AND","BIT_OR","BIT_XOR","COUNT","JSON_ARRAYAGG","JSON_OBJECTAGG","MAX","MIN","STDDEV_POP","STDDEV","STD","STDDEV_SAMP","SUM","VAR_POP","VARIANCE","VAR_SAMP","GROUP_CONCAT","GROUP_CONCAT_WS"],explicitOver:["CUME_DIST","DENSE_RANK","FIRST_VALUE","LAG","LAST_VALUE","LEAD","NTH_VALUE","NTLE","PERCENT_RANK","RANK","ROW_NUMBER"],support:["ANY_VALUE","COLUMN","COLUMNS","GROUPING"]};var Yt=function(e){return s(e)?ie(e):e[Object.keys(e)[0]]};const $t=class extends Lt{};Object.defineProperty($t.prototype,"jsenType",{get:()=>"ArrowReferenceExpression"});var qt=$t;class Qt extends qt{process(e,t=null){var r=this.interpreted?this.interpreted.toString():this.toString();return Qt.process(e,r.replace(/`/g,""),t)}static parse(e,t,r={}){if(this.isReference(e)){var s=super.parse(e,t,r);return s&&(s.backticks=!0),s}}static isReference(e){return e.indexOf(this.arrLeft)>-1||e.indexOf(this.arrRight)>-1}static isOutgoing(e){return e.indexOf(this.arrRight)>-1&&-1===Z(e,this.arrRight).indexOf(this.arrLeft)}static isIncoming(e){return e.indexOf(this.arrLeft)>-1&&-1===Z(e,this.arrLeft).indexOf(this.arrRight)}static reverse(e){return e.replace(new RegExp(this.arrRight,"g"),"|"+this.arrRight+"|").replace(new RegExp(this.arrLeft,"g"),"|"+this.arrLeft+"|").split("|").map(e=>e===this.arrRight?this.arrLeft:e===this.arrLeft?this.arrRight:e).reverse().join("")}static process(e,t,r=null){var s,i=v(r,e?e.databaseName:null)||{fields:{}};if(this.isIncoming(t)){var n=Z(t,this.arrLeft),a=z(t,this.arrLeft);if(n.indexOf(".")>0&&(e||(e=i[Z(n,".")]),n=z(n,".")),this.isIncoming(a)){s=this.process(null,a,r).a.table;var o=a}else{var h=Z(a,this.arrRight);if(o=z(a,this.arrRight),!(s=i[h]))throw new Error("["+t+']: The implied table "'+h+'" is not defined.')}if(!e){if(!s.fields[n]||!(c=s.fields[n].referencedEntity))throw new Error("["+t+']: The "'+s.name+'" table does not define the implied foreign key "'+n+'".');e=i[c.name]}return{a:{table:e,actingKey:e.primaryKey},b:{table:s,actingKey:n,select:o}}}var c,l=Z(t,this.arrRight);if(o=z(t,this.arrRight),l.indexOf(".")>0?(e||(e=i[Z(l,".")]),l=z(l,".")):e=Yt(i),!e.fields[l]||!(c=e.fields[l].referencedEntity))throw new Error("["+e.name+this.arrRight+t+']: The "'+e.name+'" table does not define the implied foreign key "'+l+'".');return{a:{table:e,actingKey:l},b:{table:s=i[c.name],actingKey:s.primaryKey,select:o}}}}Qt.arrRight="~>",Qt.arrLeft="<~";const Jt=class extends ${};Object.defineProperty(Jt.prototype,"jsenType",{get:()=>"DeleteStatement"});var Vt=Jt,Xt=function(e,t=null){var r={};return 2===arguments.length&&(s(e)&&s(t)?e.forEach((e,s)=>r[e]=t[s]):r[e]=t),r};const zt=class extends M{};Object.defineProperty(zt.prototype,"jsenType",{get:()=>"Literal"});var Zt=zt;class er extends Zt{constructor(e){super(),this.expr=e}eval(){return this.expr}toString(){return this.stringify()}stringify(e={}){return this.expr}static parse(e,t=null,r={}){return new this(e)}}const tr=class extends ${};Object.defineProperty(tr.prototype,"jsenType",{get:()=>"TableExpression"});var rr=tr;class sr extends I{constructor(e,t,r,s={},i={}){super(t,r,s,i),this.stmt=e}getCursor(){return new L((this.store||[]).filter(e=>e))}async syncCursor(e){return this.stmt.base.syncCursors()}}class ir extends rr{constructor(e,t,r=!1,s=null){super(),this.expr=e,this.alias=t,this.claused=r,this.schema=s,this.associatedReferences=[]}as(e){return this.alias=e,this.claused=!0,this}getDatabaseName(){return(this.expr+"").split(".").slice(0,-1)[0]||""}getName(){return this.isDerivedQuery()?u(this.getDerivedQuery().getTable(),!1)[0].getName():(this.expr+"").split(".").pop()}getAlias(){return this.alias||this.getName()}isDerivedQuery(){return this.expr instanceof ce}getDerivedQuery(){return this.expr.expr}associateReference(e){return this.associatedReferences.push(e)}getAssociateReferences(){return this.associatedReferences}getSchema(){if(!this.schema&&this.isDerivedQuery()){var e=this.getAlias(),t=this.getDerivedQuery(),r=t.getSources(!0),i=e=>t.getFields().reduce((t,r)=>t||(e===r.getName()?r.getAlias():null),null),n={};r.forEach(e=>{n[e.getAlias()]=e.getSchema()});var a=Yt(n),o={name:e,fields:{},uniqueKeys:{},derived:!0};t.getFields().forEach(e=>{if(e.expr instanceof G)if("*"===e.getName())e.expr.interpreted.forEach(e=>{o.fields[e.name]=((n[e.context.name]||{}).fields||{})[t]||{type:"any",derived:!0}});else{var t=e.getName(),r=e.getContextName();o.fields[e.getAlias()]=(((r?n[r]:a)||{}).fields||{})[t]||{type:"any",derived:!0}}else o.fields[e.getAlias()]={type:"any",derived:!0}}),o.primaryKey=s(a.primaryKey)?a.primaryKey.map(e=>i(e)):i(a.primaryKey),o.autoIncrement=a.autoIncrement,l(o.primaryKey)&&(delete o.primaryKey,delete o.autoIncrement),m(a.uniqueKeys||{},(e,t)=>{var r=u(t).map(e=>i(e));o.uniqueKeys[e]=s(t)?r:r[0],l(o.uniqueKeys[e])&&delete o.uniqueKeys[e]}),o.driver=a.driver,this.schema=o}return this.schema}eval(e=null,t={}){if(this.interpreted)return this.interpreted.eval(e,t);if(!e)throw new Error("Context must be provided!");if(this.isDerivedQuery()){var r=this.getAlias(),s=this.getDerivedQuery(),i=this.getSchema(e);return s.eval(e,t).then(e=>{var n={...t};return n.alias=r,new sr(s,e,r,i,n)})}return Promise.resolve().then(()=>{var t=this.getDatabaseName();if(e.prototype instanceof y)return t?e.open(t):e.open();if(t)throw new Error("["+this.expr+"]: For tables that are fully-qualified with a database name, a database factory must be provided as context.");return e}).then(e=>{if(!(e instanceof g))throw new Error("["+this.expr+"]: The provided context could not be resolved to a valid database instance.");return e.open(this.getName(),t.mode,{alias:this.getAlias()})})}toString(){return this.stringify()}stringify(e={}){return this.interpreted&&e.interpreted?this.interpreted.stringify(e):[this.expr.stringify(e),this.claused?"AS":"",this.alias].filter(e=>e).join(" ")}static parse(e,t,r={}){var s=oe.lex(e,[" (as )?"],{useRegex:"i"});if(s.tokens.length<3){var i,n=t(s.tokens[0],[le,er]),a=(s.tokens[1]||"").trim(),o=(s.matches[0]||"").trim();if(n instanceof Zt){var h,c=n.toString().split("."),l=c.pop(),u=c.pop();if((h=v(r.DB_FACTORY,u))&&h[l])i=h[l];else{if(!1!==r.validation&&!1!==r.assertTableValidity)throw new Error("Unknown table: "+l+".");i={name:l,fields:{},derived:!0}}}else if(!a)throw new Error("Derived tables must be aliased.");return new this(n,a,o,i)}}}var nr=function(e){return(e=e.slice()).reduce((e,t)=>e+t,e.shift())},ar=function(e){return(e=e.slice()).reduce((e,t)=>Math.max(e,t),e.shift())};class or{constructor(e){Object.defineProperty(this,".params",{value:e})}CONCAT(...e){return e.join("")}CONCAT_WS(...e){return e.join(e.shift())}COALESCE(...e){return e.reduce((e,t)=>o(e)?t:e,null)}FIND_IN_SET(e,t){return t.indexOf(e)}ISNULL(e){return o(e)}COUNT(e,t,r){return"*"===r.stringify()?e.length:this.COLUMN(e,t,r).length}GROUP_CONCAT(e,t,r){return this.COLUMN(e,t,r).join("")}GROUP_CONCAT_WS(e,t,r,s){return this.COLUMN(e,t,s).join(r.eval(this,this[".params"]))}AVG(e,t,r){return(s=this.COLUMN(e,t,r)).length?nr(s)/s.length:0;var s}MAX(e,t,r){return ar(this.COLUMN(e,t,r))}MIN(e,t,r){return(s=(s=this.COLUMN(e,t,r)).slice()).reduce((e,t)=>Math.min(e,t),s.shift());var s}SUM(e,t,r){return nr(this.COLUMN(e,t,r))}FIRST(e,t,r){return r.eval(ie(e)||{},this[".params"])}LAST(e,t,r){return r.eval(ne(e)||{},this[".params"])}ANY_VALUE(e,t,r){return function(e,t=1){for(var r=[],s=null;r.length<t&&(s=e[Math.floor(Math.random()*e.length)])&&-1===r.indexOf(s);)r.push(s);return arguments.length>1?r:r[0]}(this.COLUMN(e,t,r))}GROUPING(e,t,...r){return this.AGGR&&this.AGGR.isRollup?r.reduce((e,t,r)=>this.AGGR.by.filter(e=>{var r=e.stringify(),s=t.stringify();return-1===s.indexOf(".")&&r.indexOf(".")>-1&&(r=z(r,".")),s===r}).length?r+1:e,0):0}COLUMN(e,t,r){var i=e.map(e=>r.eval(e,this[".params"]));if(s(i[0])){var n=i[0].length;i=i.filter(e=>{if(!s(e)||e.length!==n)throw new Error("Aggregate column list not even!");return e.reduce((e,t)=>o(e)?t:e,null)})}return i=i.filter(e=>!o(e)),"DISTINCT"===t.toUpperCase()&&(i=Ee(i)),i}COLUMNS(e,t,r){return r.map(r=>this.COLUMN(e,t,r))}JSON_EXTRACT(e,t){return function(e,t,r={},s={}){t=u(t).slice();for(var i=e;!a(i)&&!o(i)&&t.length;){var n=t.shift();if(!(r.get?r.get(i,n):c(i)?n in i:i[n]))return void(s.exists=!1);i=r.get?r.get(i,n):i[n]}return s.exists=!0,i}(JSON.parse(e),t.split(".").slice(1))}JSON_OBJECT(e,t){return Xt(e,t)}JSON_MERGE(e,t){return C(JSON.parse(e),JSON.parse(t))}}class hr{constructor(e,t,r,s){this.main=e,this.joins=t,this.mainCursor=e.then(e=>e.getCursor()),this.joinCursors=t.map(e=>e.then(e=>e.getCursor())),this.where=r,this.params=s,this._onfinish=[],Promise.all(this.joinCursors).then(e=>{var t=e.reduce((e,t)=>(e&&e.onfinish(t.next.bind(t)),t),null);this.mainCursor.then(e=>{t&&t.onfinish(e.next.bind(e)),e.onfinish(()=>{this.eof=!0,this._onfinish.forEach(e=>e())})})})}onfinish(e){this._onfinish.push(e)}async fetch(){if(this.eof)return;var e,t;let r=await this.main,s=await this.mainCursor,i=await s.fetch(),n=r.params.alias||r.name,a=await Promise.all(this.joins),o=await Promise.all(this.joinCursors),h=o.map(async(e,r)=>{if(!t){var o=await e.fetch(),h=a[r].params.alias||a[r].name;if(!a[r].join||"full"===a[r].join.type)return e.flags[s.key]=!0,o;if("using"===a[r].join.conditionClause.trim().toLowerCase()){var c=a[r].join.condition.stringify();if(o[c]===i[c])return e.flags[s.key]=!0,o}else{var l=new or(this.params);if(l[n]=i,l[h]=o,a[r].join.condition.eval(l,this.params))return e.flags[s.key]=!0,o}if(!e.flags[s.key]){if(e.eof()&&"left"===a[r].join.type.toLowerCase())return{};if(s.eof()&&"right"===a[r].join.type.toLowerCase())return i={},null}t=!0}}),c=await Promise.all(h);if((o[0]||s).next(),c.filter(e=>e).length===h.length){var l=new or(this.params);l[n]=i,c.forEach((e,t)=>{var r=a[t].params.alias||a[t].name;l[r]=e}),e=l}try{if(!e||this.where&&!this.where.eval(e,this.params))return await this.fetch()}catch(e){throw new Error('["'+this.where.stringify()+'" in WHERE clause]: '+e.message)}return e}async syncCursors(){var e=await Promise.all(this.joins.concat(this.main)),t=await Promise.all(this.joinCursors.concat(this.mainCursor));return Promise.all(t.map((t,r)=>e[r].syncCursor(t)))}}class cr{constructor(e,t,r){var s=lr(e,["uac"]);if(this.user=r||{id:0,parent:0,lineage:"0",privileges:[]},this.schema=t,this.alias="MAIN",this.select=[],this.where=[],s.SCHEMAS.uac&&(this.EXPLICIT_TABLE_ACCESS_QUERY={query:ur(s,this.schema.name,this.user),alias:"EXPLICIT_TABLE_ACCESS",on:["EXPLICIT_TABLE_ACCESS.table_row = 0"]}),"row"===s.CONTROL_LEVEL&&(s.SCHEMAS.uac&&(this.EXPLICIT_ROW_ACCESS_QUERY={query:ur(s,this.schema.name,this.user),alias:"EXPLICIT_ROW_ACCESS",on:["EXPLICIT_ROW_ACCESS.table_row = "+this.alias+"."+this.schema.primaryKey]}),this.schema.attributionKey&&s.SCHEMAS.account)){var i=pr(s,this.user,!1);this.AUTHOR_user_RELATIONSHIP_QUERY={query:i,alias:"AUTHOR_user_RELATIONSHIP",on:["AUTHOR_user_RELATIONSHIP."+i.schema.primaryKey+" = "+this.alias+"."+this.schema.attributionKey]}}this.where.push(this.deriveEntityAccess("view")+" <> 0")}deriveEntityAccess(e,t=!1){var r=[];return this.EXPLICIT_ROW_ACCESS_QUERY&&r.push("JSON_EXTRACT("+this.EXPLICIT_ROW_ACCESS_QUERY.alias+'.uac, "$.'+e+'")'),this.EXPLICIT_TABLE_ACCESS_QUERY&&r.push("JSON_EXTRACT("+this.EXPLICIT_TABLE_ACCESS_QUERY.alias+'.uac, "$.'+e+'")'),r.push(fr(mr(this.schema.uac,e),this.getGuestRightsExpression(),t)),"COALESCE("+r.join(", ")+")"}deriveFieldsAccess(e,t,r=!1){var s={};return e.forEach(e=>{var i=[];this.EXPLICIT_ROW_ACCESS_QUERY&&i.push("JSON_EXTRACT("+this.EXPLICIT_ROW_ACCESS_QUERY.alias+'.fields, "$.'+e+".uac."+t+'")'),this.EXPLICIT_TABLE_ACCESS_QUERY&&i.push("JSON_EXTRACT("+this.EXPLICIT_TABLE_ACCESS_QUERY.alias+'.fields, "$.'+e+".uac."+t+'")'),i.push(fr(mr(this.schema.fields[e].uac,t),this.getGuestRightsExpression(),r)),s[e]="COALESCE("+i.join(", ")+")"}),s}getGuestRightsExpression(){var e=[];return this.AUTHOR_user_RELATIONSHIP_QUERY&&(e.push(this.AUTHOR_user_RELATIONSHIP_QUERY.alias+".relationship"),this.AUTHOR_user_TOKEN_QUERY&&e.push("IF("+this.AUTHOR_user_TOKEN_QUERY.alias+'.id, "user", "")')),this.user.privileges.length&&e.push('"'+this.user.privileges.join(",")+'"'),e.length?'CONCAT_WS(",", '+e.join(", ")+")":'""'}toString(){return"SELECT "+this.select.join(", ")+" FROM "+this.schema.name+" AS "+this.alias+(this.EXPLICIT_TABLE_ACCESS_QUERY?" LEFT JOIN ("+this.EXPLICIT_TABLE_ACCESS_QUERY.query+") AS "+this.EXPLICIT_TABLE_ACCESS_QUERY.alias+" ON "+this.EXPLICIT_TABLE_ACCESS_QUERY.on.join(" AND "):"")+(this.EXPLICIT_ROW_ACCESS_QUERY?" LEFT JOIN ("+this.EXPLICIT_ROW_ACCESS_QUERY.query+") AS "+this.EXPLICIT_ROW_ACCESS_QUERY.alias+" ON "+this.EXPLICIT_ROW_ACCESS_QUERY.on.join(" AND "):"")+(this.AUTHOR_user_RELATIONSHIP_QUERY?" LEFT JOIN ("+this.AUTHOR_user_RELATIONSHIP_QUERY.query+") AS "+this.AUTHOR_user_RELATIONSHIP_QUERY.alias+" ON "+this.AUTHOR_user_RELATIONSHIP_QUERY.on.join(" AND "):"")+" WHERE "+this.where.join(" AND ")}}function lr(e,t=[]){var r=C({DB_FACTORY:e.DB_FACTORY,SCHEMAS:{}},e.UAC||{});return t.forEach(e=>{var t=e;r.TABLE_SPECIFIERS&&(t=r.TABLE_SPECIFIERS[e]);var s=t.split("."),i=s.pop(),n=s.pop();r.SCHEMAS[e]=(v(r.DB_FACTORY,n)||{})[i]}),r}function ur(e,t,r){var s='FIND_IN_SET(target, "'+r.lineage.replace("/",",")+'")';return{schema:e.SCHEMAS.uac,select:["*",s+" AS `lineage.target`"],where:["table_name = "+t,"target = "+r.id+" OR "+s],orderBy:"`lineage.target` DESC",limit:1,toString(){return"SELECT "+this.select.join(", ")+" FROM "+this.schema.name+" WHERE "+this.where.join(" AND ")+" ORDER BY "+this.orderBy+" LIMIT "+this.limit}}}function pr(e,t,r=!1){var s={};s.DESCENDANT='FIND_IN_SET(id, "'+t.lineage.replace(t.id+"/","").replace(/\//g,",")+'")',s["DESCENDANT,CHILD"]="id = "+t.parent,s.SIBLING=t.parent+" = parent",s.ANCESTOR="FIND_IN_SET("+t.id+', REPLACE(REPLACE(lineage, CONCAT(id, "/"), ""), "/", ","))',s["ANCESTOR,PARENT"]=t.id+" = parent",s.AUTHOR="id = "+t.id;var i="NULL";return m(s,(e,t)=>{i="IF("+e+', "'+t+'", '+i+")"}),{schema:e.SCHEMAS.account,select:(r?"GROUP_CONCAT(DISTINCT ":"")+i+(r?")":"")+" AS relationship",where:[],toString(){return"SELECT "+this.select+" FROM "+this.schema.name+(this.where.length?" WHERE "+this.where.join(" AND "):"")}}}function fr(e,t,r=!1){var s=B(e[0])?e.shift():null;if(!e.length)return B(s)?parseInt(s):"NULL";var i=[];return e.forEach(e=>{var r=[];e.split("+").forEach(e=>{r.push('FIND_IN_SET("'+e+'", '+t+")")}),i.push("IF("+r.join(" AND ")+', "'+e+'", NULL)')}),i="COALESCE("+i.join(", ")+")",s?"IF(ISNULL("+i+"), 1, 0)":"IF(ISNULL("+i+"), 0, "+(r?i:"1")+")"}function mr(e,t){return i(e)&&(e=e[t]),l(e)?[]:u(e)}class gr{static select(e,t,r,s=[]){(s=u(s)).length&&"*"!==s[0]||(s=Object.keys(t.fields));var i=new cr(e,t,r);return i.select.push(...s),i}static getRelatedAccounts(e,t,r,s=[]){var i=lr(e,["uac","account"]),n={schema:i.SCHEMAS.account,alias:"ACCOUNT",select:[],where:[],orderBy:[],toString(){return"SELECT "+this.select.join(", ")+" FROM "+this.schema.name+" AS "+this.alias+" RIGHT JOIN ("+this.AUTHOR_USER_RELATIONSHIP_QUERY.query+") AS "+this.AUTHOR_USER_RELATIONSHIP_QUERY.alias+" ON "+this.AUTHOR_USER_RELATIONSHIP_QUERY.on.join(" AND ")+" WHERE "+this.where.join(" AND ")+(this.orderBy.length?" ORDER BY "+this.orderBy:"")}};return n.AUTHOR_USER_RELATIONSHIP_QUERY={query:pr(i,t,!1),alias:"AUTHOR_USER_RELATIONSHIP",on:[n.alias+"."+i.SCHEMAS.account.primaryKey+" = AUTHOR_USER_RELATIONSHIP."+i.SCHEMAS.account.primaryKey,"NOT ISNULL(AUTHOR_USER_RELATIONSHIP.relationship)"]},s&&(n.select.push("FIND_IN_SET("+n.alias+"."+i.SCHEMAS.account.primaryKey+', "'+s.join(",")+'") AS priority'),n.orderBy.push("priority DESC")),r&&n.where.push('AUTHOR_USER_RELATIONSHIP.relationship in ("'+r.join('", "')+'")'),n}static getAccessesDoc(e,t,r,s=null,i=null,n=!1,a=!1){if(s&&i)throw new Error("UAC queries must be either over an object and its author (argument #2), or as related to a specific user (argument #3). But not both!");var o=new cr(e,tableName,t);o.AUTHOR_USER_RELATIONSHIP_QUERY&&o.AUTHOR_USER_RELATIONSHIP_QUERY.on.push("NOT ISNULL(AUTHOR_USER_RELATIONSHIP.relationship)"),s?o.where.push(o.schema.primaryKey+" = "+s):o.schema.attributionKey&&i&&(o.where.push(o.schema.attributionKey+" = "+i),o.limit=1),r=r.length&&"*"!==r?u(r):gr.standardAccesses;var h=[],c={},l=n?Object.keys(o.schema.fields):[];if(r.forEach(e=>{h.push('JSON_OBJECT("'+e+'", COALESCE('+cr.deriveEntityAccess(e,a)+"))"),m(cr.deriveFieldsAccess(l,e,a),(t,r)=>{c[t]||(c[t]=[]),c[t].push('JSON_OBJECT("'+e+'", '+r+")")})}),r.length>1?o.select.push("JSON_MERGE("+h.join(", ")+") AS uac"):o.select.push(h.join(", ")+" AS uac"),c.length){var p=[];m(c,(e,t)=>{r.length>1?p.push('JSON_OBJECT("'+e+'", JSON_MERGE('+t.join(", ")+"))"):p.push('JSON_OBJECT("'+e+'", '+t.join(", ")+")")}),o.select.push("JSON_MERGE("+p.join(", ")+") AS fields")}return o}}gr.standardAccesses=["view","create","update","delete","stats","use"];class dr{getBase(e,t={},r=[]){r.length||(r=s(this.exprs.TABLE_REFERENCES)?this.exprs.TABLE_REFERENCES:[this.exprs.TABLE_REFERENCES]);var i=(r=r.concat(this.exprs.JOIN_CLAUSE||[]).map(r=>r.eval(e,t))).shift();return new hr(i,r,this.exprs.WHERE_CLAUSE,t)}getToString(e,t){var r=e.t||0,i=(e=0,t=!0)=>t?"\r\n"+"\t".repeat(Math.max(0,r+e)):"",n={...e};n.t=r+1;var a=[];return m(this.exprs,(e,r,o)=>{if(r||!(o>0)){var h=null;if("JOIN_CLAUSE"===e){var c=this.clauses[e];h=r.map((e,t)=>c[t].toString().toUpperCase()+" "+e.stringify(n)).join(i())}else{c=this.clauses[e].toString().toUpperCase();"TABLE_REFERENCES"===e?h=c+" "+(s(r)?r.map(e=>e.stringify(n)).join(", "):r.stringify(n)):t&&(h=t(e,r,c,n,i))||(h=s(r)?r.map(e=>_isFunction(e.stringify)?e.stringify(n):r).join(", "):c+" "+r.stringify(n))}h||0!==o||(h=c),h&&a.push(i()+h)}}),a.join("")+i(-1)}static getParse(e,t,r,i,n,a,o=null){var h=oe.lex(e,Object.values(r),{useRegex:"i"});if(h.matches.length){var c={},l={},p={},f={},g=[];h.matches.forEach((e,s)=>{var n=jt(r,t=>e.match(new RegExp(t,"i")),!0),o=h.tokens[s+1].trim(),u=null;if("JOIN_CLAUSE"===n){((u=i(o,null,{withUac:t})).type=e.match(new RegExp("(INNER|CROSS|LEFT|RIGHT)","i")))&&(u.type=u.type[0].toLowerCase()),c[n]?(c[n].push(u),l[n].push(e)):(c[n]=[u],l[n]=[e])}else{if("TABLE_REFERENCES"===n||"USING_CLAUSE"===n){var p=oe.split(o,[","]).map(e=>i(e.trim(),[ir],{withUac:t,assertTableValidity:"TABLE_REFERENCES"===n&&!h.matches.includes("USING")}));u=1===p.length?p[0]:p}else if(!a||!(u=a(n,o)))u=i(o,null,{withUac:t});"WHERE_CLAUSE"!==n||c.JOIN_CLAUSE||(c.JOIN_CLAUSE=[],l.JOIN_CLAUSE=[]),c[n]=u,l[n]=e}});const e=c.USING_CLAUSE||c.TABLE_REFERENCES;return(s(e)?e:[e]).concat((c.JOIN_CLAUSE||[]).map(e=>e.table)).forEach((e,t)=>{var r=e.getAlias(),s=e.getSchema();p[r]=e,f[r]=s,0===t&&(p[""]=p[r],f[""]=f[r])}),m(c,(e,t)=>{u(t,!1).reduce((e,t)=>e.concat(t.meta.vars).concat(t.meta.varsUnlodged),[]).forEach(t=>{if("CONTEXT"!==t.role&&g.push(t),!("CONTEXT"===t.role||"CALL_SPECIFIER"===t.role||t instanceof Y)){var r,s;if(t instanceof qt){if(Qt.isIncoming(t+""))return void(t.context?p[t.context+""].associateReference(t):(t.interpreted=i(p[""].getAlias()+"."+t,[Lt]),p[""].associateReference(t)));r=t.name.split("~>")[0].replace(/`/g,"")}else r=t.name.replace(/`/g,"");if(t.context){if(s=t.context.name.replace(/`/g,""),(!f[s]||"*"!==r&&!(r in f[s].fields))&&!1!==n.validation)throw new Error('"'+t+'" in '+e.replace(/_/g," ")+" is unknown!");"*"===r&&(t.interpreted=Object.keys(f[s].fields).map(e=>i(s+"."+e,[Lt])))}else if("*"===r){var a;if(s=p[""].getAlias(),(a=Object.keys(f[""].fields))&&!a.length)throw new Error('The wildcard column specifier (*) cannot used on table "'+s+'"; table defines no columns.');t.interpreted=a.map(e=>i(s+"."+e,[Lt]))}else if(!o||!o(r,e)){if(!(s=Object.keys(f).filter(e=>e).reduce((s,i)=>{if(r in f[i].fields){if(s){if(!1!==n.validation)throw new Error('"'+t+'" in '+e.replace(/_/g," ")+" is ambiguous!");return s}return i}},null))){if(!1!==n.validation)throw new Error('"'+t+'" in '+e.replace(/_/g," ")+" is unknown!");s=p[""].getAlias()}t.interpreted=i(s+"."+t,[Lt])}p[s||""].associateReference(t)}})}),m(p,(e,r)=>{if(e){var s,a=r.getName();if(n.withUac&&!r.isDerivedQuery()&&(r.interpreted=i("("+gr.select(n,f[e],null,r.getAssociateReferences().map(e=>e.name))+") AS "+(e||a),[ir],{withUac:!1})),(s=r.getAssociateReferences().filter(e=>e instanceof qt)).length){var o={},h=[],c=r.getAssociateReferences().filter(e=>!(e instanceof qt)).map(e=>a+"."+e.name);s.forEach(t=>{var r=t.process(f[e],n.DB_FACTORY),s=r.b.table.name+"__by__"+r.b.actingKey;o[s]||(o[s]=r),c.push(s+"."+r.b.select+" AS `"+t.name.replace(/`/g,"")+"`")}),m(o,(e,t)=>{h.push("LEFT JOIN "+t.b.table.name+" AS "+e+" ON "+e+"."+t.b.actingKey+" = "+a+"."+t.a.actingKey)});var l="(SELECT"+(t?" WITH UAC":"")+" "+Ee(c).join(", ")+" FROM "+a+" "+h.join(" ")+") AS "+r.getAlias();(r.interpreted||r).interpreted=i(l,[ir],{withUac:t})}}}),{exprs:c,clauses:l,tables:p,schemas:f,vars:g}}}}class Er extends(Nt(dr,Vt)){constructor(e,t,r){super(),this.exprs=e,this.clauses=t,this.withUac=r}async eval(e,t={}){var r,i=this.exprs.TABLE_REFERENCES;this.exprs.DELETE_LIST.length?r=this.exprs.DELETE_LIST.map(e=>e.endsWith(".*")?Z(e,".*"):e):this.exprs.USING_CLAUSE?(r=u(this.exprs.TABLE_REFERENCES,!1).map(e=>e.getAlias()),i=this.exprs.USING_CLAUSE):r=[(s(i)?i[0]:i).getAlias()];var n={...t};n.mode="readwrite",this.base=this.getBase(e,n,u(i,!1));var a,o={},h={},c=await Promise.all(this.base.joins.concat(this.base.main));for(r.forEach(e=>{if(o[e]=c.filter(t=>(t.params.alias||t.name)===e)[0],!o[e])throw new Error('"'+e+'" in table list is not found in main query.')});a=await this.base.fetch();)r.forEach(e=>{h[e]||(h[e]=[]);var t=u(o[e].schema.primaryKey).map(t=>a[e][t]);h[e].filter(e=>x(e,(e,r)=>e===t[r])).length||h[e].push(t)});var l=await Promise.all(r.map(e=>{if(h[e].length)return o[e].deleteAll(h[e])}));return{tables:c.map(e=>e.name),keys:l}}toString(){return this.stringify()}stringify(e={}){return this.getToString(e)}static parse(e,t,r={}){if("delete"===e.trim().substr(0,6).toLowerCase()){var s=!1;e.match(/DELETE[ ]+WITH[ ]+UAC/i)&&(s=!0,e=e.replace(/[ ]+WITH[ ]+UAC/i,""));var i=super.getParse(e,s,this.clauses,t,r,(e,t)=>{if("DELETE_LIST"===e)return t.split(",").map(e=>e.trim()).filter(e=>e)});if(i.exprs.DELETE_LIST.length&&i.exprs.USING_CLAUSE)throw new Error('The "using" keyword cannot be used in a query with explicitly-listed tables.');return new this(i.exprs,i.clauses,s)}}}Er.clauses={DELETE_LIST:"DELETE",TABLE_REFERENCES:"FROM",USING_CLAUSE:"USING",WHERE_CLAUSE:"WHERE",JOIN_CLAUSE:"(INNER[ ]+|CROSS[ ]+|(LEFT|RIGHT)([ ]+OUTER)?[ ]+)?JOIN"};const yr=class extends M{};Object.defineProperty(yr.prototype,"jsenType",{get:()=>"FieldExpression"});var vr=yr;class Sr extends vr{constructor(e,t,r=!1){super(),this.expr=e,this.alias=t,this.claused=r}as(e){return this.alias=e,this.claused=!0,this}getContextName(){return this.expr.interpreted?s(this.expr.interpreted)?this.expr.interpreted[0].context.name:this.expr.interpreted.context.name:this.expr.context?(this.expr.context.name||"").replace(/`/g,""):""}getName(){return(this.expr.name||"").replace(/`/g,"")}getAlias(){return(this.alias||"").replace(/`/g,"")||this.getName()||this.expr.toString()}getCallExprs(){return this.expr.meta.vars.concat(this.expr.meta.varsUnlodged).concat([this.expr]).filter(e=>e instanceof Y)}getAggrExprs(){return this.expr.meta.vars.concat(this.expr.meta.varsUnlodged).concat([this.expr]).filter(e=>e instanceof kt)}eval(e,t,r={}){var s,i=this.getAlias();if(this.expr instanceof G){if("*"===this.getName()){var n=this.expr.getEval(e,r);return m(n,(e,t)=>{"readwrite"===r.mode?Object.defineProperty(n,e,{get:()=>t.get(),set:e=>(t.set(e),!0),enumerable:!0}):n[e]=t.get()}),n}var a=this.expr.getEval(e,r);return"readwrite"===r.mode?{get[i](){return a.get()},set[i](e){return a.set(e),!0}}:Xt(i,a.get())}return s=this.expr instanceof ce?this.expr.eval(t,r):this.expr.eval(e,r),"readwrite"===r.mode?{get[i](){return s},set[i](e){throw new Error('"'+i+'" cannot be modified; not a reference!')}}:Xt(i,s)}stringify(e={}){return[this.expr.stringify(e),this.claused?"AS":"",this.alias].filter(e=>e).join(" ")}static parse(e,t,r={}){var s=oe.split(e,[" (as )?"],{useRegex:"i",preserveDelims:!0}),i=null,n=s.pop().trim(),a="as "===n.substr(0,3).toLowerCase();if(a)n=n.substr(3).trim(),i=t(s.join("").trim());else if(s.length&&(!n.match(/[^0-9a-zA-Z_]/)||R(n,"`","`")))try{i=t(s.join("").trim())}catch(e){}return i||(n=null,i=t(e)),i.isFieldName=!0,new this(i,n,a)}}const wr=class extends M{};Object.defineProperty(wr.prototype,"jsenType",{get:()=>"GroupByExpression"});var Tr=wr;class Or extends Tr{constructor(e,t=null,r=!1){super(),this.columns=e,this.having=t,this.withRollup=r}eval(e,t={}){var r=(e,i,n)=>{if(i.length){var a={};e.forEach(e=>{var r=i[0].eval(e,t);a[r]=a[r]||[],a[r].push(e)}),Object.values(a).map(e=>r(e,i.slice(1),n))}if(!i.length||this.withRollup){var o=new or(t);return Dt(o,e[0]),o.$=function(e,t=[],r=!0){var i=0;return f(arguments[0])&&c(arguments[1])&&(i=arguments[0],e=arguments[1],t=arguments[2]||[]),O([i,{},e],(e,r,i)=>S(t)?t(e):!s(t)||!t.length||t.indexOf(e)>-1,!1,!1,r)}(o.$),o.AGGR={rows:e,by:i},o.AGGR.isRollup=i.length&&this.withRollup,o.AGGR.isRollup&&i.forEach(e=>{(e=e.stringify().indexOf(".")>-1?z(e.stringify(),"."):e.stringify())in o.$&&(o.$[e]=null)}),n.push(o),o}},i=[];return r(e,this.columns.slice(),i),i}toString(){return this.stringify()}stringify(e={}){var t=[this.columns.map(t=>t.stringify(e)).join(", ")];return this.withRollup&&t.push("WITH ROLLUP"),this.having&&t.push("HAVING "+this.having.stringify(e)),t.join(" ")}static parse(e,t,r={}){var s=oe.lex(e,["WITH[ ]+ROLLUP","HAVING"],{useRegex:"i"}),i=oe.split(s.tokens.shift().trim(),[","]).map(e=>t(e.trim())),n=null,a=!1;return s.matches.forEach(e=>{e.toLowerCase().startsWith("with")?(a=!0,s.tokens.shift()):e.toLowerCase().startsWith("having")&&(n=t(s.tokens.shift().trim()))}),new this(i,n,a)}}const Cr=class extends ${};Object.defineProperty(Cr.prototype,"jsenType",{get:()=>"InsertStatement"});var _r=Cr;class Ar extends _r{constructor(e,t,r,s,i,n,a){super(),this.TABLE_REFERENCES=e,this.COLUMNS_LIST=t,this.VALUES_LIST=r,this.WITH_UAC=s,this.IGNORE=i,this.INSERT_TYPE=n,this.UPDATE_CLAUSE=a}async eval(e,t={}){var r={...t};r.mode="readwrite";var s=await this.TABLE_REFERENCES.eval(e,r),i=s.schema,n=this.VALUES_LIST,a=this.INSERT_TYPE.toUpperCase(),o="TABLE"===a;if("SET"===a){var h=n.map(e=>e.reference.name);n=[n.map(e=>e.val.eval({},t))]}else{h=this.COLUMNS_LIST||(i.fields?Object.keys(i.fields):[]);if("SELECT"===a)try{n=(await n.eval(e,t)).map(e=>Object.values(e))}catch(e){throw new Error('["'+n.stringify()+'" in SELECT clause]: '+e.message)}else{if("VALUES"!==a)throw new Error('Invalid insert statement "'+this+'"!');n=n.map(e=>e.map(e=>e.eval({},t)))}}h=h.map(e=>e+"");var c=this.UPDATE_CLAUSE?e=>{var r={...t};return r.strictMode=!1,this.UPDATE_CLAUSE.forEach(t=>t.eval({$:e},r)),!0}:this.IGNORE?()=>!1:null,l=await s.addAll(n,h,c,o);return{table:s.name,keys:l}}toString(){return this.stringify()}stringify(e={}){var t=e.t||0,r=(e=0)=>"\r\n"+"\t".repeat(Math.max(0,t+e)),s={...e};s.t=t+1;var i=[this.TABLE_REFERENCES.stringify(s)];return"SET"===this.INSERT_TYPE.toUpperCase()?i.push(r(1)+"SET "+this.VALUES_LIST.map(e=>e.stringify(s)).join(", ")):(this.COLUMNS_LIST.length&&i.push("("+this.COLUMNS_LIST.join(", ")+")"),"SELECT"===this.INSERT_TYPE.toUpperCase()?i.push(this.VALUES_LIST.stringify(s)):i.push(r()+"VALUES "+r(1)+"("+this.VALUES_LIST.map(e=>e.map(e=>e.stringify(s)).join(", ")).join("),"+r(1)+"(")+")")),this.UPDATE_CLAUSE&&i.push(r()+"ON DUPLICATE KEY UPDATE "+this.UPDATE_CLAUSE.map(e=>e.stringify(s)).join(", ")),"INSERT "+(this.IGNORE?"IGNORE ":"")+"INTO "+i.join(" ")}static parse(e,t,r={}){if(e.trim().match(/^INSERT([ ]+WITH[ ]+UAC)?([ ]+IGNORE)?([ ]+INTO)?/,"i")){var s=!1,i=!1;e.match(/INSERT[ ]+WITH[ ]+UAC/i)&&(s=!0,e=e.replace(/[ ]+WITH[ ]+UAC/i,"")),e.match(/INSERT[ ]+IGNORE/i)&&(i=!0,e=e.replace(/[ ]+IGNORE/i,""));var n=oe.lex(e,Object.values(Ar.clauses),{useRegex:"i"});n.tokens.shift();var a=n.tokens.shift().trim(),o=[],h=n.tokens.shift(),c=n.matches[1].toUpperCase();if("SET"===c)a=t(a,[ir]),h=oe.split(h.trim(),[","]).map(e=>t(e.trim(),[xe]));else{var l=oe.split(a,[" "]);a=t(l.shift().trim(),[ir]),l.length&&(o=l[0].trim(),o=oe.split(R(o,"(",")")?te(o,"(",")"):o,[","]).map(e=>e.trim())),h="SELECT"===c?t("SELECT "+h.trim()):oe.split(h.trim(),[","]).map(e=>oe.split(te(e.trim(),"(",")"),[","]).map(e=>t(e.trim())))}var u=n.tokens.shift();u&&(u=oe.split(u.trim(),[","]).map(e=>t(e.trim(),[xe])));var p=new this(a,o,h,s,i,c,u);return p.parseCallback=t,p}}}Ar.clauses={TABLE_REFERENCES:"INSERT([ ]+IGNORE)?([ ]+INTO)?",VALUES_LIST:"(VALUES|VALUE|SET|SELECT)",UPDATE_CLAUSE:"ON[ ]+DUPLICATE[ ]+KEY[ ]+UPDATE"};const xr=class extends M{};Object.defineProperty(xr.prototype,"jsenType",{get:()=>"JoinConstruct"});var Rr=xr;class Ir extends Rr{constructor(e,t,r){super(),this.table=e,this.condition=t,this.conditionClause=r}eval(e,t={}){return this.table.eval(e,t).then(e=>(e.join={type:this.type,condition:this.condition,conditionClause:this.conditionClause},e))}getName(){return this.table.getName()}getAlias(){return this.table.getAlias()}toString(){return this.stringify()}stringify(e={}){return[this.table.stringify(e),this.conditionClause,this.condition.stringify(e)].join("")}static parse(e,t,r={}){var s=oe.lex(e,Ir.clauses);if(2===s.tokens.length){var i=s.matches[0];return new this(t(s.tokens[0],[ir]),"USING"===i.trim().toUpperCase()?t(s.tokens[1],[er]):t(s.tokens[1]),i)}}}Ir.clauses=[" on "," using "," ON "," USING "];const br=class extends M{};Object.defineProperty(br.prototype,"jsenType",{get:()=>"Placeholder"});var Lr=br;const Nr=class extends ${};Object.defineProperty(Nr.prototype,"jsenType",{get:()=>"SelectStatement"});var Ur=Nr;class jr extends(Nt(dr,Ur)){constructor(e,t,r=!1,s=[],i=[]){super(),this.exprs=e,this.clauses=t,this.withUac=r,this.flags=s,this.vars=i}getFields(e=!1){return this.exprs.SELECT_LIST}getTable(){return this.exprs.TABLE_REFERENCES}getSources(e=!1){var t=this.getJoins()||[];return u(this.exprs.TABLE_REFERENCES,!1).concat(e?t.map(e=>e.table):t)}getWhere(){return this.exprs.WHERE_CLAUSE}getJoins(){return this.exprs.JOIN_CLAUSE}getGroupBy(){return this.exprs.GROUP_BY_CLAUSE}getWindows(){return this.exprs.WINDOWS_CLAUSE}getOrderBy(){return this.exprs.ORDER_BY_CLAUSE}getOffset(){return this.exprs.OFFSET_CLAUSE}getLimit(){return this.exprs.LIMIT_CLAUSE}async eval(e,t={}){this.base=this.getBase(e,t);for(var r,s=[];r=await this.base.fetch();)s.push(r);var i=(r,s,i=null)=>(i&&(i={aggr:[],win:[]}),r.forEach(r=>{r.$||(r.$={}),s.forEach(s=>{if(i){var n=s.getAggrExprs();if(n.length)return w(n.filter(e=>e.window).length?i.win:i.aggr,s),void(s.getAlias()in r.$||(r.$[s.getAlias()]=void 0))}var a=s.eval(r,e,t);Object.keys(a).forEach(e=>{Object.defineProperty(r.$,e,Object.getOwnPropertyDescriptor(a,e))})})}),i),n={aggr:[],win:[]};this.vars.forEach(e=>{e instanceof kt&&w(e.window?n.win:n.aggr,e)});var a=i(s,this.getFields(),!0);if(this.exprs.GROUP_BY_CLAUSE||n.aggr.length){var o=this.exprs.GROUP_BY_CLAUSE||new Or([]);i(s=o.eval(s,t),a.aggr)}if(this.exprs.WINDOWS_CLAUSE||n.win.length){var h=[];n.win.forEach(e=>{var r=e.window.stringify();-1===h.indexOf(r)&&(e.window.eval(s,this.exprs.WINDOWS_CLAUSE,t),h.push(r))}),i(s,a.win)}if(this.exprs.ORDER_BY_CLAUSE&&(s=this.exprs.ORDER_BY_CLAUSE.eval(s,t)),this.flags.includes("DISTINCT")&&(s=s.filter((e,t)=>t===jt(s,t=>_even(t,e)))),this.exprs.OFFSET_CLAUSE||this.exprs.LIMIT_CLAUSE){var c=this.exprs.LIMIT_CLAUSE?this.exprs.LIMIT_CLAUSE.slice():[],l=this.exprs.OFFSET_CLAUSE||(2===c.length?c.shift():0);s=c.length?s.slice(l,l+c[0]):s.slice(l)}return s.map(e=>e.$)}toString(){return this.stringify()}stringify(e={}){return this.getToString(e,(e,t,r,s)=>"SELECT_LIST"===e?r+" "+t.map(e=>e.stringify(s)).join(", "):"WINDOWS_CLAUSE"===e?r+" "+Object.keys(t).map(e=>e+" AS "+t[e].stringify(s)).join(", "):"GROUP_BY_CLAUSE"===e||"ORDER_BY_CLAUSE"===e?r+" "+t.stringify(s):"LIMIT_CLAUSE"===e?r+" "+t.join(", "):void 0)}static parse(e,t,r={}){if("select"===e.trim().substr(0,6).toLowerCase()){var s=!1;e.match(/SELECT[ ]+WITH[ ]+UAC/i)&&(s=!0,e=e.replace(/[ ]+WITH[ ]+UAC/i,""));var i=[],n=super.getParse(e,s,this.clauses,t,r,(e,r)=>{if("SELECT_LIST"===e)return oe.split(r,[","]).map(e=>{e=t(e.trim(),[Sr]);return i.push(e.getAlias()),e});if("WINDOWS_CLAUSE"===e){var s={};return oe.split(r,[","]).forEach(e=>{var r=e.split(new RegExp(" as ","i"));s[r[0].trim()]=t(r[1].trim(),[Gt])}),s}return"GROUP_BY_CLAUSE"===e?t(r,[Or]):"ORDER_BY_CLAUSE"===e?t(r,[Ht]):"LIMIT_CLAUSE"===e?r.split(",").map(e=>parseInt(e)):void 0},(e,t)=>("ORDER_BY_CLAUSE"===t||"GROUP_BY_CLAUSE"===t)&&i.includes(e));return new this(n.exprs,n.clauses,s,n.clauses.SELECT_LIST.replace(/SELECT/i,"").split(" ").filter(e=>e),n.vars)}}}jr.clauses={SELECT_LIST:"SELECT([ ]+(ALL|DISTINCT))?",TABLE_REFERENCES:"FROM",WHERE_CLAUSE:"WHERE",JOIN_CLAUSE:"(INNER[ ]+|CROSS[ ]+|(LEFT|RIGHT)([ ]+OUTER)?[ ]+)?JOIN",GROUP_BY_CLAUSE:"GROUP[ ]+BY",WINDOWS_CLAUSE:"WINDOW",ORDER_BY_CLAUSE:"ORDER[ ]+BY",OFFSET_CLAUSE:"OFFSET",LIMIT_CLAUSE:"LIMIT"};const Pr=class extends M{};Object.defineProperty(Pr.prototype,"jsenType",{get:()=>"UnionConstruct"});var kr=Pr;const Dr=class extends ${};Object.defineProperty(Dr.prototype,"jsenType",{get:()=>"UpdateStatement"});var Br=Dr;class Fr extends(Nt(dr,Br)){constructor(e,t,r){super(),this.exprs=e,this.clauses=t,this.withUac=r}async eval(e,t={}){var r,s={...t};for(s.mode="readwrite",this.base=this.getBase(e,s);r=await this.base.fetch();)this.exprs.ASSIGNMENT_LIST.forEach(e=>e.eval(r,t));var i=await this.base.syncCursors();return{tables:await Promise.all(this.base.joins.concat(this.base.main)).then(e=>e.map(e=>e.name)),keys:i}}toString(){return this.stringify()}stringify(e={}){return this.getToString(e,(e,t,r,s,i)=>{if("ASSIGNMENT_LIST"===e)return r+" "+t.map(e=>e.stringify(s)).join(", ")})}static parse(e,t,r={}){if("update"===e.trim().substr(0,6).toLowerCase()){var s=!1;e.match(/UPDATE[ ]+WITH[ ]+UAC/i)&&(s=!0,e=e.replace(/[ ]+WITH[ ]+UAC/i,""));var i=super.getParse(e,s,this.clauses,t,r,(e,r)=>{if("ASSIGNMENT_LIST"===e)return oe.split(r,[","]).map(e=>t(e.trim(),[xe]))});return new this(i.exprs,i.clauses,s)}}}Fr.clauses={TABLE_REFERENCES:"UPDATE",ASSIGNMENT_LIST:"SET",WHERE_CLAUSE:"WHERE",JOIN_CLAUSE:"(INNER[ ]+|CROSS[ ]+|(LEFT|RIGHT)([ ]+OUTER)?[ ]+)?JOIN"};var Wr={Union:class extends kr{constructor(e,t,r=null,s=null){super(),this.query=e,this.queries=t,this.orderBy=r,this.limit=s}toString(){return this.stringify()}stringify(e={}){var t=[[this.query.stringify(e)].concat(this.queries.map(t=>(t.onDuplicate?t.onDuplicate.toUpperCase()+" ":"")+t.select.stringify(e))).join(" UNION ")];return this.orderBy&&t.push("ORDER BY "+this.orderBy.stringify(e)),this.limit&&t.push("LIMIT "+this.limit.join(", ")),t.join(" ")}static parse(e,t,r={}){var s,i={useRegex:"i"};if((s=oe.lex(e,[" UNION([ ]+(ALL|DISTINCT))? "],i))&&s.matches.length){var n=s.tokens,a=s.matches,o=null,h=null;if(n[0].trim().startsWith("(")){var c=oe.lex(n.pop(),["ORDER[ ]+BY","LIMIT"],i);n.push(c.tokens.shift()),c.matches.forEach(e=>{var r=c.tokens.shift().trim();e.toUpperCase().startsWith("ORDER")?o=t(r,[Ht]):e.toUpperCase().startsWith("LIMIT")&&(h=r.split(",").map(e=>parseInt(e)))})}return new this(t(n.shift().trim()),n.map((e,r)=>({select:t(e.trim()),onDuplicate:(a[r].match(new RegExp("ALL|DISTINCT","i"))||[])[0]})),o,h)}}},Select:jr,Insert:Ar,Update:Fr,Delete:Er,Join:Ir,Abstraction:le,Condition:class extends Ze{constructor(e,t,r){super(),this.assertion=e,this.onTrue=t,this.onFalse=r}toString(){return this.stringify()}stringify(e={}){return"IF ("+[this.assertion.stringify(e),this.onTrue.stringify(e),this.onFalse.stringify(e)].join(", ")+")"}static parse(e,t,r={}){if(e.match(/^if[ ]*?\(/i)){var s=oe.split(te(e.trim().substr(2).trim(),"(",")"),[","]);if(3!==s.length)throw new Error("Malformed condition expression: "+e+"!");return new this(...s.map(e=>t(e.trim())))}}},Assertion:It,Comparison:bt,Math:lt,Num:ut,Str:Tt,Bool:$e,Void:_t,Aggr:Kt,Call:qe,Placeholder:class extends Lr{constructor(e,t){super(),this.name=f(e)?parseInt(e):e,this.notation=t}eval(e,t={}){if("number"==typeof this.name){if(!t.vars)throw new Error('Annonymous placeholders require a "params.vars" array to be resolved.');return t.vars[this.name]}if(!t.vars)throw new Error('Named placeholders require a "params.vars" object to be resolved.');return t.vars[this.name]}toString(){return this.stringify()}stringify(e={}){return"?"===this.notation?"?":this.notation+this.name}static parse(e,t,r={}){if(e.startsWith("?")||e.startsWith(":"))return new this(e.substr(1),e.substr(0,1))}},ArrowReference:Qt,ArrowReference:Qt,Reference:Lt};Rt.grammar=Wr;var Mr=Rt;class Hr extends y{static async _query(e,t={}){return t.DB_FACTORY=this,Mr.parse(e,null,t).eval(this)}static async list(){return Object.keys(this.databases).map(e=>({name:e,version:0}))}static async open(e=this.defaultDB,t=0){return new k(this.databases[e],this.schema[e])}static async _create(e,t,r=null){return this.databases[e]||(this.databases[e]={}),(t||[]).length&&t.forEach(t=>{this.databases[e][t.name]||(this.databases[e][t.name]=[])}),new k(this.databases[e],this.schema[e])}static async _drop(e){return delete this.databases[e],!0}}Hr.databases={};class Gr extends L{constructor(e){super([]),this._store=e,this._storeFetch=new Promise(async e=>{(await this._store).getAll().onsuccess=t=>{this.cache=u(t.target.result),e()}})}async fetch(){return await this._storeFetch,super.fetch()}}class Kr{constructor(e){this._store=e,this.cache=[],this.key=0,this._onfinish=[],this.flags={}}onfinish(e){this._onfinish.push(e)}next(){if(this._eof){if(!this.cache.length||this.key===this.cache.length-1)return this._onfinish.forEach(e=>e()),void(this.key=0);this.key++}else{if(!this._cursorRequest)throw new Error("fetch() must be called before calling next()");this.key++}}eof(){return this._eof&&(!this.cache.length||this.key===this.cache.length-1)}async fetch(){var e=await this._store;return new Promise(t=>{this._eof||this.key<this.cache.length?t(this.cache[this.key]):this._countRequest?(this._handleCursorFetch(t),this._continueCursor()):(this._countRequest=e.count(),this._countRequest.onsuccess=r=>{this._count=r.target.result,this._cursorRequest=e.openCursor(),this._handleCursorFetch(t),this._continueCursor=()=>this._cursor.continue()})})}_handleCursorFetch(e){this._cursorRequest.onsuccess=t=>{if(this._cursor=t.target.result,this._cursor){var r=this._cursor.value;this.cache.push(r),this.cache.length===this._count&&(this._eof=!0),e(r)}else this._eof=!0,e()}}}class Yr extends I{getCursor(){return new Gr(this.store())}getProgressiveCursor(){return new Kr(this.store())}getAll(){return new Promise(async(e,t)=>{var r=(this.tx_store||this.store("readonly")).getAll();r.onsuccess=t=>e(u(t.target.result)),r.onerror=e=>t(e.target.error)})}get(e){return new Promise(async(t,r)=>{e=f(e)?parseInt(e):e;var s=(this.tx_store||this.store("readonly")).get(e);s.onsuccess=e=>t(e.target.result),s.onerror=e=>r(e.target.error)})}count(...e){return new Promise(async(t,r)=>{var s=this.store().count(...e);s.onsuccess=e=>t(e.target.result),s.onerror=e=>r(e.target.error)})}addAll(e,t=[],r=null){return this.tx_store=this.store(),super.addAll(...arguments)}add(e){return new Promise(async(t,r)=>{var s=(this.tx_store||this.store()).add(e);s.onsuccess=e=>t(e.target.result),s.onerror=e=>{var t=e.target.error;"ConstraintError"===t.name?r(new _(t.message)):r(t)}})}putAll(e){return this.tx_store=this.store(),super.putAll(...arguments)}put(e){return new Promise(async(t,r)=>{var s=(this.tx_store||this.store()).put(e);s.onsuccess=e=>t(e.target.result),s.onerror=e=>r(e.target.error)})}deleteAll(e){return this.tx_store=this.store(),super.deleteAll(...arguments)}delete(e){if(s(e)){if(e.length>1)throw new Error("IDB does not support Composite Primary Keys");e=e[0]}return e=f(e)?parseInt(e):e,new Promise(async(t,r)=>{var s=(this.tx_store||this.store()).delete(e);s.onsuccess=r=>t(e),s.onerror=e=>r(e.target.error)})}}class $r extends g{async list(){return u(this.database.objectStoreNames)}open(e,t="readonly",r={}){return r.mode=t,new Yr(r=>this.database.transaction([e],r||t).objectStore(e),e,this.schema[e],r)}_create(e,t,r=null){return new Promise(s=>{var i;qr(this.name,this.version,t=>{if(!i)throw new Error('Store name "'+e+'" could not be created!');s(this.open(e,"readwrite"))},e=>{i=Qr(e.target.result,[t],r)[0]},!0)})}_drop(e){return new Promise(t=>{var r;qr(this.name,this.version,s=>{if(!r)throw new Error('Store name "'+e+'" could not be deleted!');t(!0)},t=>{r=!0;var s=t.target.result;if(!s.objectStoreNames.contains(e))throw new Error('Store name "'+e+'" does not exist!');s.deleteObjectStore(e)},!0)})}}const qr=(e,t,r,s,i=!1)=>{if("undefined"==typeof indexedDB)throw new Error("IndexedDB is not available in the current environment.");(async()=>{if(i){var n=(await IDBSchema._getDatabases()).filter(t=>t.name===e).map(e=>e.version);if(n.length){var a=parseInt(ar(n));t<=a&&(t=a+1)}}var o=indexedDB.open(e,t);o.onsuccess=r,o.onupgradeneeded=s})()},Qr=(e,t,r)=>t.map(t=>{var s;if(t.driver||(t.driver="IDB"),e.objectStoreNames.contains(t.name)){if(!r)throw new Error('Store name "'+t.name+'" already exists!');"drop"===r?e.deleteObjectStore(t.name):s=!0}var i,n={};if(t.primaryKey&&(n.keyPath=t.primaryKey,t.autoIncrement&&(n.autoIncrement=!0)),s){var a=e.transaction([t.name],"readwrite");i=a.objectStore(t.name)}else i=e.createObjectStore(t.name,n);return t.uniqueKeys&&m(t.uniqueKeys,(e,t)=>{i.indexNames.contains(e)&&i.deleteIndex(e),i.createIndex(e,t,{unique:!0})}),i});const Jr=()=>{if("undefined"==typeof indexedDB)throw new Error("IndexedDB is not available in the current environment.")};window.WQ||(window.WQ={}),window.WQ.ObjectiveSQL={ODB:Hr,IDB:class extends y{static async _query(e,t={}){return t.DB_FACTORY=this,Mr.parse(e,null,t).eval(this)}static async list(){return Jr(),u(await indexedDB.databases())}static open(e=this.defaultDB,t=1){return Jr(),new Promise(r=>{indexedDB.open(e,t).onsuccess=t=>{r(new $r(t.target.result,this.schema[e]))}})}static _create(e,t,r=!1){return Jr(),new Promise(r=>{var s=indexedDB.open(e);(t||[]).length&&(s.onupgradeneeded=e=>{Qr(e.target.result,t)}),s.onsuccess=t=>r(new $r(t.target.result,this.schema[e]))})}static _drop(e){return Jr(),new Promise(t=>{indexedDB.deleteDatabase(e).onsuccess=e=>t(!0)})}}}}]);
//# sourceMappingURL=main.js.map