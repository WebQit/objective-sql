!function(t){var e={};function r(s){if(e[s])return e[s].exports;var n=e[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=t,r.c=e,r.d=function(t,e,s){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(r.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)r.d(s,n,function(e){return t[e]}.bind(null,n));return s},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=0)}([function(t,e,r){"use strict";r.r(e);var s=function(t){return Array.isArray(t)},n=function(t){return"function"==typeof t},i=function(t){return n(t)||t&&"[object function]"==={}.toString.call(t)},a=function(t){return!Array.isArray(t)&&"object"==typeof t&&t},o=function(t){return Array.isArray(t)||"object"==typeof t&&t||n(t)},l=function(t){return!0!==t&&!1!==t&&null!==t&&""!==t&&!isNaN(1*t)},h=function(t,e){var r=[];return function(t,e){e=(e=e||Object.prototype)&&!s(e)?[e]:e;var r=[];for(t=t;t&&(!e||e.indexOf(t)<0)&&"default"!==t.name;)r.push(t),t=t?Object.getPrototypeOf(t):null;return r}(t,e).forEach(t=>{!function(t,...e){e.forEach(e=>{t.indexOf(e)<0&&t.push(e)})}(r,...Object.getOwnPropertyNames(t))}),r};function c(t,e,r=!1,n=!1,u=!0){var p=0,f=t.shift();if((l(f)||!0===f||!1===f)&&(p=f,f=t.shift()),!t.length)throw new Error("_merge() requires two or more array/objects.");return t.forEach((t,g)=>{(o(t)||i(t))&&(r?h(t):Object.getOwnPropertyNames(t)).forEach(i=>{var o=f[i],h=t[i];if((s(o)&&s(h)||a(o)&&a(h))&&(!0===p||p>0))f[i]=s(o)&&s(h)?[]:{},c([l(p)?p-1:p,f[i],o,h],e,r,n,u);else if(e(i,f,t,g))if(s(f)&&s(t))n?f[i]=h:f.push(h);else try{u?Object.defineProperty(f,i,Object.getOwnPropertyDescriptor(t,i)):f[i]=t[i]}catch(t){}})}),f}var u=function(...t){return c(t,(t,e,r)=>!0,!1,!1,!1)},p=function(t){return null===t||""===t},f=function(t){return arguments.length&&(void 0===t||void 0===t)},g=function(t,e){if(!t)return!1;if(t instanceof e)return!0;var r=t=>{for(;t&&t!==Function.prototype;){if(t===e||t.prototypes&&t.prototypes.reduce((t,s)=>t||s===e||r(s),!1))return!0;t=Object.getPrototypeOf(t)}return!1};return r(t.constructor)},v=function(t){return"number"==typeof t},m=function(t){return a(t)&&Object.getPrototypeOf(t)===Object.prototype},d=function(t){return!0===t||!1===t},E=function(t,e){var r=void 0;return o(t)&&Object.keys(t).forEach((s,n)=>{!1!==r&&(r=e(l(s)?parseFloat(s):s,t[s],n))}),r};const S=function(t,e,r=!0,n=1){if(s(t)&&s(e)&&t.length!==e.length)return!r;if(a(t)&&a(e)){var l=Object.keys(t),h=Object.keys(e);if(!l.length&&!h.length)return m(t)&&m(e)?r:t===e===r;if(!S(l,h))return!r}if(n>0&&(s(t)&&s(e)||a(t)&&a(e))){var c=function(t,e,r=!0,n=!0,i=!1,l=!1){if(s(t)&&s(e)){var h=[],c=!0;return t.forEach(t=>{if(c){var u=!1;E(e,(e,i)=>{(!u||n&&o(t))&&(u=r(t,i),(s(u)&&!u.length||a(u)&&!Object.keys(u).length)&&(u=!1),o(u)&&n&&(t=u))}),o(u)?h.push(n?u:t):d(u)?i&&!u||!i&&u?h.push(t):l&&(c=!1):h.push(u)}}),h}if(a(t)&&a(e)){h={},c=!0;return Object.keys(t).forEach(u=>{if(c){var p=r(t[u],e[u]);(s(p)&&!p.length||a(p)&&!Object.keys(p).length)&&(p=!1),o(p)?h[u]=n?p:t[u]:d(p)?i&&!p||!i&&p?h[u]=t[u]:l&&(c=!1):h[u]=p}}),h}}(t,e,(t,e)=>S(t,e,r,n-1),!1,!1,!0);return s(c)?c.length===t.length&&c.length===e.length:a(c)&&a(t)?Object.keys(c).length===Object.keys(t).length&&Object.keys(c).length===Object.keys(e).length:c}return i(r)?r(t,e):v(t)&&v(e)&&isNaN(t)&&isNaN(e)?r:t===e===r};var y=S,O=class{even(t){return!(!a(t)||t.jsenType!==this.jsenType)&&y(t,this)}inherit(t){return this}withComments(t){return this.meta||(this.meta={}),this.meta.comments=t,this}withVars(t){return this.meta||(this.meta={}),this.meta.vars=t,this}};const x=class extends O{};Object.defineProperty(x.prototype,"jsenType",{get:()=>"Reference"});var w=x;const b=class extends O{};Object.defineProperty(b.prototype,"jsenType",{get:()=>"CallExpression"});var T=b;const C=class extends O{};Object.defineProperty(C.prototype,"jsenType",{get:()=>"FunctionType"});var R=C;const j=class extends O{};Object.defineProperty(j.prototype,"jsenType",{get:()=>"IfConditional"});var A=j;const I={};class N{static parse(t,e,r={},s=N){if(t.length){var n;if(I[t]&&!e&&!1!==r.allowCache)if(n=s.parseOne(t,I[t],r,s))return n;for(var i=Object.values(e||s.grammars),a=0;a<i.length;a++){var o=s.parseOne(t,i[a],r,s);if(o)return e||!1===r.allowCache||(I[t]=i[a]),o}if(!1===r.assert)return;throw new Error("[Syntax error:] "+t)}}static parseOne(t,e,r={},n=N){var i=[],a=e.parse(t,(t,e,s={})=>{var a=n.parse(t,e,s?u(r,s):r,n);return!1!==s.lodge&&(g(a,w)||g(a,T)?i.push(a):!a||g(a,R)||g(a,A)||a.meta.vars.forEach(t=>i.push(t))),a},r);return a&&(a.meta||(a.meta={}),a.meta.vars=i,s(r.explain)&&r.explain.push(t+" >>-------------\x3e> "+a.jsenType)),a}}var _=function(t){return"string"==typeof t&&null!==t},U=function(t,e=!0){return s(t)?t:!e&&a(t)?[t]:!1!==t&&0!==t&&function(t){return p(t)||f(t)||!1===t||0===t||o(t)&&!Object.keys(t).length}(t)?[]:function(t){return!_(t)&&!f(t.length)}(t)?Array.prototype.slice.call(t):a(t)?Object.values(t):[t]};const L=function(t,e=1,r=!0){return!l(e)||e<=0?t:(!s(t)&&a(t)&&r&&(t=Object.values(t)),s(t)?t.reduce((t,n)=>s(n)||a(n)&&r?t.concat(L(s(n)?n:Object.values(n),e-1,r)):t.concat(n),[]):t)};var k=L,P=function(t,e=1){var r=0;t.forEach(t=>{r++});var s=t.slice(t.length-r,e);return arguments.length>1?s:s[0]},D=function(t,e=1){return arguments.length>1?P(t.slice().reverse(),e).reverse():P(t.slice().reverse())},W=function(t,e=[]){return c([{},t],(t,r,n)=>{if(!i(n[t]))return i(e)?e(t):!s(e)||!e.length||e.indexOf(t)>-1},!1,!1,!1)};const B=class{static lex(t,e,r={}){if(!_(t+=""))throw new Error("Argument1 must be a string!");var s=t=>({delims:t.delims.slice(),options:W(t.options),nesting:t.nesting.slice(),maxDepth:t.maxDepth,comments:t.comments.slice(),tokens:t.tokens.slice(),matches:t.matches.slice(),matchesi:W(t.matchesi)});if(B.$cache[t]&&!1!==r.cache)for(var n=0;n<B.$cache[t].length;n++){var i=B.$cache[t][n];if(y(i.delims,e))return s(i)}var a=new B(t,r).lex(e);return!1!==r.cache&&(B.$cache[t]=B.$cache[t]||[],B.$cache[t].push(a)),s(a)}static split(t,e,r){return B.lex(t,e,r).tokens}static match(t,e,r){return B.lex(t,e,r).matches}constructor(t,e){if(!_(t))throw new Error("Lexer requires the first argument to be a string.");this.$str=t,this.$options=e||{},this.$options.blocks||(this.$options.blocks=B.$blocks),this.$options.quotes||(this.$options.quotes=B.$quotes),this.$options.comments||(this.$options.comments=B.$comments)}lex(t,e){var r={delims:U(t),options:u(!0,{},this.$options,e||{}),nesting:[],maxDepth:0,comments:[],tokens:[],matches:[],matchesi:{}};if(this._evalCharsAt(r,0),r.nesting.length)throw new Error("Error parsing the string: "+this.$str+". Unterminated blocks: "+k(r.nesting).join(", "));return r}_evalCharsAt(t,e){if(!(e>=this.$str.length)){var r=1,s={},n={},i={};if(t.openComment||(n=this._testQuotes(t,e)),t.openQuote||(s=this._testComments(t,e)),t.openComment||s.ending)if(t.nesting.length||i.ending)this._push(t,this.$str[e]);else r=(o=s.starting||s.ending||this.$str[e]).length,this._push(t,o,"comments",s.starting);else if(t.openQuote||n.ending)this._push(t,this.$str[e]);else{if(t.options.limit&&t.matches.length===t.options.limit)return this._push(t,this.$str[e]),this._evalCharsAt(t,e+1);i=this._testNesting(t,e);i=this._testNesting(t,e);var a=this._testChars(t.options.stopChars||[],t,e);if(!t.nesting.length&&!1!==a)return t.options.stopChar=a,void(t.options.stopCharForward=this.$str.substr(e));if(t.delims.length)if(t.nesting.length||i.ending){var o;r=(o=i.starting||i.ending||this.$str[e]).length,this._push(t,o)}else{this._push(t,"");var l=this._testChars(t.delims,t,e);if(!1!==l&&(t.matches.push(l),t.matchesi[e]=l,r=l.length||1,!t.options.preserveDelims))return this._evalCharsAt(t,e+(l.length||1));this._push(t,l||this.$str[e])}else 2===t.nesting.length&&i.starting?(t.matches.push(null),this._push(t,i.starting),r=i.starting.length):!t.nesting.length&&i.ending?(this._push(t,i.ending),r=i.ending.length,t.matches.push(null)):this._push(t,this.$str[e])}return this._evalCharsAt(t,e+r)}}_testQuotes(t,e){var r={};return(t.options.quotes||[]).forEach(s=>{this.$str.substr(e,1)===s&&(t.openQuote?s===t.openQuote&&(t.openQuote=!1,r.ending=s):(t.openQuote=s,r.starting=s))}),r}_testComments(t,e){var r={};return(t.options.comments||[]).forEach(s=>{if(t.openComment){if(D(s)===D(t.openComment)){var n=D(s);this.$str.substr(e).startsWith(n)&&(t.openComment=!1,r.ending=n)}}else{var i=P(s);this.$str.substr(e).startsWith(i)&&(t.openComment=s,r.starting=i)}}),r}_testNesting(t,e){var r={};return(t.options.blocks||[]).forEach(s=>{var n=P(s);if(this.$str.substr(e).startsWith(n))t.nesting=t.nesting.concat([s]),r.starting=n;else if(t.nesting.length&&D(s)===D(D(t.nesting))){var i=D(s);this.$str.substr(e).startsWith(i)&&(t.nesting=t.nesting.slice(0,-1),r.ending=i)}}),t.maxDepth=Math.max(t.maxDepth,t.nesting.length),r}_testChars(t,e,r){for(var s=0;s<t.length;s++){var n=t[s];if(i(n)){var a=n(this.$str.substr(0,r),this.$str.substr(r));if(!1!==a)return a}if(e.options.useRegex){var o=this.$str.substr(r).match(new RegExp("^"+n,!0!==e.options.useRegex?e.options.useRegex:""));if(o)return o[0]}if(!e.options.ci&&this.$str.substr(r,n.length)===n||e.options.ci&&this.$str.substr(r,n.length).toLowerCase()===n.toLowerCase())return n}return!1}_push(t,e,r="tokens",s=!1){var n=t.matches.length;if(f(t.tokens[n])&&(t.tokens[n]=""),"comments"===r){t.tokens[n].comments||(t.tokens[n]=new String(t.tokens[n]),t.tokens[n].comments=[]);var i=t.tokens[n].comments.length-(!t.tokens[n].comments.length||s?0:1);t.tokens[n].comments[i]=(t.tokens[n].comments[i]||"")+e}else{var a=t.tokens[n].comments;t.tokens[n]=new String(t.tokens[n]+e),t.tokens[n].comments=a}}split(t,e,r){return this.lex(e,r).tokens}match(t,e,r){return this.lex(e,r).matches}regParse(t,e){return this.lex(t,u({useRegex:!0},e||{}))}regSplit(t,e){return this.regParse(t,e).tokens}regMatch(t,e){return this.regParse(t,e).matches}};B.$blocks=[["(",")"],["[","]"],["{","}"]],B.$quotes=['"',"'","`"],B.$comments=[["/*","*/"],["//","\n"]],B.$cache={};var H=B;class F{constructor(t,e=1){if(this.stack=t,this.type=e,!("main"in this.stack))throw new Error('A "main" context must be provided!');this.stack.super&&(this.stack.super=F.create(this.stack.super)),this.stack.local=this.stack.local||{},this.stack.$local=this.stack.$local||{}}observe(t,e,r,s={}){s.observe&&t.length&&(this.stack.super&&this.stack.super.observe(t,(t,r,n)=>{if(n.fields.filter(t=>!M(this.stack.local,t,s)&&!M(this.stack.main,t,s)).length)return e(t,r,n)},r,s),o(this.stack.main)&&s.observe(this.stack.main,t,(t,r,n)=>{if(n.fields.filter(t=>!M(this.stack.local,t,s)).length)return e(t,r,n)},r))}unobserve(t,e,r,s={}){s.unobserve&&(this.stack.super&&this.stack.super.unobserve(t,e,r,s),this.stack.main&&s.unobserve(this.stack.main,t,e,r))}handle(t,e,r,s=0){var n=()=>e(this.stack.main,null,()=>this.stack.super?this.stack.super.handle(t,e,r,s+1):r?r():void 0,s);return"toString"===t&&this.stack.local.toString===Object.prototype.toString?n():e(this.stack.local,this.stack.$local,n,s)}get(t,e={},r=!0){return t instanceof String&&(t+=""),this.handle(t,(s,a,o,l)=>{var h=$(s,t,e);return!f(h)||M(s,t,e)?i(h)&&!function(t){return n(t)&&/^class\s?/.test(Function.prototype.toString.call(t))}(h)&&r?h.bind(s):h:o()})}set(t,e,r={},s=!1){if(2===this.type&&"var"===s&&this.stack.super)return this.stack.super.set(t,e,r,s);t instanceof String&&(t+="");const n=(t,e,r,s)=>s.set?s.set(t,e,r):(t[e]=r,!0);return this.handle(!!s||t,(i,a,o)=>{if(a&&"const"===a[t])throw new Error("CONST "+t+" cannot be modified!");if(s){if(!["var","let","const"].includes(s))throw new Error("Unrecognized declarator: "+s+"!");return a[t]=s,n(i,t,e,r)}return M(i,t,r)?n(i,t,e,r):o()},()=>{throw new Error('"'+t+'" is undefined!')})}del(t,e={}){return t instanceof String&&(t+=""),this.handle(t,(r,s,n)=>M(r,t,e)?(s&&delete s[t],e.deleteProperty||e.del?(e.deleteProperty||e.del)(r,t):(delete r[t],!0)):n())}has(t,e,r={}){return t instanceof String&&(t+=""),e instanceof String&&(e+=""),this.handle(t,(s,n,i)=>{if(M(s,t,r)){var a=$(s,t,r);return M(a,e,r)}return i()},()=>{throw new Error('"'+t+'" is undefined!')})}exec(t,e,r={}){return t instanceof String&&(t+=""),this.handle(t,(s,n,a)=>{var o=$(s,t,r);if(!f(o)||M(s,t,r)){if(!i(o)){if(r.exec)return r.exec(s,t,e);throw new Error('"'+t+'" is not a function! (Called on type: '+typeof s+".)")}return r.apply?r.apply(o,s,e):o.apply(s,e)}return a()},()=>{if(r.execUnknown)return r.execUnknown(this,t,e);throw new Error('"'+t+'()" is undefined!')})}static create(t){return t instanceof F?t:new F({main:t})}}const $=(t,e,r)=>r.get&&o(t)&&!p(t)?r.get(t,e):(o(t)||_(t)||v(t))&&!p(t)?t[e]:void 0,M=(t,e,r)=>r.has&&o(t)&&!p(t)?r.has(t,e):o(t)&&!p(t)?e in t:!p(t)&&!f(t[e]);var G=function(t,e,r){return t.startsWith(e)&&t.endsWith(r)},Y=function(t,e,r=!1){if(""==e)return t;var s=r?t.lastIndexOf(e):t.indexOf(e);return-1===s?"":t.substr(s+e.length)},Q=function(t,e,r=!1){if(""==e)return t;var s=r?t.lastIndexOf(e):t.indexOf(e);return-1===s?t:t.substr(0,s)},q=function(t,e,r){return function(t,e){return Q(t,e,!0)}(Y(t,e),r)};const K=class extends O{};Object.defineProperty(K.prototype,"jsenType",{get:()=>"Abstraction"});var J=K;const X=class extends J{constructor(t){super(),this.expr=t}eval(t=null,e={}){return this.expr.eval(t,e)}toString(t=null){return"("+this.expr.toString(t)+")"}static parse(t,e,r={},s=X){if(G(t,"(",")")&&!H.match(t,[" "]).length)return new s(e(q(t,"(",")")))}};var V=X;const z=class extends O{};Object.defineProperty(z.prototype,"jsenType",{get:()=>"ArrayType"});var Z=z;const tt=class extends Z{constructor(t){super(),this.exprs=t||[]}inherit(t){if(t instanceof Z){var e=t.exprs.filter(t=>this.exprs.reduce((e,r)=>e&&!t.even(r),!0));this.exprs=e.concat(this.exprs)}return this}eval(t=null,e={}){return this.exprs.map(r=>r.eval(t,e))}toString(t=null){return"["+this.exprs.map(e=>e.toString(t)).join(", ")+"]"}static parse(t,e,r={},s=tt){if(G(t,"[","]")&&!H.match(t.trim(),[" "]).length)return new s(H.split(q(t,"[","]"),[","]).map(t=>t.trim()).filter(t=>t).map(t=>e(t)))}};var et=tt;const rt=class extends O{};Object.defineProperty(rt.prototype,"jsenType",{get:()=>"Arguments"});var st=rt;const nt=class extends st{constructor(t=[]){super(),this.list=t}eval(t=null,e={}){return this.list.map(r=>r.eval(t,e))}toString(t=null){return"("+this.list.map(e=>e.toString(t)).join(", ")+")"}static parse(t,e,r={},s=nt){if(t=t.trim(),G(t,"(",")")&&!H.match(t,[" "]).length)return new s(H.split(q(t,"(",")"),[","]).map(t=>e(t.trim())))}};var it=nt,at=function(t){return t.filter((t,e,r)=>r.indexOf(t)===e)};const ot=class extends O{};Object.defineProperty(ot.prototype,"jsenType",{get:()=>"AssertionExpression"});var lt=ot;const ht=class extends lt{constructor(t,e){super(),this.exprs=t,this.logic=e}eval(t=null,e={}){if(this.logic.toLowerCase()===ht.negation.toLowerCase())return!P(this.exprs).eval(t,e);k(ht.operators);for(var r=(this.logic||"").trim().toUpperCase(),s=r===(ht.operators.or||"").trim().toUpperCase(),n=r===(ht.operators.nor||"").trim().toUpperCase(),i=r===(ht.operators.and||"").trim().toUpperCase(),a=r===(ht.operators.nand||"").trim().toUpperCase(),o=!0,l=0,h=0;h<this.exprs.length;h++){if(o=this.exprs[h].eval(t,e),i&&!o)return!1;if(a&&!o)return!0;if(s&&o)return o;l+=o?1:0}return s?o:i||a?i:n&&0===l}toString(t=null){return this.logic.toLowerCase()===ht.negation.toLowerCase()?this.logic+P(this.exprs).toString(t):this.exprs.map(e=>e.toString(t)).join(" "+this.logic+" ")}static parse(t,e,r={},s=ht){if(t.toUpperCase().startsWith(ht.negation.toUpperCase()))return new s([e(t.substr(ht.negation.length))],ht.negation);var n=H.lex(t,k(s.operators));if(n.tokens.length>1){var i=at(n.matches);if(i.length>1)throw new Error('"AND" and "OR" logic cannot be asserted in the same expression: '+t+"!");return new s(n.tokens.map(t=>e(t.trim())),P(i))}}};ht.negation="!",ht.operators={and:"&&",or:"||"};var ct=ht;const ut=class extends O{};Object.defineProperty(ut.prototype,"jsenType",{get:()=>"AssignmentExpression"});var pt=ut;const ft=class extends pt{constructor(t,e,r,s="="){super(),this.initKeyword=t,this.reference=e,this.val=r,this.operator=s}eval(t=null,e={}){var r=this.reference.getEval(t,e),s=this.val.eval(t,e);if(!f(r.context)&&!f(r.name))return F.create(r.context).set(r.name,s,e,this.initKeyword);throw new Error('"'+this+'" is undefined!')}toString(t=null){return(this.initKeyword?this.initKeyword+" ":"")+[this.reference.toString(t),this.operator,this.val.toString(t)].join(" ")}static parse(t,e,r={},s=ft){var n=H.lex(t,s.operators);if(2===n.tokens.length){var i,a=n.tokens.shift().trim(),o=n.tokens.shift().trim();if(["var","let","const"].includes(Q(a," "))&&(i=Q(a," "),a=Y(a," ").trim()),!((a=e(a,null,{lodge:!1}))instanceof w&&(o=e(o))))throw new Error("Invalid assignment expression: "+t);return new s(i,a,o,n.matches[0].trim())}}};ft.operators=[" = "];var gt=ft;const vt=class extends O{};Object.defineProperty(vt.prototype,"jsenType",{get:()=>"Block"});var mt=vt;const dt=class extends O{};Object.defineProperty(dt.prototype,"jsenType",{get:()=>"ReturnDirective"});var Et=dt;class St extends mt{constructor(t,e){super(),this.stmts=t||[],this.delim=e}eval(t=null,e={}){t=F.create(t);for(var r,s=[],n=0;n<this.stmts.length;n++){var i=this.stmts[n];if(i instanceof Et)return i.eval(t,e);s[n]=i.eval(t,e),function(r,s,n){t.observe(s,(s,n,i)=>{var a=r.eval(t,e);if(!1!==a)return a},{observeDown:!0,data:!1,tags:["#block",r]},e)}(i,(r=i.meta.vars,at(r.map(t=>Q(Q(t.toString(),"["),"(")))),this.prevContext)}return this.prevContext=t,s}toString(t=null){return this.stmts.map(e=>e.toString(t)).join(this.delim)}static parse(t,e,r={},s=St){var n=H.lex(t+";",k(s.operators).concat([St.testBlockEnd]));if(n.matches.length)return new s(n.tokens.map(t=>e(t.trim())).filter(t=>t),n.matches[0].trim())}static testBlockEnd(t,e){return!(!t.endsWith("}")||e.trim().startsWith("else"))&&""}}St.operators=[";","\r\n"];const yt=class extends O{};Object.defineProperty(yt.prototype,"jsenType",{get:()=>"BooleanType"});var Ot=yt;const xt=class extends Ot{constructor(t){super(),this.state=t}eval(){return"true"===this.state.toLowerCase().trim()}toString(){return this.state}static parse(t,e,r={},s=xt){if("true"===(t=t.toLowerCase().trim())||"false"===t)return new s(t)}};var wt=xt;const bt=class extends T{constructor(t,e){super(),this.reference=t,this.args=e}eval(t=null,e={}){var r=this.reference.getEval(t,e),s=this.args.eval(t,e);if(!f(r.context)&&!f(r.name))return F.create(r.context).exec(r.name,s,e);throw new Error('"'+this+'" is undefined!')}toString(t=null){return this.reference.toString(t)+this.args.toString(t)}static parse(t,e,r={},s=bt){if(!t.startsWith("(")&&t.endsWith(")")&&!H.match(t,[" "]).length){var n,i=H.split(t,[]),a=i.pop();if(!((n=e(i.join(""),null,{lodge:!1}))instanceof w&&(a=e(a,[it]))))throw new Error("Invalid call directive: "+t);return new s(n,a)}}};var Tt=bt;const Ct=class extends O{};Object.defineProperty(Ct.prototype,"jsenType",{get:()=>"ComparisonExpression"});var Rt=Ct;const jt=class extends Rt{constructor(t,e,r){super(),this.operand1=t,this.operand2=e,this.operator=r}eval(t=null,e={}){return jt.compare(this.operand1.eval(t,e),this.operand2.eval(t,e),this.operator)}toString(t=null){return[this.operand1.toString(t),this.operator,this.operand2.toString(t)].join(" ")}static parse(t,e,r={},s=jt){var n=k(s.operators).map(t=>" "+t+" "),i=H.lex(t,n);if(i.tokens.length>1){if(i.tokens.length>2)throw new Error('Malformed "Comparison" expression: '+t+"!");return new s(e(P(i.tokens).trim()),e(D(i.tokens).trim()),i.matches[0].trim())}}static compare(t,e,r="=="){if(-1===k(jt.operators).indexOf(r))throw new Error('The operator "'+r+'" is not recognized.');switch(r){case"===":return t===e;case"==":case"=":return t==e;case">":return t>e;case"<":return t<e;case">=":return t>=e;case"<=":return t<=e;case"!=":return t!=e;case"<>":case"!==":return t!==e;case"^=":return _(t)&&t.startsWith(e);case"$=":return _(t)&&t.endsWith(e);case"*=":return!(!s(e)&&!_(e))&&t.indexOf(e)>-1;case"~=":return _(t)&&_(e)&&(" "+t+" ").indexOf(" "+e+" ")>-1;case">=<":if(!s(e)||2!==e.length)throw new Error("A 'Between' comparison requires argument 2 to be an array of exactly 2 values.");return t>=e[0]&&t<=e[1];case"/**/":return e.match(new RegExp(t));default:return!1}}static diff(t,e,r){return!jt.compare(t,e,r?"===":"==")}};jt.operators={exact:{is:"===",isNull:"===",equalsTo:"==",strictlyNotEqualsTo:"!==",notEqualsTo:"!="},relative:{lesserThan:"<",greaterThan:">",lesserThanOrEqualsTo:"<=",greaterThanOrEqualsTo:">=",between:">=<"},partial:{startsWith:"^=",endsWith:"$=",contains:"*=",any:"~=",in:"~=",matches:"/**/"}};var At=jt;const It=class extends O{};Object.defineProperty(It.prototype,"jsenType",{get:()=>"TernaryConditional"});var Nt=It;const _t=class extends Nt{constructor(t,e,r){super(),this.assertion=t,this.onTrue=e,this.onFalse=r}eval(t=null,e={}){return this.assertion.eval(t,e)?this.onTrue.eval(t,e):this.onFalse.eval(t,e)}toString(t=null){return[this.assertion.toString(t),_t.operators[0],this.onTrue.toString(t),_t.operators[1],this.onFalse.toString(t)].join(" ")}static parse(t,e,r={},s=_t){var n=H.split(t,s.operators);if(n.length>1){if(2===n.length)throw new Error("Malformed ternary expression: "+t+"!");return new s(e(n[0].trim()),e(n[1].trim()),e(n[2].trim()))}}};_t.operators=["?",":"];var Ut=_t;const Lt=class extends O{};Object.defineProperty(Lt.prototype,"jsenType",{get:()=>"DeleteExpression"});var kt=Lt;const Pt=class extends kt{constructor(t,e="delete"){super(),this.reference=t,this.operator=e}eval(t=null,e={}){var r=this.reference.getEval(t,e);if(!f(r.context)&&!f(r.name))return F.create(r.context).del(r.name,e);throw new Error('"'+this+'" is undefined!')}toString(t=null){return this.operator+" "+this.reference.toString(t)}static parse(t,e,r={},s=Pt){var n=H.lex(t,Object.values(s.operators));if(1===n.matches.length&&t.startsWith(n.matches[0]+" ")){var i;if(!((i=e(n.tokens.pop().trim()))instanceof w))throw new Error("Invalid delete directive: "+t);return new s(i,n.matches[0].trim())}}};Pt.operators={red:"reduce",del:"delete"};var Dt=Pt;const Wt=class extends R{constructor(t,e,r={}){super(),this.paramters=t||{},this.statements=e,this.arrowFunctionFormatting=r}inherit(t){if(t instanceof R){for(var e=Object.keys(t.paramters),r=Object.keys(this.paramters),s=0;s<Math.max(r.length,e.length);s++){var n=e[s],i=r[s];if(!i&&n)throw new Error("Parameter #"+s+" ("+n+") in parent function must be implemented.");if(i&&n){var a=t.paramters[n],o=this.paramters[i];if(o&&!a)throw new Error("Parameter #"+s+" ("+i+") must not have a default value as established in parent function.");if(o&&a&&o.jsenType!==a.jsenType)throw new Error("Default value for parameter #"+s+" ("+i+") must be of type "+a.jsenType+" as established in parent function.")}}this.sup=t}return this}eval(t=null,e={}){return(...r)=>{var s={};E(Object.keys(this.paramters),(n,i)=>{var a=this.paramters[i];if(r.length-1<n&&!a)throw new Error('The parameter "'+i+'" is required.');s[i]=r.length>n?r[n]:this.paramters[i]?this.paramters[i].eval(t,e):null});var n=new F({main:s,super:t});return this.statements.eval(n,e)}}toString(t=null){var e=[];if(E(this.paramters,(r,s)=>{e.push(r+(s?"="+s.toString(t):""))}),this.arrowFunctionFormatting){var r=!1===this.arrowFunctionFormatting.head||1===e.length&&-1===e[0].indexOf("="),s=!1===this.arrowFunctionFormatting.body;return(r?e[0]:"("+e.join(", ")+")")+" => "+(s?this.statements.toString(t):"{"+this.statements.toString(t)+"}")}return"function ("+e.join(", ")+") {"+this.statements.toString(t)+"}"}static parse(t,e,r={},s=Wt){var n;if((t=t.trim()).startsWith("function")&&(n=H.split(t,[]).slice(1).filter(t=>t.trim()))&&2===n.length)var i=!1,a=q(n.shift().trim(),"(",")"),o=q(n.shift().trim(),"{","}");else{if(t.startsWith("function")||!(n=H.split(t,["=>"]))||2!==n.length)return;a=n.shift().trim(),o=n.shift().trim(),i={};G(a,"(",")")?a=q(a,"(",")"):i.head=!1,G(o,"{","}")?o=q(o,"{","}"):i.body=!1}var l={};H.split(a,[","]).forEach(t=>{var r=t.split("=");r[1]?l[r[0].trim()]=e(r[1].trim(),null,{meta:null}):l[t.trim()]=null});var h=e(o,[St],{assert:!1})||e(o,null,{meta:null});return new s(l,"Block"===h.jsenType?h:new St([h]),i)}};Wt.operators=["=>"];var Bt=Wt;const Ht=class extends A{constructor(t,e,r,s={}){super(),this.assertion=t,this.onTrue=e,this.onFalse=r,this.params=s}eval(t=null,e={}){var r=new F({main:{},super:t},2);return this.assertion.eval(t,e)?this.onTrue?this.onTrue.eval(r,e):void 0:this.onFalse?this.onFalse.eval(r,e):void 0}toString(t=null){var e=this.onTrue&&this.params.onTrueIsBlock?"{"+this.onTrue.toString(t)+"}":this.onTrue?this.onTrue.toString(t):"",r=this.onFalse&&this.params.onFalseIsBlock?"{"+this.onFalse.toString(t)+"}":this.onFalse?this.onFalse.toString(t):"";return"if ("+this.assertion.toString(t)+")"+e+(r?" else "+r:"")}static parse(t,e,r={},s=Ht){var n;if((t=t.trim()).startsWith("if")&&(n=H.split(t,[],{limit:2}).slice(1).filter(t=>t.trim()))&&2===n.length){var i,a,o=e(q(n.shift().trim(),"(",")").trim()),l=H.split(n.shift().trim(),["else"],{limit:1}),h=l.shift().trim(),c=(l.shift()||"").trim();return G(h,"{","}")?(i=!0,h=e(h=q(h,"{","}").trim(),[St],{assert:!1,meta:null})||e(h,null,{meta:null})):h=e(h,null,{meta:null}),c&&(G(c,"{","}")?(a=!0,c=e(c=q(c,"{","}").trim(),[St],{assert:!1,meta:null})||e(c,null,{meta:null})):c=e(c,null,{meta:null})),new s(o,h?"Block"===h.jsenType?h:new St([h]):null,c?"Block"===c.jsenType?c:new St([c]):null,{onTrueIsBlock:i,onFalseIsBlock:a})}}};var Ft=Ht,$t=function(t,e,r=null){return s(e)?t.filter(t=>r?e.filter(e=>r(t,e)).length:-1!==e.indexOf(t)):[]};const Mt=class extends O{};Object.defineProperty(Mt.prototype,"jsenType",{get:()=>"MathExpression"});var Gt=Mt;const Yt=class extends Gt{constructor(t,e){super(),this.val=t,this.exprs=e}eval(t=null,e={}){return this.exprs.reduce((r,s)=>{var n=s.val.eval(t,e),i=s.operator.trim();if(!(l(r)&&l(n)||"+"===i))throw new Error("Invalid Math expression: "+this.toString()+"!");switch(i){case"+":return r+n;case"-":return r-n;case"*":return r*n;case"/":return r/n}},this.val.eval(t,e))}toString(t=null){return[this.val.toString(t)].concat(this.exprs.map(e=>e.operator+" "+e.val.toString(t))).join(" ")}static parse(t,e,r={},s=Yt){var n=H.lex(t,k(s.operators));if(n.tokens.length>1&&n.matches.length===n.tokens.length-1){var i=at(n.matches);if($t(i,Yt.operators.sup).length&&$t(i,Yt.operators.sub).length)throw new Error('"Addition/subtraction" and "multiplication/division" operators cannot be used in the same expression: '+t+"!");return new s(e(n.tokens.shift().trim()),n.tokens.map((t,r)=>({operator:n.matches[r],val:e(t.trim())})))}}};Yt.operators={sup:["*","/"],sub:[" + "," - "]};var Qt=Yt;const qt=class extends O{};Object.defineProperty(qt.prototype,"jsenType",{get:()=>"NumberType"});var Kt=qt;const Jt=class extends Kt{constructor(t,e=0){super(),this.int=t,this.dec=e}eval(){return parseFloat(this.int+(this.dec?"."+this.dec:null))}toString(t=null){return this.int+(this.dec?"."+this.dec:null)}static parse(t,e,r={},s=Jt){if(l(t)){t=t.split(".");return new s(parseInt(t.shift()),parseInt(t.shift()))}}};var Xt=Jt;const Vt=class extends O{};Object.defineProperty(Vt.prototype,"jsenType",{get:()=>"ObjectType"});var zt=Vt;const Zt=class extends zt{constructor(t){super(),this.entries=t||{}}inherit(t){return t instanceof zt&&E(t.entries,(t,e)=>{t in this.entries||(this.entries[t]=e)}),this}eval(t=null,e={}){var r={};return E(this.entries,(s,n)=>{r[s]=n.eval(t,e)}),r}toString(t=null){var e=[];return E(this.entries,(r,s)=>{e.push(r+Zt.operators.sub+s.toString(t))}),"{"+e.join(Zt.operators.sup)+"}"}static parse(t,e,r={},s=Zt){if(G(t,"{","}")&&!H.match(t.trim(),[" "]).length){var n={},i=H.split(q(t,"{","}"),[Zt.operators.sup]).map(t=>t.trim()).filter(t=>t);return E(i,(t,r)=>{var s=H.split(r,[Zt.operators.sub],{limit:1});n[P(s).trim()]=e(D(s).trim())}),new s(n)}}};Zt.operators={sup:",",sub:":"};var te=Zt;const ee=class extends O{};Object.defineProperty(ee.prototype,"jsenType",{get:()=>"PresenceOperator"});var re=ee;const se=class extends re{constructor(t,e,r="in"){super(),this.prop=t,this.reference=e,this.operator=r}eval(t=null,e={}){var r=this.reference.getEval(t,e),s=this.prop.eval(t,e);if(!f(r.context)&&!f(r.name))return F.create(r.context).has(r.name,s,e);throw new Error('"'+this+'" is undefined!')}toString(t=null){return[this.prop.toString(t),this.operator,this.reference.toString(t)].join(" ")}static parse(t,e,r={},s=se){var n=H.lex(t,s.operators);if(2===n.tokens.length){var i,a;if(!((i=e(n.tokens.shift().trim()))&&(a=e(n.tokens.shift().trim()))instanceof w))throw new Error("Invalid presence check expression: "+t);return new s(i,a,n.matches[0].trim())}}};se.operators=[" in "];var ne=se;const ie=class extends w{constructor(t,e,r=!1){super(),this.context=t,this.name=e,this.backticks=r}getEval(t=null,e={}){var r=t,s=this.name;return this.context&&(s instanceof O&&(s=s.eval(t,e)),r=this.context.eval(t,e)),{context:r,name:s}}eval(t=null,e={}){var r=this.getEval(t,e);if(!f(r.context)&&!f(r.name))return F.create(r.context).get(r.name,e)}toString(t=null){var e=this.name;if(this.context){var r=this.context.toString(t);e instanceof O?e="["+e.toString(t)+"]":this.backticks&&(e="`"+e+"`")}else{r=t;this.backticks&&(e="`"+e+"`")}return(r||"")+(r&&!e.startsWith("[")?ie.separator:"")+e}static parse(t,e,r={},s=ie){if(!H.match(t.trim(),[" "]).length){var n,i,a=H.split(t,[]),o=a.pop(),l=H.split(o.trim(),[s.separator],{preserveDelims:!0});if(l.length>1&&(o=l.pop().substr(1),a=a.concat(l)),G(o,"`","`")&&(o=q(o,"`","`"),i=!0),a.length&&((n=e(a.join(""))).isContext=!0),G(o,"[","]")){if(!n)throw new Error("Invalid reference: "+t+"!");o=e(q(o,"[","]"))}return new s(n,o,i)}}};ie.separator=".";var ae=ie;const oe=class extends Et{constructor(t){super(),this.expr=t}eval(t=null,e={}){return this.expr?this.expr.eval(t,e):void 0}toString(t=null){return this.expr?"return "+this.expr.toString(t):"return"}static parse(t,e,r={},s=oe){var n=t.toLowerCase();if(n.startsWith("return ")||"return"===n)return new s(e(t.substr(6).trim()))}};var le=oe;const he=class extends O{};Object.defineProperty(he.prototype,"jsenType",{get:()=>"StringType"});var ce=he;const ue=class extends ce{constructor(t,e){super(),this.expr=t,this.quote=e}eval(){return this.expr}toString(){return this.quote+this.expr+this.quote}static parse(t,e,r={},s=ue){if(t=t.trim(),(G(t,'"','"')||G(t,"'","'"))&&!H.match(t,[" "]).length){var n=G(t,'"','"')?'"':"'";return new s(q(t,n,n),n)}}};var pe=ue;const fe=class extends O{};Object.defineProperty(fe.prototype,"jsenType",{get:()=>"Void"});var ge=fe;const ve=class extends ge{constructor(t){super(),this.val=t}eval(){return"null"===this.val.toLowerCase().trim()?null:void 0}toString(){return this.val}static parse(t,e,r={},s=ve){if("null"===(t=t.toLowerCase().trim())||"undefined"===t)return new s(t)}};var me=ve;N.grammars={If:Ft,Return:le,Deletion:Dt,Assignment:gt,Presence:ne,Func:Bt,Abstraction:V,Condition:Ut,Assertion:ct,Comparison:At,Math:Qt,Arr:et,Obj:te,Num:Xt,Str:pe,Bool:wt,Void:me,Call:Tt,Reference:ae};var de=N;const Ee=class extends de{static parse(t,e,r={},s=Ee){return"mutates"in r||(r.mutates=!0),r.opts||(r.opts={}),"ci"in r.opts||(r.opts.ci=!0),r.allowCache=!1,super.parse(t,e,r,s)}};var Se=Ee,ye=class extends O{},Oe=function(t){return(t=t.slice()).reduce((t,e)=>t+e,t.shift())},xe=function(t){return arguments.length&&(void 0===t||void 0===t)},we=function(t){return"function"==typeof t},be=function(t){return we(t)||t&&"[object function]"==={}.toString.call(t)},Te=function(t,...e){return e.forEach(e=>{t.indexOf(e)<0&&t.push(e)}),t},Ce=function(t){return Array.isArray(t)},Re=function(t){return t instanceof String||"string"==typeof t&&null!==t},je=function(t){return null===t||""===t},Ae=function(t){return Array.isArray(t)||"object"==typeof t&&t||we(t)},Ie=function(t){return je(t)||xe(t)||!1===t||0===t||Ae(t)&&!Object.keys(t).length},Ne=function(t){return!Array.isArray(t)&&"object"==typeof t&&t},_e=function(t,e=!0){return Ce(t)?t:!e&&Ne(t)?[t]:!1!==t&&0!==t&&Ie(t)?[]:function(t){return!Re(t)&&!xe(t.length)}(t)?Array.prototype.slice.call(t):Ne(t)?Object.values(t):[t]},Ue=function(t,e,r=!1){for(var s=t.indexOf(e);s>-1&&(r||!1===r);)t.splice(s,1),r>0&&r--,s=t.indexOf(e);return t},Le=function(t,e=1){var r=0;t.forEach(t=>{r++});var s=t.slice(t.length-r,e);return arguments.length>1?s:s[0]},ke=function(t){return!0!==t&&!1!==t&&null!==t&&""!==t&&!isNaN(1*t)};const Pe=function(t,e=1,r=!0){return!ke(e)||e<=0?t:(!Ce(t)&&Ne(t)&&r&&(t=Object.values(t)),Ce(t)?t.reduce((t,s)=>Ce(s)||Ne(s)&&r?t.concat(Pe(Ce(s)?s:Object.values(s),e-1,r)):t.concat(s),[]):t)};var De=Pe,We=function(t){return!0===t||!1===t},Be=function(t,e=1){return arguments.length>1?Le(t.slice().reverse(),e).reverse():Le(t.slice().reverse())},He=function(t,e=1){for(var r=[],s=null;r.length<e&&(s=t[Math.floor(Math.random()*t.length)])&&-1===r.indexOf(s);)r.push(s);return arguments.length>1?r:r[0]},Fe=function(t,e){var r=void 0;return Ae(t)&&Object.keys(t).forEach((s,n)=>{!1!==r&&(r=e(ke(s)?parseFloat(s):s,t[s],n))}),r},$e=function(t){return t.filter((t,e,r)=>r.indexOf(t)===e)},Me=function(t,e){var r=[];return function(t,e){e=(e=e||Object.prototype)&&!Ce(e)?[e]:e;var r=[];for(t=t;t&&(!e||e.indexOf(t)<0)&&"default"!==t.name;)r.push(t),t=t?Object.getPrototypeOf(t):null;return r}(t,e).forEach(t=>{Te(r,...Object.getOwnPropertyNames(t))}),r};function Ge(t,e,r=!1,s=!1,n=!0){var i=0,a=t.shift();if((ke(a)||!0===a||!1===a)&&(i=a,a=t.shift()),!t.length)throw new Error("_merge() requires two or more array/objects.");return t.forEach((t,o)=>{(Ae(t)||be(t))&&(r?Me(t):Object.getOwnPropertyNames(t)).forEach(l=>{var h=a[l],c=t[l];if((Ce(h)&&Ce(c)||Ne(h)&&Ne(c))&&(!0===i||i>0))a[l]=Ce(h)&&Ce(c)?[]:{},Ge([ke(i)?i-1:i,a[l],h,c],e,r,s,n);else if(e(l,a,t,o))if(Ce(a)&&Ce(t))s?a[l]=c:a.push(c);else try{n?Object.defineProperty(a,l,Object.getOwnPropertyDescriptor(t,l)):a[l]=t[l]}catch(t){}})}),a}var Ye=function(...t){var e={};Ce(arguments[0])&&(t=arguments[0],e=arguments[1]);var r=Be(t),s={},n=class extends r{constructor(...t){super(...t)}};return n.prototypes=t,t.forEach(t=>{Ge([n,t],(t,e,r)=>-1===["name","prototype","prototypes","length"].indexOf(t)),Ge([n.prototype,t.prototype],(t,e,r)=>-1===["prototype","prototypes"].indexOf(t)&&(!be(r[t])||(Ce(s[t])?s[t].push(r[t]):s[t]=[r[t]],!1)),!0)}),Fe(s,(t,r)=>{"constructor"!==t&&(n.prototype[t]=function(...s){if(Object.hasOwnProperty(e,t)&&be(e[t]))return e[t].call(this,r,...s);var n=[];return r.forEach(t=>{n.push(t.call(this,...s))}),Be(n)})}),n},Qe=function(...t){return Ge(t,(t,e,r)=>!0,!1,!1,!1)},qe=function(t,e=[],r=!0){var s=0;return ke(arguments[0])&&Ae(arguments[1])&&(s=arguments[0],t=arguments[1],e=arguments[2]||[]),Ge([s,{},t],(t,r,s)=>be(e)?e(t):!Ce(e)||!e.length||e.indexOf(t)>-1,!1,!1,r)};const Ke=function(t,e,r=!1){var s=null,n=t;Ce(t)||(s=Object.keys(t),n=Object.values(t));var i=void 0,a=n.reduce((t,s)=>{if(void 0===i){if(e(s,t))return s;if(r&&(Ae(s)||be(s))&&void 0!==(i=Ke(s,e,r)))return s}return t},void 0);if(void 0!==a){var o=s?s[n.indexOf(a)]:n.indexOf(a);return void 0!==i?[o].concat(_e(i)):o}};var Je=Ke,Xe=function(t,e=null){var r={};return 2===arguments.length&&(Ce(t)&&Ce(e)?t.forEach((t,s)=>r[t]=e[s]):r[t]=e),r},Ve=function(t,e,r={},s={}){e=_e(e).slice();for(var n=t;!xe(n)&&!je(n)&&e.length;){var i=e.shift();if(!(r.get?r.get(n,i):Ae(n)?i in n:n[i]))return void(s.exists=!1);n=r.get?r.get(n,i):n[i]}return s.exists=!0,n},ze=function(...t){return Ge(t,(t,e,r)=>{if(Ce(e)&&Ce(r)){if(-1===e.indexOf(r[t]))return!0}else if(!(t in e))return!0})};var Ze=function(t,e,r=!1){if(""==e)return t;var s=r?t.lastIndexOf(e):t.indexOf(e);return-1===s?"":t.substr(s+e.length)},tr=function(t,e,r=!1){if(""==e)return t;var s=r?t.lastIndexOf(e):t.indexOf(e);return-1===s?t:t.substr(0,s)},er=function(t,e){return tr(t,e,!0)},rr=function(t,e,r){return er(Ze(t,e),r)},sr=function(t,e,r){return t.startsWith(e)&&t.endsWith(r)};ct.negation="NOT ",ct.operators={and:" and ",or:" or ",AND:" AND ",OR:" OR "};var nr=ct;const ir=class extends ae{constructor(t,e,r=!1){var s=Re(e)&&/(<-|->)/.test(e);s&&!r&&(r=!0),super(t,e,r),this.isArrowReference=s}eval(t,e={}){if(!this.isContext&&!this.isTableName){var r=ir.findContexts(t,this.name);if(this.isFieldName&&Ue(r,"$"),r.length,this.arrowContext){var s=this.context;this.context=void 0;var n=super.eval(t[this.arrowContext],e);return this.context=s,n}if(!this.context){if(-1===r.indexOf("$")&&r.length>1)throw new Error('"'+this.name+'" is ambiguous!');if(r.length){var i=r.reduce((t,e)=>"$"===t?t:e,"");return super.eval(t[i],e)}}}n=super.eval(t,e);return this.isContext&&xe(n),n}static findContexts(t,e){var r=[];return Object.keys(t).forEach(s=>{t[s]&&e in t[s]&&r.push(s)}),r}static parse(t,e,r={},s=ir){return super.parse(t,e,r,s)}};var ar=ir;const or=class extends gt{eval(t,e={}){if(this.initKeyword=!1,!this.reference.isContext){var r=ar.findContexts(t,this.reference.name);if(!r.length)throw new Error('"'+this.toString()+'" is unknown!');if(!this.reference.context){if(-1===r.indexOf("$")&&r.length>1)throw new Error('"'+this.reference.name+'" is ambiguous!');if(r.length){var s=r.reduce((t,e)=>"$"===t?t:e,"");return super.eval(t[s],e)}}}return super.eval(t,e)}static parse(t,e,r={},s=or){var n=super.parse(t,e,r,s);if(n)return n.parseCallback=e,n.Static=s,n}};var lr=or;const hr=class extends Tt{eval(t=null,e={}){return this.evalWithArgs(t,this.args.eval(t,e),e)}evalWithArgs(t,e,r={}){var s=this.reference.getEval(t,r);if(!xe(s.context)&&!xe(s.name))return F.create(s.context).exec(s.name.toUpperCase(),e,r);throw new Error('"'+this+'" is undefined!')}static parse(t,e,r={},s=hr){return super.parse(t,e,r,s)}};var cr=hr;At.operators={relative:{lesserThan:"<",greaterThan:">",lesserThanOrEqualsTo:"<=",greaterThanOrEqualsTo:">="},partial:{any:"any",in:"in",like:"like"},exact:{notEqualsTo:"<>",is:"="}};var ur=At;const pr=class extends Ut{constructor(t,e,r){super(),this.assertion=t,this.onTrue=e,this.onFalse=r}toString(t=null){return"IF ("+[this.assertion.toString(t),this.onTrue.toString(t),this.onFalse.toString(t)].join(", ")+")"}static parse(t,e,r={},s=pr){if(t.match(/^if[ ]*?\(/i)){var n=H.split(rr(t.trim().substr(2).trim(),"(",")"),[","]);if(3!==n.length)throw new Error("Malformed condition expression: "+t+"!");return new s(...n.map(t=>e(t.trim())))}}};var fr=pr;const gr=class extends ye{};Object.defineProperty(gr.prototype,"jsenType",{get:()=>"AggregateExpression"});var vr=gr;const mr=class extends ye{};Object.defineProperty(mr.prototype,"jsenType",{get:()=>"WindowConstruct"});var dr=mr;const Er=class extends ye{};Object.defineProperty(Er.prototype,"jsenType",{get:()=>"OrderByExpression"});var Sr=Er;const yr=class extends Sr{constructor(t,e=!1){super(),this.columns=t,this.withRollup=e}eval(t,e={}){var r=(t,s)=>{var n={};t.forEach(t=>{var r=s[0].expr.eval(t,e);n[r]=n[r]||[],n[r].push(t)});var i=[];return function(t,e,r=null){for(var s=[],n=t.length,i=0;i<n;i++)s.push({index:i,value:r?r(t[i]):t[i]});return s.sort((function(t,e){return Re(t.value)&&"".localeCompare?t.value.localeCompare(e.value):t.value===e.value?0:t.value>e.value?1:-1})),"desc"===(e||"").trim().toLowerCase()&&(s=s.reverse()),s.map(e=>t[e.index])}(Object.keys(n),s[0].order).forEach(t=>{i=i.concat(s.length>1?r(n[t],s.slice(1)):n[t])}),i};try{var s=r(t,this.columns)}catch(t){throw new Error('["'+this.toString()+'" in order by clause]: '+t.message)}return s}toString(t=null){var e=[this.columns.map(e=>e.expr.toString(t)+(e.order?" "+e.order:"")).join(", ")];return this.withRollup&&e.push("WITH ROLLUP"),e.join(" ")}static parse(t,e,r={},s=yr){var n,i=!1,a=H.lex(t,["WITH[ ]+ROLLUP"],{useRegex:"i"});return n=H.split(a.tokens.shift().trim(),[","]).map(t=>{var r=t.match(/ASC|DESC/,"i");return r&&(r=r[0],t=er(t,r).trim()),{expr:e(t),order:r}}),1===a.matches.length&&(i=!0),new s(n,i)}};var Or=yr;const xr=class extends dr{constructor(t){super(),this.dfn=t}eval(t,e={},r={}){var s=this.dfn,n=this.toString();if(this.dfn.name){if(!e||!e[this.dfn.name])throw new Error('Window name "'+this.dfn.name+'" is undefined!');s=ze({},this.dfn,e[this.dfn.name])}var i=(t,e)=>{if(e.length){var a={};t.forEach(t=>{var s=e[0].eval(t,r);a[s]=a[s]||[],a[s].push(t)}),Object.values(a).map(t=>i(t,e.slice(1)))}else s.orderBy&&(t=s.orderBy.eval(t,r)),t.forEach(e=>{e.WINDOWS||(e.WINDOWS={}),e.WINDOWS[n]=t})};try{i(t,s.partitionBy||[])}catch(t){throw new Error('["'+this.toString()+'" in window definition]: '+t.message)}}toString(t=null){if(1===Object.keys(this.dfn).length&&this.dfn.name)return this.dfn.name;var e=[this.dfn.name];return this.dfn.partitionBy&&e.push("PARTITION BY "+this.dfn.partitionBy.map(e=>e.toString(t)).join(", ")),this.dfn.orderBy&&e.push("ORDER BY "+this.dfn.orderBy.toString(t)),"("+e.filter(t=>t).join(" ")+")"}static parse(t,e,r={},s=xr){var n={};if(sr(t,"(",")")){if(t=rr(t,"(",")")){var i=H.lex(t,["PARTITION[ ]+BY","ORDER[ ]+BY"],{useRegex:"i"});n.name=i.tokens.shift().trim(),i.matches.forEach(t=>{t.toLowerCase().startsWith("partition")?n.partitionBy=H.split(i.tokens.shift().trim(),[","]).map(t=>e(t)):t.toLowerCase().startsWith("order")&&(n.orderBy=e(i.tokens.shift().trim(),[Or]))})}}else n.name=t;return new s(n)}};var wr=xr;const br=class extends(Ye(cr,vr)){constructor(t,e){super(),this.reference=t,this.args=e}eval(t,e={}){var r=this.args.list.slice();return r.unshift(this.window?t.WINDOWS[this.window.toString()]:t.AGGR.rows),this.evalWithArgs(t,r,e)}toString(t=null){return super.toString(t)+(this.window?" OVER "+this.window.toString(t):"")}static parse(t,e,r={},s=br){var n,i=De(s.funcs).join("\\(|")+"\\(";if(n=t.trim().match(new RegExp("^("+i+")","i"))){var a=tr(n[0],"(").toUpperCase(),o=Je(s.funcs,t=>t===a,!0)[0],l=H.split(t,["OVER"],{ci:!0});if("explicitOver"===o&&1===l.length)throw new Error(n[0]+"() requires an OVER clause!");var h=super.parse(l.shift().trim(),e,r,s);return h.funcCategory=o,l.length&&(h.window=e(l.pop().trim(),[wr])),h}}};br.funcs={normal:["AVG","BIT_AND","BIT_OR","BIT_XOR","COUNT","JSON_ARRAYAGG","JSON_OBJECTAGG","MAX","MIN","STDDEV_POP","STDDEV","STD","STDDEV_SAMP","SUM","VAR_POP","VARIANCE","VAR_SAMP","GROUP_CONCAT","GROUP_CONCAT_WS"],explicitOver:["CUME_DIST","DENSE_RANK","FIRST_VALUE","LAG","LAST_VALUE","LEAD","NTH_VALUE","NTLE","PERCENT_RANK","RANK","ROW_NUMBER"],support:["ANY_VALUE","COLUMN","COLUMNS","GROUPING"]};var Tr=br;var Cr={tables:{},define(t,e){if(!Ne(e))throw new Error("Table definition must be an object.");if(e.name&&e.name!==t)throw new Error("Table name, if really necessary, must be the same with the given definition identifier.");if(!Ne(e.fields))throw new Error('Table must have a valid "fields" list.');Fe(e.fields,(e,r)=>{if(!Ne(r))throw new Error('Invalid field definition: "'+e+'" at "'+t+'".');if(r.referencedEntity&&(!Ne(r.referencedEntity)||!r.referencedEntity.name))throw new Error('Invalid foreign key definition: "'+e+'" at "'+t+'".')}),e.name||(e.name=t),this.tables[t]=e},drop(t){if(!this.tables[t])throw new Error('Table "'+t+'" has not been defined.');delete this.tables[t]}};class Rr{static isReference(t){return t.indexOf("<-")>-1||t.indexOf("->")>-1}static isOutgoing(t){return t.indexOf("->")>-1&&-1===tr(t,"->").indexOf("<-")}static isIncoming(t){return t.indexOf("<-")>-1&&-1===tr(t,"<-").indexOf("->")}static reverse(t){return t.replace(/->/g,"|->|").replace(/<-/g,"|<-|").split("|").map(t=>"->"===t?"<-":"<-"===t?"->":t).reverse().join("")}static eval(t,e){var r,s;if(Rr.isIncoming(e)){var n=tr(e,"<-"),i=Ze(e,"<-");if(Rr.isIncoming(i)){s=Rr.eval("",i).a.table;var a=i}else{var o=tr(i,"->");if(a=Ze(i,"->"),!(s=Cr.tables[o]))throw new Error("["+e+']: The implied table "'+o+'" is not defined.')}if(t)Re(t)?r=Cr.tables[t]:Ne(t)&&(r=t);else{if(!s.fields[n]||!(r=s.fields[n].referencedEntity))throw new Error("["+e+']: The "'+s.name+'" table does not define the implied foreign key "'+n+'".');r=Cr.tables[r.name]}return{a:{table:r,actingKey:r.primaryKey},b:{table:s,actingKey:n,select:a}}}Re(t)?r=Cr.tables[t]:Ne(t)&&(t=(r=t).name);var l=tr(e,"->");if(a=Ze(e,"->"),!r.fields[l]||!(s=r.fields[l].referencedEntity))throw new Error("["+t+"->"+e+']: The "'+t+'" table does not define the implied foreign key "'+l+'".');return{a:{table:r,actingKey:l},b:{table:s=Cr.tables[s.name],actingKey:s.primaryKey,select:a}}}}const jr=class extends ye{};Object.defineProperty(jr.prototype,"jsenType",{get:()=>"SelectStatement"});var Ar=jr;const Ir=class extends ye{};Object.defineProperty(Ir.prototype,"jsenType",{get:()=>"TableExpression"});var Nr=Ir;const _r=class extends ye{};Object.defineProperty(_r.prototype,"jsenType",{get:()=>"UnionConstruct"});var Ur=_r;var Lr=class extends class{}{constructor(t,e,r){super(),this.rows=t,this.alias=e,this.schema=r}delete(){if(this.cursor<this.rows.length)return delete this.rows[this.cursor],!0}insert(t,e=[]){var r={};if(this.schema.fields){var s=Object.keys(this.schema.fields);if(e.length){var n=e.filter(t=>-1===s.indexOf(t));if(n.length)throw new Error("Unknown column(s): "+n.join(", "))}else e=s}else s=e;if(e.length!==t.length)throw new Error("Column/values count mismatch!");s.forEach(s=>{var n=e.indexOf(s);r[s]=-1===n?this.schema.fields&&Ne(this.schema.fields[s])?this.schema.fields[s].default:null:t[n]}),this.rows.push(r)}};var kr=class extends Lr{constructor(t,e,r,s,n=!1){super(e.eval(t),r,s,n)}};class Pr{constructor(t,e,r){if(this.USER=t||{id:0,parent:0,lineage:"0",privileges:[]},this.table=Cr.tables[e],this.alias="MAIN",this.select=[],this.where=[],Cr.tables.uac&&(this.EXPLICIT_TABLE_ACCESS_QUERY={query:Pr.getExplicitRulesQuery(this.USER,this.table.name),alias:"EXPLICIT_TABLE_ACCESS",on:["EXPLICIT_TABLE_ACCESS.table_row = 0"]}),r&&(Cr.tables.uac&&(this.EXPLICIT_ROW_ACCESS_QUERY={query:Pr.getExplicitRulesQuery(this.USER,this.table.name),alias:"EXPLICIT_ROW_ACCESS",on:["EXPLICIT_ROW_ACCESS.table_row = "+this.alias+"."+this.table.primaryKey]}),this.table.attributionKey&&Cr.tables.account)){var s=Pr.getOwnerGuestRelationshipQuery(this.USER,!1);this.AUTHOR_USER_RELATIONSHIP_QUERY={query:s,alias:"AUTHOR_USER_RELATIONSHIP",on:["AUTHOR_USER_RELATIONSHIP."+s.table.primaryKey+" = "+this.alias+"."+this.table.attributionKey]}}this.where.push(this.deriveEntityAccess("view")+" <> 0")}static getExplicitRulesQuery(t,e){var r='FIND_IN_SET(target, "'+t.lineage.replace("/",",")+'")';return{table:Cr.tables.uac,select:["*",r+" AS `lineage.target`"],where:["table_name = "+e,"target = "+t.id+" OR "+r],orderBy:"`lineage.target` DESC",limit:1,toString(){return"SELECT "+this.select.join(", ")+" FROM "+this.table.name+" WHERE "+this.where.join(" AND ")+" ORDER BY "+this.orderBy+" LIMIT "+this.limit}}}static getOwnerGuestRelationshipQuery(t,e=!1){var r={};r.DESCENDANT='FIND_IN_SET(id, "'+t.lineage.replace(t.id+"/","").replace(/\//g,",")+'")',r["DESCENDANT,CHILD"]="id = "+t.parent,r.SIBLING=t.parent+" = parent",r.ANCESTOR="FIND_IN_SET("+t.id+', REPLACE(REPLACE(lineage, CONCAT(id, "/"), ""), "/", ","))',r["ANCESTOR,PARENT"]=t.id+" = parent",r.AUTHOR="id = "+t.id;var s="NULL";return Fe(r,(t,e)=>{s="IF("+t+', "'+e+'", '+s+")"}),{table:Cr.tables.account,select:(e?"GROUP_CONCAT(DISTINCT ":"")+s+(e?")":"")+" AS relationship",where:[],toString(){return"SELECT "+this.select+" FROM "+this.table.name+(this.where.length?" WHERE "+this.where.join(" AND "):"")}}}toString(){return"SELECT "+this.select.join(", ")+" FROM "+this.table.name+" AS "+this.alias+(this.EXPLICIT_TABLE_ACCESS_QUERY?" LEFT JOIN ("+this.EXPLICIT_TABLE_ACCESS_QUERY.query+") AS "+this.EXPLICIT_TABLE_ACCESS_QUERY.alias+" ON "+this.EXPLICIT_TABLE_ACCESS_QUERY.on.join(" AND "):"")+(this.EXPLICIT_ROW_ACCESS_QUERY?" LEFT JOIN ("+this.EXPLICIT_ROW_ACCESS_QUERY.query+") AS "+this.EXPLICIT_ROW_ACCESS_QUERY.alias+" ON "+this.EXPLICIT_ROW_ACCESS_QUERY.on.join(" AND "):"")+(this.AUTHOR_USER_RELATIONSHIP_QUERY?" LEFT JOIN ("+this.AUTHOR_USER_RELATIONSHIP_QUERY.query+") AS "+this.AUTHOR_USER_RELATIONSHIP_QUERY.alias+" ON "+this.AUTHOR_USER_RELATIONSHIP_QUERY.on.join(" AND "):"")+" WHERE "+this.where.join(" AND ")}deriveEntityAccess(t,e=!1){var r=[];return this.EXPLICIT_ROW_ACCESS_QUERY&&r.push("JSON_EXTRACT("+this.EXPLICIT_ROW_ACCESS_QUERY.alias+'.uac, "$.'+t+'")'),this.EXPLICIT_TABLE_ACCESS_QUERY&&r.push("JSON_EXTRACT("+this.EXPLICIT_TABLE_ACCESS_QUERY.alias+'.uac, "$.'+t+'")'),r.push(Pr.getRightsRulesIntersectionExpression(Pr.rules(this.table.uac,t),this.getGuestRightsExpression(),e)),"COALESCE("+r.join(", ")+")"}deriveFieldsAccess(t,e,r=!1){var s={};return t.forEach(t=>{var n=[];this.EXPLICIT_ROW_ACCESS_QUERY&&n.push("JSON_EXTRACT("+this.EXPLICIT_ROW_ACCESS_QUERY.alias+'.fields, "$.'+t+".uac."+e+'")'),this.EXPLICIT_TABLE_ACCESS_QUERY&&n.push("JSON_EXTRACT("+this.EXPLICIT_TABLE_ACCESS_QUERY.alias+'.fields, "$.'+t+".uac."+e+'")'),n.push(Pr.getRightsRulesIntersectionExpression(Pr.rules(this.table.fields[t].uac,e),this.getGuestRightsExpression(),r)),s[t]="COALESCE("+n.join(", ")+")"}),s}getGuestRightsExpression(){var t=[];return this.AUTHOR_USER_RELATIONSHIP_QUERY&&(t.push(this.AUTHOR_USER_RELATIONSHIP_QUERY.alias+".relationship"),this.AUTHOR_USER_TOKEN_QUERY&&t.push("IF("+this.AUTHOR_USER_TOKEN_QUERY.alias+'.id, "user", "")')),this.USER.privileges.length&&t.push('"'+this.USER.privileges.join(",")+'"'),t.length?'CONCAT_WS(",", '+t.join(", ")+")":'""'}static getRightsRulesIntersectionExpression(t,e,r=!1){var s=We(t[0])?t.shift():null;if(!t.length)return We(s)?parseInt(s):"NULL";var n=[];return t.forEach(t=>{var r=[];t.split("+").forEach(t=>{r.push('FIND_IN_SET("'+t+'", '+e+")")}),n.push("IF("+r.join(" AND ")+', "'+t+'", NULL)')}),n="COALESCE("+n.join(", ")+")",s?"IF(ISNULL("+n+"), 1, 0)":"IF(ISNULL("+n+"), 0, "+(r?n:"1")+")"}static rules(t,e){return Ne(t)&&(t=t[e]),Ie(t)?[]:_e(t)}}class Dr{static select(t,e,r){(r=_e(r)).length&&"*"!==r[0]||(r=Object.keys(Cr.tables[e].fields));var s=new Pr(t,e,!0);return Fe(s.deriveFieldsAccess(r,"view"),(t,e)=>{s.select.push("IF("+e+" <> 0, "+s.alias+"."+t+", NULL) AS "+t)}),s}static getRelatedAccounts(t,e,r=[]){var s=Cr.tables.account,n={table:s,alias:"ACCOUNT",select:[],where:[],orderBy:[],toString(){return"SELECT "+this.select.join(", ")+" FROM "+this.table.name+" AS "+this.alias+" RIGHT JOIN ("+this.AUTHOR_USER_RELATIONSHIP_QUERY.query+") AS "+this.AUTHOR_USER_RELATIONSHIP_QUERY.alias+" ON "+this.AUTHOR_USER_RELATIONSHIP_QUERY.on.join(" AND ")+" WHERE "+this.where.join(" AND ")+(this.orderBy.length?" ORDER BY "+this.orderBy:"")}};return n.AUTHOR_USER_RELATIONSHIP_QUERY={query:Pr.getAuthorUserRelationshipQuery(t,!1),alias:"AUTHOR_USER_RELATIONSHIP",on:[n.alias+"."+s.primaryKey+" = AUTHOR_USER_RELATIONSHIP."+s.primaryKey,"NOT ISNULL(AUTHOR_USER_RELATIONSHIP.relationship)"]},r&&(n.select.push("FIND_IN_SET("+n.alias+"."+s.primaryKey+', "'+r.join(",")+'") AS priority'),n.orderBy.push("priority DESC")),e&&n.where.push('AUTHOR_USER_RELATIONSHIP.relationship in ("'+e.join('", "')+'")'),n}static getAccessesDoc(t,e,r=null,s=null,n=!1,i=!1){if(r&&s)throw new Error("UAC queries must be either over an object and its author (argument #2), or as related to a specific user (argument #3). But not both!");var a=new Pr(t,tableName,objectId||s);a.AUTHOR_USER_RELATIONSHIP_QUERY&&a.AUTHOR_USER_RELATIONSHIP_QUERY.on.push("NOT ISNULL(AUTHOR_USER_RELATIONSHIP.relationship)"),r?a.where.push(a.table.primaryKey+" = "+r):a.table.attributionKey&&s&&(a.where.push(a.table.attributionKey+" = "+s),a.limit=1),e=e.length&&"*"!==e?_e(e):Dr.standardAccesses;var o=[],l={},h=n?Object.keys(a.table.fields):[];if(e.forEach(t=>{o.push('JSON_OBJECT("'+t+'", COALESCE('+Pr.deriveEntityAccess(t,i)+"))"),Fe(Pr.deriveFieldsAccess(h,t,i),(e,r)=>{l[e]||(l[e]=[]),l[e].push('JSON_OBJECT("'+t+'", '+r+")")})}),e.length>1?a.select.push("JSON_MERGE("+o.join(", ")+") AS uac"):a.select.push(o.join(", ")+" AS uac"),l.length){var c=[];Fe(l,(t,r)=>{e.length>1?c.push('JSON_OBJECT("'+t+'", JSON_MERGE('+r.join(", ")+"))"):c.push('JSON_OBJECT("'+t+'", '+r.join(", ")+")")}),a.select.push("JSON_MERGE("+c.join(", ")+") AS fields")}return a}}Dr.standardAccesses=["view","create","update","delete","stats","use"];const Wr=class extends Nr{constructor(t,e,r=!1){super(),this.expr=t,this.alias=e,this.claused=r}eval(t=null,e={}){if(this.expr instanceof J)return new kr(t,this.expr.expr,this.alias,this.getSchema());if(this.expr instanceof w){if(this.expr.context)var r=this.expr.eval(Xe(this.expr.context.name,t),e);else r=this.expr.eval(t,e);if(!Ce(r))throw new Error('Table "'+this.getName()+'" could not be initialized!');return new Lr(r,this.getAlias(),this.getSchema())}}toString(t=null){return[this.expr.toString(t),this.claused?"AS":"",this.alias].filter(t=>t).join(" ")}as(t){return this.alias=t,this.claused=!0,this}getName(){return this.expr.name||""}getAlias(){return this.alias||this.getName()}getSchema(){if(this.expr instanceof J){var t=this.expr.expr,e=t.getTable(),r=(Ce(e)?e[0]:e).getSchema(),s={fields:{},uniqueKeys:[]};return s.name=this.getAlias(),t.getFields().forEach(t=>{s.fields[t.getAlias()]=r.fields[t.getName()],r.uniqueKeys.includes(t.getName())&&s.uniqueKeys.push(t.getAlias())}),Fe(r.fields,(t,e)=>{s.fields[t]||(s.fields[t]=e)}),s}return Cr.tables[this.getName()]||{fields:{},uniqueKeys:[]}}static parse(t,e,r={},s=Wr){var n=H.lex(t,[" (as )?"],{useRegex:"i"});if(n.tokens.length<3){var i=e(n.tokens[0]);if(i instanceof w)r.withUac?i=e("("+Dr.select(null,i.toString())+")",null,{withUac:!1}):i.isTableName=!0;else if(!(i instanceof J&&(i.expr instanceof Ar||i.expr instanceof Ur)))throw new Error("Table expression must be either a plain reference or a (derived) query!");return new s(i,(n.tokens[1]||"").trim(),(n.matches[0]||"").trim())}}};var Br=Wr;var Hr=class{getToString(t,e){var r=[];return Fe(this.exprs,(s,n)=>{if(n){var i=null,a=this.clauses[s];"joins"===s?i=n.map((e,r)=>a[r]+" "+e.toString(t)).join(" "):"table"===s?i=a+" "+(Ce(n)?n.map(e=>e.toString(t)).join(", "):n.toString(t)):e&&(i=e(s,n,a))||(i=a+" "+n.toString(t)),r.push(i)}}),r.join(" ")}static getParse(t,e,r,s,n){var i=H.lex(t,Object.values(r),{useRegex:"i"});if(i.matches.length){var a={},o={},l=[];i.matches.forEach((t,h)=>{var c=Je(r,e=>t.match(new RegExp(e,"i")),!0),u=i.tokens[h+1].trim(),p=null;if("joins"===c){((p=s(u,null,{withUac:e})).type=t.match(new RegExp("(INNER|CROSS|LEFT|RIGHT)","i")))&&(p.type=p.type[0].toLowerCase()),a[c]?(a[c].push(p),o[c].push(t)):(a[c]=[p],o[c]=[t])}else{if("table"===c){var f=H.split(u,[","]).map(t=>s(t.trim(),[Br],{withUac:e}));p=1===f.length?f[0]:f}else if(!n||!(p=n(c,u)))p=s(u,null,{withUac:e});(function(t,e){if(!t)return!1;if(t instanceof e)return!0;var r=t=>{for(;t&&t!==Function.prototype;){if(t===e||t.prototypes&&t.prototypes.reduce((t,s)=>t||s===e||r(s),!1))return!0;t=Object.getPrototypeOf(t)}return!1};return r(t.constructor)})(p,J)||_e(p,!1).forEach(t=>{l=l.concat(t.meta.vars.filter(t=>!t.isTableName))}),"where"!==c||a.joins||(a.joins=[],o.joins=[]),a[c]=p,o[c]=t}});var h=l.filter(t=>t.isArrowReference);if(h.length){var c={},u=(Ce(a.table)?a.table:[a.table]).concat(a.joins||[]);h.forEach(t=>{var e=(t.context?u.filter(e=>e.getAlias()===t.context.name+""):u)[0],r=Rr.eval(e.getSchema(),t.name.replace(/`/g,"")),s=[e.getAlias(),r.a.actingKey,r.b.actingKey,r.b.table.name].join("_");c[s]||(c[s]={a:r.a,b:r.b,select:[],baseTable:e}),t.arrowContext=s,c[s].select.push(r.b.actingKey,r.b.select+" AS `"+t.name.replace(/`/g,"")+"`")}),a.joins||(a.joins=[],o.joins=[]),Fe(c,(t,r)=>{var n=r.b.table.name,i="(SELECT "+(e?"WITH UAC ":"")+n+"."+$e(r.select).join(", "+n+".")+" FROM "+r.b.table.name+" AS "+n+") AS "+t+" ON "+t+"."+r.b.actingKey+" = "+r.baseTable.getAlias()+"."+r.a.actingKey;(i=s(i)).type="left",a.joins.push(i),o.joins.push("LEFT JOIN")})}return{exprs:a,clauses:o}}}};const Fr=class extends ye{};Object.defineProperty(Fr.prototype,"jsenType",{get:()=>"DeleteStatement"});var $r=Fr;class Mr extends Array{constructor(...t){super(...t),this._onfinish=[],this.cursor=0}onfinish(t){this._onfinish.push(t)}advance(){this.cursor!==this.length-1?this.cursor++:this._onfinish.forEach(t=>t())}fetch(){if(this.cursor<this.length)return this[this.cursor]}}class Gr{constructor(t){Object.defineProperty(this,".trap",{value:t})}CONCAT(...t){return t.join("")}CONCAT_WS(...t){return t.join(t.shift())}COALESCE(...t){return t.reduce((t,e)=>je(t)?e:t,null)}FIND_IN_SET(t,e){return e.indexOf(t)}ISNULL(t){return je(t)}COUNT(t,e){if("*"===e.toString())return t.length;if(3===arguments.length&&"DISTINCT"===e.toString().toUpperCase())var r=$e(this.COLUMN(t,arguments[2]));else r=this.COLUMN(t,e);return r.filter(t=>!je(t)).length}GROUP_CONCAT(t,e){return this.COLUMN(t,e).join("")}GROUP_CONCAT_WS(t,e,r){return this.COLUMN(t,r).join(e.eval(this,this[".trap"]))}AVG(t,e){return(r=this.COLUMN(t,e)).length?Oe(r)/r.length:0;var r}MAX(t,e){return(r=(r=this.COLUMN(t,e)).slice()).reduce((t,e)=>Math.max(t,e),r.shift());var r}MIN(t,e){return(r=(r=this.COLUMN(t,e)).slice()).reduce((t,e)=>Math.min(t,e),r.shift());var r}SUM(t,e){return Oe(this.COLUMN(t,e))}ANY_VALUE(t,e){return He(this.COLUMN(t,e))}GROUPING(t,...e){return this.AGGR&&this.AGGR.isRollup?e.reduce((t,e,r)=>this.AGGR.by.filter(t=>{var r=t.toString(),s=e.toString();return-1===s.indexOf(".")&&r.indexOf(".")>-1&&(r=Ze(r,".")),s===r}).length?r+1:t,0):0}COLUMN(t,e){return t.map(t=>e.eval(t,this[".trap"]))}COLUMNS(t,e){return e.map(e=>this.COLUMN(t,e))}JSON_EXTRACT(t,e){return Ve(JSON.parse(t),e.split(".").slice(1))}JSON_OBJECT(t,e){return Xe(t,e)}JSON_MERGE(t,e){return Qe(JSON.parse(t),JSON.parse(e))}}class Yr{constructor(t,e,r,...s){this.trap=t,this.table=e,this.where=r,this.joins=s,this.cursor=new Mr(...e.rows.filter(t=>t)),this.cursor.onfinish(()=>{this.eof=!0,this._onfinish.forEach(t=>t())}),this._onfinish=[]}onfinish(t){this._onfinish.push(t)}createJoinCursors(t,e,r){for(var s=this.joins.map(t=>{var e=new Mr;return e.source=t,e}),n=0;n<this.joins.length;n++){var i=this.joins[n],a=s.filter(t=>t.source.alias===i.alias)[0];if(i.rows.forEach(r=>{if(r)if(i.join&&"full"!==i.join.type)try{if("using"===i.join.conditionClause.trim().toLowerCase())var s=i.join.condition.toString(),n=r[s]===e[s];else{var o=new Gr(this.trap);o[t]=e,o[i.alias]=r;n=i.join.condition.eval(o,this.trap)}n&&a.push(r)}catch(t){throw new Error('["'+i.join.condition.toString()+'" in JOIN clause]: '+t.message)}else a.push(r)}),!a.length)switch(i.join.type){case"left":a.push({});break;case"right":e={};break;case"inner":return}}return s.map((t,e)=>{var n=s[e+1];return n?t.onfinish(n.advance.bind(n)):t.onfinish(r),t})}fetch(){if(!this.eof){var t=new Gr(this.trap);if(t[this.table.alias]=this.cursor.fetch(),this.joins.length){if(!this.joinCursors){var e=this.table.alias,r=this.cursor.fetch();if(this.cursor.advance(),this.joinCursors=this.createJoinCursors(e,r,()=>{this.joinCursors=null}),!this.joinCursors)return this.fetch()}this.joinCursors.forEach(e=>{t[e.source.alias]=e.fetch()}),this.joinCursors[0].advance()}else this.cursor.advance();try{if(this.where&&!this.where.eval(t,this.trap))return this.fetch()}catch(t){throw new Error('["'+this.where.toString()+'" in WHERE clause]: '+t.message)}return t}}}const Qr=class extends(Ye(Hr,$r)){constructor(t,e,r){super(),this.exprs=t,this.clauses=e,this.withUac=r}eval(t,e={}){var r=(Ce(this.exprs.table)?this.exprs.table:[this.exprs.table]).concat(this.exprs.joins||[]);r=r.map(r=>r.eval(t,e)),this.base=new Yr(e,r.shift(),this.exprs.where,...r);for(var s,n=0;s=this.base.fetch();)Object.keys(s).forEach(t=>{var e;(e=t===this.base.table.alias?this.base.table:this.base.joins.filter(e=>e.alias===t)[0]).rows.forEach((r,i)=>{r===s[t]&&(delete e.rows[i],n++)})});return n}toString(t=null){return this.getToString(t)}static parse(t,e,r={},s=Qr){if(t.trim().match(/^DELETE[ ]+FROM/,"i")){var n=!1;t.match(/DELETE[ ]+WITH[ ]+UAC/i)&&(n=!0,t=t.replace(/[ ]+WITH[ ]+UAC/i,""));var i=super.getParse(t,n,s.clauses,e);return new s(i.exprs,i.clauses,n)}}};Qr.clauses={table:"DELETE[ ]+FROM",where:"WHERE",joins:"(INNER[ ]+|CROSS[ ]+|(LEFT|RIGHT)([ ]+OUTER)?[ ]+)?JOIN"};var qr=Qr;const Kr=class extends ye{};Object.defineProperty(Kr.prototype,"jsenType",{get:()=>"FieldExpression"});var Jr=Kr;const Xr=class extends Jr{constructor(t,e,r=!1){super(),this.expr=t,this.alias=e,this.claused=r}as(t){return this.alias=t,this.claused=!0,this}getName(){return(this.expr.name||"").replace(/`/g,"")}getAlias(){return(this.alias||"").replace(/`/g,"")||this.getName()}eval(t,e,r={}){if(this.expr instanceof J)var s=this.expr.eval(e,r);else s=this.expr.eval(t,r);return Xe(this.getAlias(),s)}toString(t=null){return[this.expr.toString(t),this.claused?"AS":"",this.alias].filter(t=>t).join(" ")}static parse(t,e,r={},s=Xr){var n=H.split(t,[" (as )?"],{useRegex:"i",preserveDelims:!0}),i=null,a=n.pop().trim(),o="as "===a.substr(0,3).toLowerCase();if(o)a=a.substr(3).trim(),i=e(n.join("").trim());else if(n.length&&(!a.match(/[^0-9a-zA-Z_]/)||sr(a,"`","`")))try{i=e(n.join("").trim())}catch(t){}return i||(a=null,i=e(t)),i.isFieldName=!0,new s(i,a,o)}};var Vr=Xr;const zr=class extends ye{};Object.defineProperty(zr.prototype,"jsenType",{get:()=>"GroupByExpression"});var Zr=zr;const ts=class extends Zr{constructor(t,e=null,r=!1){super(),this.columns=t,this.having=e,this.withRollup=r}eval(t,e={}){var r=(t,s,n)=>{if(s.length){var i={};t.forEach(t=>{try{var r=s[0].eval(t,e)}catch(t){throw new Error('["'+this.toString()+'" in group by clause]: '+t.message)}i[r]=i[r]||[],i[r].push(t)}),Object.values(i).map(t=>r(t,s.slice(1),n))}if(!s.length||this.withRollup){var a=new Gr(e);return ze(a,t[0]),a.$=qe(a.$),a.AGGR={rows:t,by:s},a.AGGR.isRollup=s.length&&this.withRollup,a.AGGR.isRollup&&s.forEach(t=>{(t=t.toString().indexOf(".")>-1?Ze(t.toString(),"."):t.toString())in a.$&&(a.$[t]=null)}),n.push(a),a}},s=[];return r(t,this.columns.slice(),s),s}toString(t=null){var e=[this.columns.map(e=>e.toString(t)).join(", ")];return this.withRollup&&e.push("WITH ROLLUP"),this.having&&e.push("HAVING "+this.having.toString(t)),e.join(" ")}static parse(t,e,r={},s=ts){var n=H.lex(t,["WITH[ ]+ROLLUP","HAVING"],{useRegex:"i"}),i=H.split(n.tokens.shift().trim(),[","]).map(t=>e(t.trim())),a=null,o=!1;return n.matches.forEach(t=>{t.toLowerCase().startsWith("with")?(o=!0,n.tokens.shift()):t.toLowerCase().startsWith("having")&&(a=e(n.tokens.shift().trim()))}),new s(i,a,o)}};var es=ts;const rs=class extends ye{};Object.defineProperty(rs.prototype,"jsenType",{get:()=>"InsertStatement"});var ss=rs;var ns=class{constructor(t){this.input=t}eval(){return this.input}toString(t=null){return"?"}};const is=class extends ss{constructor(t,e,r,s,n,i){super(),this.table=t,this.columns=e,this.values=r,this.withUac=s,this.insertType=n,this.onDuplicateKeyUpdate=i}eval(t,e={}){var r=this.table.eval(t,e),s=this.table.getSchema(),n=this.values,i=this.insertType.toUpperCase();if("SET"===i){var a=n.map(t=>t.reference.name);n=[n.map(t=>t.val)]}else{if("SELECT"===i)try{n=n.eval(t,e).map(t=>Object.values(t))}catch(t){throw new Error('["'+n.toString()+'" in SELECT clause]: '+t.message)}a=this.columns||(s.fields?Object.keys(s.fields):[])}a=a.map(t=>t+"");for(var o=function(t,e,r=null){return Ce(e)?t.filter(t=>r?e.filter(e=>r(t,e)).length:-1!==e.indexOf(t)):[]}(s.uniqueKeys,a),l=0,h=null;h=n.shift();){var c=0;if(o.length){for(var u,p=o.map(t=>{var e=a.indexOf(t),r="SELECT"===i?new ns(h[e]):h[e],s=new ar(null,t);return s.parseCallback=this.parseCallback,new ur(s,r,"=")}),f=new nr(p,nr.operators.or),g=new Yr(e,this.table.eval(t,e),f);u=g.fetch();){if(!this.onDuplicateKeyUpdate)throw new Error("Inserting duplicate values on unique keys: "+o.join(", "));this.onDuplicateKeyUpdate.forEach(t=>t.eval(u,e)),c++}l+=c}c||("SELECT"!==i&&(h=h.map(r=>r.eval(t,e))),r.insert(h,a),l++)}return l}toString(t=null){var e=[this.table.toString(t)];return"SET"===this.insertType.toUpperCase()?e.push("SET "+this.values.map(e=>e.toString(t)).join(", ")):(this.columns&&e.push("("+this.columns.join(", ")+")"),"SELECT"===this.insertType.toUpperCase()?e.push(this.values.toString(t)):e.push("VALUES ("+this.values.map(e=>e.map(e=>e.toString(t)).join(", ")).join("), (")+")")),this.onDuplicateKeyUpdate&&e.push("ON DUPLICATE KEY UPDATE "+this.onDuplicateKeyUpdate.map(e=>e.toString(t)).join(", ")),"INSERT INTO "+e.join(" ")}static parse(t,e,r={},s=is){if(t.trim().match(/^INSERT([ ]+WITH[ ]+UAC)?([ ]+INTO)?/,"i")){var n=!1;t.match(/INSERT[ ]+WITH[ ]+UAC/i)&&(n=!0,t=t.replace(/[ ]+WITH[ ]+UAC/i,""));var i=H.lex(t,Object.values(is.clauses),{useRegex:"i"});i.tokens.shift();var a=i.tokens.shift().trim(),o=[],l=i.tokens.shift(),h=i.matches[1].toUpperCase();if("SET"===h)a=e(a,[Br]),l=H.split(l.trim(),[","]).map(t=>e(t.trim(),[lr]));else{var c=H.split(a,[" "]);a=e(c.shift().trim(),[Br]),c.length&&(o=c[0].trim(),o=H.split(sr(o,"(",")")?rr(o,"(",")"):o,[","]).map(t=>t.trim())),l="SELECT"===h?e("SELECT "+l.trim()):H.split(l.trim(),[","]).map(t=>H.split(rr(t.trim(),"(",")"),[","]).map(t=>e(t.trim())))}var u=i.tokens.shift();u&&(u=H.split(u.trim(),[","]).map(t=>e(t.trim(),[lr])));var p=new s(a,o,l,n,h,u);return p.parseCallback=e,p}}};is.clauses={table:"INSERT([ ]+INTO)?",values:"(VALUES|VALUE|SET|SELECT)",update:"ON[ ]+DUPLICATE[ ]+KEY[ ]+UPDATE"};var as=is;const os=class extends ye{};Object.defineProperty(os.prototype,"jsenType",{get:()=>"JoinConstruct"});var ls=os;const hs=class extends ls{constructor(t,e,r){super(),this.table=t,this.condition=e,this.conditionClause=r}eval(t,e={}){var r=this.table.eval(t,e);return r.join={type:this.type,condition:this.condition,conditionClause:this.conditionClause},r}getName(){return this.table.getName()}getAlias(){return this.table.getAlias()}toString(t=null){return[this.table.toString(t),this.conditionClause,this.condition.toString(t)].join("")}static parse(t,e,r={},s=hs){var n=H.lex(t,hs.clauses);if(2===n.tokens.length)return new s(e(n.tokens[0],[Br]),e(n.tokens[1]),n.matches[0])}};hs.clauses=[" on "," using "," ON "," USING "];var cs=hs;const us=class extends(Ye(Hr,Ar)){constructor(t,e,r=!1,s=[],n=[]){super(),this.exprs=t,this.clauses=e,this.withUac=r,this.flags=s}getFields(){return this.exprs.fields}getTable(){return this.exprs.table}getWhere(){return this.exprs.where}getJoins(){return this.exprs.joins}getGroupBy(){return this.exprs.groupBy}getWindows(){return this.exprs.windows}getOrderBy(){return this.exprs.orderBy}getOffset(){return this.exprs.offset}getLimit(){return this.exprs.limit}eval(t,e={}){var r={aggr:[],win:[]};this.meta.vars.forEach(t=>{t instanceof vr&&Te(t.window?r.win:r.aggr,t)});var s=(r,s,n=null)=>(n&&(n={aggr:[],win:[]}),r.forEach(r=>{r.$||(r.$={}),s.forEach(s=>{if(n){var i=s.expr.meta.vars.slice().concat([s.expr]).filter(t=>t instanceof vr);if(i.length)return Te(i.filter(t=>t.window).length?n.win:n.aggr,s),void(s.getAlias()in r.$||(r.$[s.getAlias()]=void 0))}try{Qe(1,r.$,s.eval(r,t,e))}catch(t){throw new Error('["'+s.toString()+'" in field list]: '+t.message)}})}),n),n=(Ce(this.exprs.table)?this.exprs.table:[this.exprs.table]).concat(this.exprs.joins||[]),i=n.map(r=>r.eval(t,e)),a=i.shift();this.base=new Yr(e,a,this.exprs.where,...i);for(var o,l=[];o=this.base.fetch();)l.push(o);var h,c,u=[];this.exprs.fields.forEach(t=>{"*"===t.getName()?n.forEach(t=>{if(t instanceof ls&&(t=t.table),!(c=t.getSchema()))throw new Error("Can't resolve *; schema not found for table \""+t.getName()+'".');if(!(h=Object.keys(c.fields)).length)throw new Error("Can't resolve *; fields not defined for table \""+t.getName()+'".');h.forEach(t=>{u.push(Ss.parse(t,[Vr]))})}):u.push(t)});var p=s(l,u,!0);if(this.exprs.groupBy||r.aggr.length){var f=this.exprs.groupBy||new es([]);s(l=f.eval(l,e),p.aggr)}if(this.exprs.windows||r.win.length){var g=[];r.win.forEach(t=>{var r=t.window.toString();-1===g.indexOf(r)&&(t.window.eval(l,this.exprs.windows,e),g.push(r))}),s(l,p.win)}if(this.exprs.orderBy&&(l=this.exprs.orderBy.eval(l,e)),this.flags.includes("DISTINCT")&&(l=l.filter((t,e)=>e===Je(l,e=>_even(e,t)))),this.exprs.offset||this.exprs.limit){var v=this.exprs.limit?this.exprs.limit.slice():[],m=this.exprs.offset||(2===v.length?v.shift():0);l=v.length?l.slice(m,m+v[0]):l.slice(m)}return l.map(t=>t.$)}toString(t=null){return this.getToString(t,(e,r,s)=>"fields"===e?s+" "+(this.flags.length?" "+this.flags.join(" "):"")+r.map(e=>e.toString(t)).join(", "):"windows"===e?s+" "+Object.keys(r).map(e=>e+" AS "+r[e].toString(t)).join(", "):"groupBy"===e||"orderBy"===e?s+" "+r.toString(t):"limit"===e?s+" "+r.join(", "):void 0)}static parse(t,e,r={},s=us){if("select"===t.trim().substr(0,6).toLowerCase()){var n=!1;t.match(/SELECT[ ]+WITH[ ]+UAC/i)&&(n=!0,t=t.replace(/[ ]+WITH[ ]+UAC/i,""));var i=super.getParse(t,n,s.clauses,e,(t,r)=>{if("fields"===t)return H.split(r,[","]).map(t=>e(t.trim(),[Vr]));if("windows"===t){var s={};return H.split(r,[","]).forEach(t=>{var r=t.split(new RegExp(" as ","i"));s[r[0].trim()]=e(r[1].trim(),[wr])}),s}return"groupBy"===t?e(r,[es]):"orderBy"===t?e(r,[Or]):"limit"===t?r.split(",").map(t=>parseInt(t)):void 0});return new s(i.exprs,i.clauses,n,i.clauses.fields.replace(/SELECT/i,"").split(" ").filter(t=>t),i.references)}}};us.clauses={fields:"SELECT([ ]+(ALL|DISTINCT))?",table:"FROM",where:"WHERE",joins:"(INNER[ ]+|CROSS[ ]+|(LEFT|RIGHT)([ ]+OUTER)?[ ]+)?JOIN",groupBy:"GROUP[ ]+BY",windows:"WINDOW",orderBy:"ORDER[ ]+BY",offset:"OFFSET",limit:"LIMIT"};var ps=us;const fs=class extends Ur{constructor(t,e,r=null,s=null){super(),this.query=t,this.queries=e,this.orderBy=r,this.limit=s}toString(t=null){var e=[[this.query.toString(t)].concat(this.queries.map(e=>(e.onDuplicate?e.onDuplicate.toUpperCase()+" ":"")+e.select.toString(t))).join(" UNION ")];return this.orderBy&&e.push("ORDER BY "+this.orderBy.toString(t)),this.limit&&e.push("LIMIT "+this.limit.join(", ")),e.join(" ")}static parse(t,e,r={},s=fs){var n,i={useRegex:"i"};if((n=H.lex(t,[" UNION([ ]+(ALL|DISTINCT))? "],i))&&n.matches.length){var a=n.tokens,o=n.matches,l=null,h=null;if(a[0].trim().startsWith("(")){var c=H.lex(a.pop(),["ORDER[ ]+BY","LIMIT"],i);a.push(c.tokens.shift()),c.matches.forEach(t=>{var r=c.tokens.shift().trim();t.toUpperCase().startsWith("ORDER")?l=e(r,[Or]):t.toUpperCase().startsWith("LIMIT")&&(h=r.split(",").map(t=>parseInt(t)))})}return new s(e(a.shift().trim()),a.map((t,r)=>({select:e(t.trim()),onDuplicate:(o[r].match(new RegExp("ALL|DISTINCT","i"))||[])[0]})),l,h)}}};var gs=fs;const vs=class extends ye{};Object.defineProperty(vs.prototype,"jsenType",{get:()=>"UpdateStatement"});var ms=vs;const ds=class extends(Ye(Hr,ms)){constructor(t,e,r){super(),this.exprs=t,this.clauses=e,this.withUac=r}eval(t,e={}){var r=(Ce(this.exprs.table)?this.exprs.table:[this.exprs.table]).concat(this.exprs.joins||[]);r=r.map(r=>r.eval(t,e)),this.base=new Yr(e,r.shift(),this.exprs.where,...r);for(var s,n=0;s=this.base.fetch();)this.exprs.assignments.forEach(t=>t.eval(s,e)),n++;return n}toString(t=null){return this.getToString(t,(e,r,s)=>{if("assignments"===e)return s+" "+r.map(e=>e.toString(t)).join(", ")})}static parse(t,e,r={},s=ds){if("update"===t.trim().substr(0,6).toLowerCase()){var n=!1;t.match(/UPDATE[ ]+WITH[ ]+UAC/i)&&(n=!0,t=t.replace(/[ ]+WITH[ ]+UAC/i,""));var i=super.getParse(t,n,s.clauses,e,(t,r)=>{if("assignments"===t)return H.split(r,[","]).map(t=>e(t.trim(),[lr]))});return new s(i.exprs,i.clauses,n)}}};ds.clauses={table:"UPDATE",assignments:"SET",where:"WHERE",joins:"(INNER[ ]+|CROSS[ ]+|(LEFT|RIGHT)([ ]+OUTER)?[ ]+)?JOIN"};var Es=ds;Se.grammars={Union:gs,Select:ps,Insert:as,Update:Es,Delete:qr,Join:cs,Abstraction:V,Condition:fr,Assertion:nr,Comparison:ur,Math:Qt,Num:Xt,Str:pe,Bool:wt,Void:me,Aggr:Tr,Call:cr,Reference:ar};var Ss=Se;window.WebNative||(window.WebNative={}),window.WebNative.Mql=Ss}]);
//# sourceMappingURL=main.js.map